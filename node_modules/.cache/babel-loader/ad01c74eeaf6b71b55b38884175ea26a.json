{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nimport './goToDefinitionAtPosition.css';\nimport * as nls from '../../../../nls.js';\nimport { createCancelablePromise } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { MarkdownString } from '../../../../base/common/htmlContent.js';\nimport { IModeService } from '../../../common/services/modeService.js';\nimport { Range } from '../../../common/core/range.js';\nimport { DefinitionProviderRegistry } from '../../../common/modes.js';\nimport { registerEditorContribution } from '../../../browser/editorExtensions.js';\nimport { getDefinitionsAtPosition } from '../goToSymbol.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { ITextModelService } from '../../../common/services/resolverService.js';\nimport { registerThemingParticipant } from '../../../../platform/theme/common/themeService.js';\nimport { editorActiveLinkForeground } from '../../../../platform/theme/common/colorRegistry.js';\nimport { EditorState } from '../../../browser/core/editorState.js';\nimport { DefinitionAction } from '../goToCommands.js';\nimport { ClickLinkGesture } from './clickLinkGesture.js';\nimport { Position } from '../../../common/core/position.js';\nimport { withNullAsUndefined } from '../../../../base/common/types.js';\n\nvar GotoDefinitionAtPositionEditorContribution =\n/** @class */\nfunction () {\n  function GotoDefinitionAtPositionEditorContribution(editor, textModelResolverService, modeService) {\n    var _this = this;\n\n    this.textModelResolverService = textModelResolverService;\n    this.modeService = modeService;\n    this.toUnhook = new DisposableStore();\n    this.toUnhookForKeyboard = new DisposableStore();\n    this.linkDecorations = [];\n    this.currentWordAtPosition = null;\n    this.previousPromise = null;\n    this.editor = editor;\n    var linkGesture = new ClickLinkGesture(editor);\n    this.toUnhook.add(linkGesture);\n    this.toUnhook.add(linkGesture.onMouseMoveOrRelevantKeyDown(function (_a) {\n      var mouseEvent = _a[0],\n          keyboardEvent = _a[1];\n\n      _this.startFindDefinitionFromMouse(mouseEvent, withNullAsUndefined(keyboardEvent));\n    }));\n    this.toUnhook.add(linkGesture.onExecute(function (mouseEvent) {\n      if (_this.isEnabled(mouseEvent)) {\n        _this.gotoDefinition(mouseEvent.target.position, mouseEvent.hasSideBySideModifier).then(function () {\n          _this.removeLinkDecorations();\n        }, function (error) {\n          _this.removeLinkDecorations();\n\n          onUnexpectedError(error);\n        });\n      }\n    }));\n    this.toUnhook.add(linkGesture.onCancel(function () {\n      _this.removeLinkDecorations();\n\n      _this.currentWordAtPosition = null;\n    }));\n  }\n\n  GotoDefinitionAtPositionEditorContribution.get = function (editor) {\n    return editor.getContribution(GotoDefinitionAtPositionEditorContribution.ID);\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.startFindDefinitionFromCursor = function (position) {\n    // For issue: https://github.com/microsoft/vscode/issues/46257\n    // equivalent to mouse move with meta/ctrl key\n    var _this = this; // First find the definition and add decorations\n    // to the editor to be shown with the content hover widget\n\n\n    return this.startFindDefinition(position).then(function () {\n      // Add listeners for editor cursor move and key down events\n      // Dismiss the \"extended\" editor decorations when the user hides\n      // the hover widget. There is no event for the widget itself so these\n      // serve as a best effort. After removing the link decorations, the hover\n      // widget is clean and will only show declarations per next request.\n      _this.toUnhookForKeyboard.add(_this.editor.onDidChangeCursorPosition(function () {\n        _this.currentWordAtPosition = null;\n\n        _this.removeLinkDecorations();\n\n        _this.toUnhookForKeyboard.clear();\n      }));\n\n      _this.toUnhookForKeyboard.add(_this.editor.onKeyDown(function (e) {\n        if (e) {\n          _this.currentWordAtPosition = null;\n\n          _this.removeLinkDecorations();\n\n          _this.toUnhookForKeyboard.clear();\n        }\n      }));\n    });\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.startFindDefinitionFromMouse = function (mouseEvent, withKey) {\n    // check if we are active and on a content widget\n    if (mouseEvent.target.type === 9\n    /* CONTENT_WIDGET */\n    && this.linkDecorations.length > 0) {\n      return;\n    }\n\n    if (!this.editor.hasModel() || !this.isEnabled(mouseEvent, withKey)) {\n      this.currentWordAtPosition = null;\n      this.removeLinkDecorations();\n      return;\n    }\n\n    var position = mouseEvent.target.position;\n    this.startFindDefinition(position);\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.startFindDefinition = function (position) {\n    var _this = this;\n\n    var _a; // Dispose listeners for updating decorations when using keyboard to show definition hover\n\n\n    this.toUnhookForKeyboard.clear(); // Find word at mouse position\n\n    var word = position ? (_a = this.editor.getModel()) === null || _a === void 0 ? void 0 : _a.getWordAtPosition(position) : null;\n\n    if (!word) {\n      this.currentWordAtPosition = null;\n      this.removeLinkDecorations();\n      return Promise.resolve(0);\n    } // Return early if word at position is still the same\n\n\n    if (this.currentWordAtPosition && this.currentWordAtPosition.startColumn === word.startColumn && this.currentWordAtPosition.endColumn === word.endColumn && this.currentWordAtPosition.word === word.word) {\n      return Promise.resolve(0);\n    }\n\n    this.currentWordAtPosition = word; // Find definition and decorate word if found\n\n    var state = new EditorState(this.editor, 4\n    /* Position */\n    | 1\n    /* Value */\n    | 2\n    /* Selection */\n    | 8\n    /* Scroll */\n    );\n\n    if (this.previousPromise) {\n      this.previousPromise.cancel();\n      this.previousPromise = null;\n    }\n\n    this.previousPromise = createCancelablePromise(function (token) {\n      return _this.findDefinition(position, token);\n    });\n    return this.previousPromise.then(function (results) {\n      if (!results || !results.length || !state.validate(_this.editor)) {\n        _this.removeLinkDecorations();\n\n        return;\n      } // Multiple results\n\n\n      if (results.length > 1) {\n        _this.addDecoration(new Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn), new MarkdownString().appendText(nls.localize('multipleResults', \"Click to show {0} definitions.\", results.length)));\n      } // Single result\n      else {\n          var result_1 = results[0];\n\n          if (!result_1.uri) {\n            return;\n          }\n\n          _this.textModelResolverService.createModelReference(result_1.uri).then(function (ref) {\n            if (!ref.object || !ref.object.textEditorModel) {\n              ref.dispose();\n              return;\n            }\n\n            var textEditorModel = ref.object.textEditorModel;\n            var startLineNumber = result_1.range.startLineNumber;\n\n            if (startLineNumber < 1 || startLineNumber > textEditorModel.getLineCount()) {\n              // invalid range\n              ref.dispose();\n              return;\n            }\n\n            var previewValue = _this.getPreviewValue(textEditorModel, startLineNumber, result_1);\n\n            var wordRange;\n\n            if (result_1.originSelectionRange) {\n              wordRange = Range.lift(result_1.originSelectionRange);\n            } else {\n              wordRange = new Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn);\n            }\n\n            var modeId = _this.modeService.getModeIdByFilepathOrFirstLine(textEditorModel.uri);\n\n            _this.addDecoration(wordRange, new MarkdownString().appendCodeblock(modeId ? modeId : '', previewValue));\n\n            ref.dispose();\n          });\n        }\n    }).then(undefined, onUnexpectedError);\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.getPreviewValue = function (textEditorModel, startLineNumber, result) {\n    var rangeToUse = result.targetSelectionRange ? result.range : this.getPreviewRangeBasedOnBrackets(textEditorModel, startLineNumber);\n    var numberOfLinesInRange = rangeToUse.endLineNumber - rangeToUse.startLineNumber;\n\n    if (numberOfLinesInRange >= GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES) {\n      rangeToUse = this.getPreviewRangeBasedOnIndentation(textEditorModel, startLineNumber);\n    }\n\n    var previewValue = this.stripIndentationFromPreviewRange(textEditorModel, startLineNumber, rangeToUse);\n    return previewValue;\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.stripIndentationFromPreviewRange = function (textEditorModel, startLineNumber, previewRange) {\n    var startIndent = textEditorModel.getLineFirstNonWhitespaceColumn(startLineNumber);\n    var minIndent = startIndent;\n\n    for (var endLineNumber = startLineNumber + 1; endLineNumber < previewRange.endLineNumber; endLineNumber++) {\n      var endIndent = textEditorModel.getLineFirstNonWhitespaceColumn(endLineNumber);\n      minIndent = Math.min(minIndent, endIndent);\n    }\n\n    var previewValue = textEditorModel.getValueInRange(previewRange).replace(new RegExp(\"^\\\\s{\" + (minIndent - 1) + \"}\", 'gm'), '').trim();\n    return previewValue;\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.getPreviewRangeBasedOnIndentation = function (textEditorModel, startLineNumber) {\n    var startIndent = textEditorModel.getLineFirstNonWhitespaceColumn(startLineNumber);\n    var maxLineNumber = Math.min(textEditorModel.getLineCount(), startLineNumber + GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES);\n    var endLineNumber = startLineNumber + 1;\n\n    for (; endLineNumber < maxLineNumber; endLineNumber++) {\n      var endIndent = textEditorModel.getLineFirstNonWhitespaceColumn(endLineNumber);\n\n      if (startIndent === endIndent) {\n        break;\n      }\n    }\n\n    return new Range(startLineNumber, 1, endLineNumber + 1, 1);\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.getPreviewRangeBasedOnBrackets = function (textEditorModel, startLineNumber) {\n    var maxLineNumber = Math.min(textEditorModel.getLineCount(), startLineNumber + GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES);\n    var brackets = [];\n    var ignoreFirstEmpty = true;\n    var currentBracket = textEditorModel.findNextBracket(new Position(startLineNumber, 1));\n\n    while (currentBracket !== null) {\n      if (brackets.length === 0) {\n        brackets.push(currentBracket);\n      } else {\n        var lastBracket = brackets[brackets.length - 1];\n\n        if (lastBracket.open[0] === currentBracket.open[0] && lastBracket.isOpen && !currentBracket.isOpen) {\n          brackets.pop();\n        } else {\n          brackets.push(currentBracket);\n        }\n\n        if (brackets.length === 0) {\n          if (ignoreFirstEmpty) {\n            ignoreFirstEmpty = false;\n          } else {\n            return new Range(startLineNumber, 1, currentBracket.range.endLineNumber + 1, 1);\n          }\n        }\n      }\n\n      var maxColumn = textEditorModel.getLineMaxColumn(startLineNumber);\n      var nextLineNumber = currentBracket.range.endLineNumber;\n      var nextColumn = currentBracket.range.endColumn;\n\n      if (maxColumn === currentBracket.range.endColumn) {\n        nextLineNumber++;\n        nextColumn = 1;\n      }\n\n      if (nextLineNumber > maxLineNumber) {\n        return new Range(startLineNumber, 1, maxLineNumber + 1, 1);\n      }\n\n      currentBracket = textEditorModel.findNextBracket(new Position(nextLineNumber, nextColumn));\n    }\n\n    return new Range(startLineNumber, 1, maxLineNumber + 1, 1);\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.addDecoration = function (range, hoverMessage) {\n    var newDecorations = {\n      range: range,\n      options: {\n        inlineClassName: 'goto-definition-link',\n        hoverMessage: hoverMessage\n      }\n    };\n    this.linkDecorations = this.editor.deltaDecorations(this.linkDecorations, [newDecorations]);\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.removeLinkDecorations = function () {\n    if (this.linkDecorations.length > 0) {\n      this.linkDecorations = this.editor.deltaDecorations(this.linkDecorations, []);\n    }\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.isEnabled = function (mouseEvent, withKey) {\n    return this.editor.hasModel() && mouseEvent.isNoneOrSingleMouseDown && mouseEvent.target.type === 6\n    /* CONTENT_TEXT */\n    && (mouseEvent.hasTriggerModifier || (withKey ? withKey.keyCodeIsTriggerKey : false)) && DefinitionProviderRegistry.has(this.editor.getModel());\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.findDefinition = function (position, token) {\n    var model = this.editor.getModel();\n\n    if (!model) {\n      return Promise.resolve(null);\n    }\n\n    return getDefinitionsAtPosition(model, position, token);\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.gotoDefinition = function (position, openToSide) {\n    var _this = this;\n\n    this.editor.setPosition(position);\n    var action = new DefinitionAction({\n      openToSide: openToSide,\n      openInPeek: false,\n      muteMessage: true\n    }, {\n      alias: '',\n      label: '',\n      id: '',\n      precondition: undefined\n    });\n    return this.editor.invokeWithinContext(function (accessor) {\n      return action.run(accessor, _this.editor);\n    });\n  };\n\n  GotoDefinitionAtPositionEditorContribution.prototype.dispose = function () {\n    this.toUnhook.dispose();\n  };\n\n  GotoDefinitionAtPositionEditorContribution.ID = 'editor.contrib.gotodefinitionatposition';\n  GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES = 8;\n  GotoDefinitionAtPositionEditorContribution = __decorate([__param(1, ITextModelService), __param(2, IModeService)], GotoDefinitionAtPositionEditorContribution);\n  return GotoDefinitionAtPositionEditorContribution;\n}();\n\nexport { GotoDefinitionAtPositionEditorContribution };\nregisterEditorContribution(GotoDefinitionAtPositionEditorContribution.ID, GotoDefinitionAtPositionEditorContribution);\nregisterThemingParticipant(function (theme, collector) {\n  var activeLinkForeground = theme.getColor(editorActiveLinkForeground);\n\n  if (activeLinkForeground) {\n    collector.addRule(\".monaco-editor .goto-definition-link { color: \" + activeLinkForeground + \" !important; }\");\n  }\n});","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/editor/contrib/gotoSymbol/link/goToDefinitionAtPosition.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__param","paramIndex","decorator","nls","createCancelablePromise","onUnexpectedError","MarkdownString","IModeService","Range","DefinitionProviderRegistry","registerEditorContribution","getDefinitionsAtPosition","DisposableStore","ITextModelService","registerThemingParticipant","editorActiveLinkForeground","EditorState","DefinitionAction","ClickLinkGesture","Position","withNullAsUndefined","GotoDefinitionAtPositionEditorContribution","editor","textModelResolverService","modeService","_this","toUnhook","toUnhookForKeyboard","linkDecorations","currentWordAtPosition","previousPromise","linkGesture","add","onMouseMoveOrRelevantKeyDown","_a","mouseEvent","keyboardEvent","startFindDefinitionFromMouse","onExecute","isEnabled","gotoDefinition","position","hasSideBySideModifier","then","removeLinkDecorations","error","onCancel","get","getContribution","ID","prototype","startFindDefinitionFromCursor","startFindDefinition","onDidChangeCursorPosition","clear","onKeyDown","e","withKey","type","hasModel","word","getModel","getWordAtPosition","Promise","resolve","startColumn","endColumn","state","cancel","token","findDefinition","results","validate","addDecoration","lineNumber","appendText","localize","result_1","uri","createModelReference","ref","object","textEditorModel","dispose","startLineNumber","range","getLineCount","previewValue","getPreviewValue","wordRange","originSelectionRange","lift","modeId","getModeIdByFilepathOrFirstLine","appendCodeblock","undefined","result","rangeToUse","targetSelectionRange","getPreviewRangeBasedOnBrackets","numberOfLinesInRange","endLineNumber","MAX_SOURCE_PREVIEW_LINES","getPreviewRangeBasedOnIndentation","stripIndentationFromPreviewRange","previewRange","startIndent","getLineFirstNonWhitespaceColumn","minIndent","endIndent","Math","min","getValueInRange","replace","RegExp","trim","maxLineNumber","brackets","ignoreFirstEmpty","currentBracket","findNextBracket","push","lastBracket","open","isOpen","pop","maxColumn","getLineMaxColumn","nextLineNumber","nextColumn","hoverMessage","newDecorations","options","inlineClassName","deltaDecorations","isNoneOrSingleMouseDown","hasTriggerModifier","keyCodeIsTriggerKey","has","model","openToSide","setPosition","action","openInPeek","muteMessage","alias","label","id","precondition","invokeWithinContext","accessor","run","theme","collector","activeLinkForeground","getColor","addRule"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n};\r\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n};\r\nimport './goToDefinitionAtPosition.css';\r\nimport * as nls from '../../../../nls.js';\r\nimport { createCancelablePromise } from '../../../../base/common/async.js';\r\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\r\nimport { MarkdownString } from '../../../../base/common/htmlContent.js';\r\nimport { IModeService } from '../../../common/services/modeService.js';\r\nimport { Range } from '../../../common/core/range.js';\r\nimport { DefinitionProviderRegistry } from '../../../common/modes.js';\r\nimport { registerEditorContribution } from '../../../browser/editorExtensions.js';\r\nimport { getDefinitionsAtPosition } from '../goToSymbol.js';\r\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\r\nimport { ITextModelService } from '../../../common/services/resolverService.js';\r\nimport { registerThemingParticipant } from '../../../../platform/theme/common/themeService.js';\r\nimport { editorActiveLinkForeground } from '../../../../platform/theme/common/colorRegistry.js';\r\nimport { EditorState } from '../../../browser/core/editorState.js';\r\nimport { DefinitionAction } from '../goToCommands.js';\r\nimport { ClickLinkGesture } from './clickLinkGesture.js';\r\nimport { Position } from '../../../common/core/position.js';\r\nimport { withNullAsUndefined } from '../../../../base/common/types.js';\r\nvar GotoDefinitionAtPositionEditorContribution = /** @class */ (function () {\r\n    function GotoDefinitionAtPositionEditorContribution(editor, textModelResolverService, modeService) {\r\n        var _this = this;\r\n        this.textModelResolverService = textModelResolverService;\r\n        this.modeService = modeService;\r\n        this.toUnhook = new DisposableStore();\r\n        this.toUnhookForKeyboard = new DisposableStore();\r\n        this.linkDecorations = [];\r\n        this.currentWordAtPosition = null;\r\n        this.previousPromise = null;\r\n        this.editor = editor;\r\n        var linkGesture = new ClickLinkGesture(editor);\r\n        this.toUnhook.add(linkGesture);\r\n        this.toUnhook.add(linkGesture.onMouseMoveOrRelevantKeyDown(function (_a) {\r\n            var mouseEvent = _a[0], keyboardEvent = _a[1];\r\n            _this.startFindDefinitionFromMouse(mouseEvent, withNullAsUndefined(keyboardEvent));\r\n        }));\r\n        this.toUnhook.add(linkGesture.onExecute(function (mouseEvent) {\r\n            if (_this.isEnabled(mouseEvent)) {\r\n                _this.gotoDefinition(mouseEvent.target.position, mouseEvent.hasSideBySideModifier).then(function () {\r\n                    _this.removeLinkDecorations();\r\n                }, function (error) {\r\n                    _this.removeLinkDecorations();\r\n                    onUnexpectedError(error);\r\n                });\r\n            }\r\n        }));\r\n        this.toUnhook.add(linkGesture.onCancel(function () {\r\n            _this.removeLinkDecorations();\r\n            _this.currentWordAtPosition = null;\r\n        }));\r\n    }\r\n    GotoDefinitionAtPositionEditorContribution.get = function (editor) {\r\n        return editor.getContribution(GotoDefinitionAtPositionEditorContribution.ID);\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.startFindDefinitionFromCursor = function (position) {\r\n        // For issue: https://github.com/microsoft/vscode/issues/46257\r\n        // equivalent to mouse move with meta/ctrl key\r\n        var _this = this;\r\n        // First find the definition and add decorations\r\n        // to the editor to be shown with the content hover widget\r\n        return this.startFindDefinition(position).then(function () {\r\n            // Add listeners for editor cursor move and key down events\r\n            // Dismiss the \"extended\" editor decorations when the user hides\r\n            // the hover widget. There is no event for the widget itself so these\r\n            // serve as a best effort. After removing the link decorations, the hover\r\n            // widget is clean and will only show declarations per next request.\r\n            _this.toUnhookForKeyboard.add(_this.editor.onDidChangeCursorPosition(function () {\r\n                _this.currentWordAtPosition = null;\r\n                _this.removeLinkDecorations();\r\n                _this.toUnhookForKeyboard.clear();\r\n            }));\r\n            _this.toUnhookForKeyboard.add(_this.editor.onKeyDown(function (e) {\r\n                if (e) {\r\n                    _this.currentWordAtPosition = null;\r\n                    _this.removeLinkDecorations();\r\n                    _this.toUnhookForKeyboard.clear();\r\n                }\r\n            }));\r\n        });\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.startFindDefinitionFromMouse = function (mouseEvent, withKey) {\r\n        // check if we are active and on a content widget\r\n        if (mouseEvent.target.type === 9 /* CONTENT_WIDGET */ && this.linkDecorations.length > 0) {\r\n            return;\r\n        }\r\n        if (!this.editor.hasModel() || !this.isEnabled(mouseEvent, withKey)) {\r\n            this.currentWordAtPosition = null;\r\n            this.removeLinkDecorations();\r\n            return;\r\n        }\r\n        var position = mouseEvent.target.position;\r\n        this.startFindDefinition(position);\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.startFindDefinition = function (position) {\r\n        var _this = this;\r\n        var _a;\r\n        // Dispose listeners for updating decorations when using keyboard to show definition hover\r\n        this.toUnhookForKeyboard.clear();\r\n        // Find word at mouse position\r\n        var word = position ? (_a = this.editor.getModel()) === null || _a === void 0 ? void 0 : _a.getWordAtPosition(position) : null;\r\n        if (!word) {\r\n            this.currentWordAtPosition = null;\r\n            this.removeLinkDecorations();\r\n            return Promise.resolve(0);\r\n        }\r\n        // Return early if word at position is still the same\r\n        if (this.currentWordAtPosition && this.currentWordAtPosition.startColumn === word.startColumn && this.currentWordAtPosition.endColumn === word.endColumn && this.currentWordAtPosition.word === word.word) {\r\n            return Promise.resolve(0);\r\n        }\r\n        this.currentWordAtPosition = word;\r\n        // Find definition and decorate word if found\r\n        var state = new EditorState(this.editor, 4 /* Position */ | 1 /* Value */ | 2 /* Selection */ | 8 /* Scroll */);\r\n        if (this.previousPromise) {\r\n            this.previousPromise.cancel();\r\n            this.previousPromise = null;\r\n        }\r\n        this.previousPromise = createCancelablePromise(function (token) { return _this.findDefinition(position, token); });\r\n        return this.previousPromise.then(function (results) {\r\n            if (!results || !results.length || !state.validate(_this.editor)) {\r\n                _this.removeLinkDecorations();\r\n                return;\r\n            }\r\n            // Multiple results\r\n            if (results.length > 1) {\r\n                _this.addDecoration(new Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn), new MarkdownString().appendText(nls.localize('multipleResults', \"Click to show {0} definitions.\", results.length)));\r\n            }\r\n            // Single result\r\n            else {\r\n                var result_1 = results[0];\r\n                if (!result_1.uri) {\r\n                    return;\r\n                }\r\n                _this.textModelResolverService.createModelReference(result_1.uri).then(function (ref) {\r\n                    if (!ref.object || !ref.object.textEditorModel) {\r\n                        ref.dispose();\r\n                        return;\r\n                    }\r\n                    var textEditorModel = ref.object.textEditorModel;\r\n                    var startLineNumber = result_1.range.startLineNumber;\r\n                    if (startLineNumber < 1 || startLineNumber > textEditorModel.getLineCount()) {\r\n                        // invalid range\r\n                        ref.dispose();\r\n                        return;\r\n                    }\r\n                    var previewValue = _this.getPreviewValue(textEditorModel, startLineNumber, result_1);\r\n                    var wordRange;\r\n                    if (result_1.originSelectionRange) {\r\n                        wordRange = Range.lift(result_1.originSelectionRange);\r\n                    }\r\n                    else {\r\n                        wordRange = new Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn);\r\n                    }\r\n                    var modeId = _this.modeService.getModeIdByFilepathOrFirstLine(textEditorModel.uri);\r\n                    _this.addDecoration(wordRange, new MarkdownString().appendCodeblock(modeId ? modeId : '', previewValue));\r\n                    ref.dispose();\r\n                });\r\n            }\r\n        }).then(undefined, onUnexpectedError);\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.getPreviewValue = function (textEditorModel, startLineNumber, result) {\r\n        var rangeToUse = result.targetSelectionRange ? result.range : this.getPreviewRangeBasedOnBrackets(textEditorModel, startLineNumber);\r\n        var numberOfLinesInRange = rangeToUse.endLineNumber - rangeToUse.startLineNumber;\r\n        if (numberOfLinesInRange >= GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES) {\r\n            rangeToUse = this.getPreviewRangeBasedOnIndentation(textEditorModel, startLineNumber);\r\n        }\r\n        var previewValue = this.stripIndentationFromPreviewRange(textEditorModel, startLineNumber, rangeToUse);\r\n        return previewValue;\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.stripIndentationFromPreviewRange = function (textEditorModel, startLineNumber, previewRange) {\r\n        var startIndent = textEditorModel.getLineFirstNonWhitespaceColumn(startLineNumber);\r\n        var minIndent = startIndent;\r\n        for (var endLineNumber = startLineNumber + 1; endLineNumber < previewRange.endLineNumber; endLineNumber++) {\r\n            var endIndent = textEditorModel.getLineFirstNonWhitespaceColumn(endLineNumber);\r\n            minIndent = Math.min(minIndent, endIndent);\r\n        }\r\n        var previewValue = textEditorModel.getValueInRange(previewRange).replace(new RegExp(\"^\\\\s{\" + (minIndent - 1) + \"}\", 'gm'), '').trim();\r\n        return previewValue;\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.getPreviewRangeBasedOnIndentation = function (textEditorModel, startLineNumber) {\r\n        var startIndent = textEditorModel.getLineFirstNonWhitespaceColumn(startLineNumber);\r\n        var maxLineNumber = Math.min(textEditorModel.getLineCount(), startLineNumber + GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES);\r\n        var endLineNumber = startLineNumber + 1;\r\n        for (; endLineNumber < maxLineNumber; endLineNumber++) {\r\n            var endIndent = textEditorModel.getLineFirstNonWhitespaceColumn(endLineNumber);\r\n            if (startIndent === endIndent) {\r\n                break;\r\n            }\r\n        }\r\n        return new Range(startLineNumber, 1, endLineNumber + 1, 1);\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.getPreviewRangeBasedOnBrackets = function (textEditorModel, startLineNumber) {\r\n        var maxLineNumber = Math.min(textEditorModel.getLineCount(), startLineNumber + GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES);\r\n        var brackets = [];\r\n        var ignoreFirstEmpty = true;\r\n        var currentBracket = textEditorModel.findNextBracket(new Position(startLineNumber, 1));\r\n        while (currentBracket !== null) {\r\n            if (brackets.length === 0) {\r\n                brackets.push(currentBracket);\r\n            }\r\n            else {\r\n                var lastBracket = brackets[brackets.length - 1];\r\n                if (lastBracket.open[0] === currentBracket.open[0] && lastBracket.isOpen && !currentBracket.isOpen) {\r\n                    brackets.pop();\r\n                }\r\n                else {\r\n                    brackets.push(currentBracket);\r\n                }\r\n                if (brackets.length === 0) {\r\n                    if (ignoreFirstEmpty) {\r\n                        ignoreFirstEmpty = false;\r\n                    }\r\n                    else {\r\n                        return new Range(startLineNumber, 1, currentBracket.range.endLineNumber + 1, 1);\r\n                    }\r\n                }\r\n            }\r\n            var maxColumn = textEditorModel.getLineMaxColumn(startLineNumber);\r\n            var nextLineNumber = currentBracket.range.endLineNumber;\r\n            var nextColumn = currentBracket.range.endColumn;\r\n            if (maxColumn === currentBracket.range.endColumn) {\r\n                nextLineNumber++;\r\n                nextColumn = 1;\r\n            }\r\n            if (nextLineNumber > maxLineNumber) {\r\n                return new Range(startLineNumber, 1, maxLineNumber + 1, 1);\r\n            }\r\n            currentBracket = textEditorModel.findNextBracket(new Position(nextLineNumber, nextColumn));\r\n        }\r\n        return new Range(startLineNumber, 1, maxLineNumber + 1, 1);\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.addDecoration = function (range, hoverMessage) {\r\n        var newDecorations = {\r\n            range: range,\r\n            options: {\r\n                inlineClassName: 'goto-definition-link',\r\n                hoverMessage: hoverMessage\r\n            }\r\n        };\r\n        this.linkDecorations = this.editor.deltaDecorations(this.linkDecorations, [newDecorations]);\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.removeLinkDecorations = function () {\r\n        if (this.linkDecorations.length > 0) {\r\n            this.linkDecorations = this.editor.deltaDecorations(this.linkDecorations, []);\r\n        }\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.isEnabled = function (mouseEvent, withKey) {\r\n        return this.editor.hasModel() &&\r\n            mouseEvent.isNoneOrSingleMouseDown &&\r\n            (mouseEvent.target.type === 6 /* CONTENT_TEXT */) &&\r\n            (mouseEvent.hasTriggerModifier || (withKey ? withKey.keyCodeIsTriggerKey : false)) &&\r\n            DefinitionProviderRegistry.has(this.editor.getModel());\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.findDefinition = function (position, token) {\r\n        var model = this.editor.getModel();\r\n        if (!model) {\r\n            return Promise.resolve(null);\r\n        }\r\n        return getDefinitionsAtPosition(model, position, token);\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.gotoDefinition = function (position, openToSide) {\r\n        var _this = this;\r\n        this.editor.setPosition(position);\r\n        var action = new DefinitionAction({ openToSide: openToSide, openInPeek: false, muteMessage: true }, { alias: '', label: '', id: '', precondition: undefined });\r\n        return this.editor.invokeWithinContext(function (accessor) { return action.run(accessor, _this.editor); });\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.prototype.dispose = function () {\r\n        this.toUnhook.dispose();\r\n    };\r\n    GotoDefinitionAtPositionEditorContribution.ID = 'editor.contrib.gotodefinitionatposition';\r\n    GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES = 8;\r\n    GotoDefinitionAtPositionEditorContribution = __decorate([\r\n        __param(1, ITextModelService),\r\n        __param(2, IModeService)\r\n    ], GotoDefinitionAtPositionEditorContribution);\r\n    return GotoDefinitionAtPositionEditorContribution;\r\n}());\r\nexport { GotoDefinitionAtPositionEditorContribution };\r\nregisterEditorContribution(GotoDefinitionAtPositionEditorContribution.ID, GotoDefinitionAtPositionEditorContribution);\r\nregisterThemingParticipant(function (theme, collector) {\r\n    var activeLinkForeground = theme.getColor(editorActiveLinkForeground);\r\n    if (activeLinkForeground) {\r\n        collector.addRule(\".monaco-editor .goto-definition-link { color: \" + activeLinkForeground + \" !important; }\");\r\n    }\r\n});\r\n"]},"metadata":{},"sourceType":"module"}