{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nimport * as nls from '../../../../nls.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { dispose, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { ICodeEditorService } from '../../../browser/services/codeEditorService.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IContextKeyService, RawContextKey, ContextKeyExpr } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IStorageService } from '../../../../platform/storage/common/storage.js';\nimport { OneReference } from '../referencesModel.js';\nimport { ReferenceWidget, LayoutData } from './referencesWidget.js';\nimport { Range } from '../../../common/core/range.js';\nimport { Position } from '../../../common/core/position.js';\nimport { INotificationService } from '../../../../platform/notification/common/notification.js';\nimport { createCancelablePromise } from '../../../../base/common/async.js';\nimport { getOuterEditor, PeekContext } from '../../peekView/peekView.js';\nimport { IListService, WorkbenchListFocusContextKey } from '../../../../platform/list/browser/listService.js';\nimport { KeybindingsRegistry } from '../../../../platform/keybinding/common/keybindingsRegistry.js';\nimport { KeyChord } from '../../../../base/common/keyCodes.js';\nimport { CommandsRegistry } from '../../../../platform/commands/common/commands.js';\nexport var ctxReferenceSearchVisible = new RawContextKey('referenceSearchVisible', false);\n\nvar ReferencesController =\n/** @class */\nfunction () {\n  function ReferencesController(_defaultTreeKeyboardSupport, _editor, contextKeyService, _editorService, _notificationService, _instantiationService, _storageService, _configurationService) {\n    this._defaultTreeKeyboardSupport = _defaultTreeKeyboardSupport;\n    this._editor = _editor;\n    this._editorService = _editorService;\n    this._notificationService = _notificationService;\n    this._instantiationService = _instantiationService;\n    this._storageService = _storageService;\n    this._configurationService = _configurationService;\n    this._disposables = new DisposableStore();\n    this._requestIdPool = 0;\n    this._ignoreModelChangeEvent = false;\n    this._referenceSearchVisible = ctxReferenceSearchVisible.bindTo(contextKeyService);\n  }\n\n  ReferencesController.get = function (editor) {\n    return editor.getContribution(ReferencesController.ID);\n  };\n\n  ReferencesController.prototype.dispose = function () {\n    this._referenceSearchVisible.reset();\n\n    this._disposables.dispose();\n\n    dispose(this._widget);\n    dispose(this._model);\n    this._widget = undefined;\n    this._model = undefined;\n  };\n\n  ReferencesController.prototype.toggleWidget = function (range, modelPromise, peekMode) {\n    var _this = this; // close current widget and return early is position didn't change\n\n\n    var widgetPosition;\n\n    if (this._widget) {\n      widgetPosition = this._widget.position;\n    }\n\n    this.closeWidget();\n\n    if (!!widgetPosition && range.containsPosition(widgetPosition)) {\n      return;\n    }\n\n    this._peekMode = peekMode;\n\n    this._referenceSearchVisible.set(true); // close the widget on model/mode changes\n\n\n    this._disposables.add(this._editor.onDidChangeModelLanguage(function () {\n      _this.closeWidget();\n    }));\n\n    this._disposables.add(this._editor.onDidChangeModel(function () {\n      if (!_this._ignoreModelChangeEvent) {\n        _this.closeWidget();\n      }\n    }));\n\n    var storageKey = 'peekViewLayout';\n    var data = LayoutData.fromJSON(this._storageService.get(storageKey, 0\n    /* GLOBAL */\n    , '{}'));\n    this._widget = this._instantiationService.createInstance(ReferenceWidget, this._editor, this._defaultTreeKeyboardSupport, data);\n\n    this._widget.setTitle(nls.localize('labelLoading', \"Loading...\"));\n\n    this._widget.show(range);\n\n    this._disposables.add(this._widget.onDidClose(function () {\n      modelPromise.cancel();\n\n      if (_this._widget) {\n        _this._storageService.store(storageKey, JSON.stringify(_this._widget.layoutData), 0\n        /* GLOBAL */\n        );\n\n        _this._widget = undefined;\n      }\n\n      _this.closeWidget();\n    }));\n\n    this._disposables.add(this._widget.onDidSelectReference(function (event) {\n      var element = event.element,\n          kind = event.kind;\n\n      if (!element) {\n        return;\n      }\n\n      switch (kind) {\n        case 'open':\n          if (event.source !== 'editor' || !_this._configurationService.getValue('editor.stablePeek')) {\n            // when stable peek is configured we don't close\n            // the peek window on selecting the editor\n            _this.openReference(element, false);\n          }\n\n          break;\n\n        case 'side':\n          _this.openReference(element, true);\n\n          break;\n\n        case 'goto':\n          if (peekMode) {\n            _this._gotoReference(element);\n          } else {\n            _this.openReference(element, false);\n          }\n\n          break;\n      }\n    }));\n\n    var requestId = ++this._requestIdPool;\n    modelPromise.then(function (model) {\n      // still current request? widget still open?\n      if (requestId !== _this._requestIdPool || !_this._widget) {\n        return undefined;\n      }\n\n      if (_this._model) {\n        _this._model.dispose();\n      }\n\n      _this._model = model; // show widget\n\n      return _this._widget.setModel(_this._model).then(function () {\n        if (_this._widget && _this._model && _this._editor.hasModel()) {\n          // might have been closed\n          // set title\n          if (!_this._model.isEmpty) {\n            _this._widget.setMetaTitle(nls.localize('metaTitle.N', \"{0} ({1})\", _this._model.title, _this._model.references.length));\n          } else {\n            _this._widget.setMetaTitle('');\n          } // set 'best' selection\n\n\n          var uri = _this._editor.getModel().uri;\n\n          var pos = new Position(range.startLineNumber, range.startColumn);\n\n          var selection = _this._model.nearestReference(uri, pos);\n\n          if (selection) {\n            return _this._widget.setSelection(selection).then(function () {\n              if (_this._widget && _this._editor.getOption(65\n              /* peekWidgetDefaultFocus */\n              ) === 'editor') {\n                _this._widget.focusOnPreviewEditor();\n              }\n            });\n          }\n        }\n\n        return undefined;\n      });\n    }, function (error) {\n      _this._notificationService.error(error);\n    });\n  };\n\n  ReferencesController.prototype.changeFocusBetweenPreviewAndReferences = function () {\n    if (!this._widget) {\n      // can be called while still resolving...\n      return;\n    }\n\n    if (this._widget.isPreviewEditorFocused()) {\n      this._widget.focusOnReferenceTree();\n    } else {\n      this._widget.focusOnPreviewEditor();\n    }\n  };\n\n  ReferencesController.prototype.goToNextOrPreviousReference = function (fwd) {\n    return __awaiter(this, void 0, void 0, function () {\n      var currentPosition, source, target, editorFocus, previewEditorFocus;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!this._editor.hasModel() || !this._model || !this._widget) {\n              // can be called while still resolving...\n              return [2\n              /*return*/\n              ];\n            }\n\n            currentPosition = this._widget.position;\n\n            if (!currentPosition) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            source = this._model.nearestReference(this._editor.getModel().uri, currentPosition);\n\n            if (!source) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            target = this._model.nextOrPreviousReference(source, fwd);\n            editorFocus = this._editor.hasTextFocus();\n            previewEditorFocus = this._widget.isPreviewEditorFocused();\n            return [4\n            /*yield*/\n            , this._widget.setSelection(target)];\n\n          case 1:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , this._gotoReference(target)];\n\n          case 2:\n            _a.sent();\n\n            if (editorFocus) {\n              this._editor.focus();\n            } else if (this._widget && previewEditorFocus) {\n              this._widget.focusOnPreviewEditor();\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  ReferencesController.prototype.closeWidget = function (focusEditor) {\n    if (focusEditor === void 0) {\n      focusEditor = true;\n    }\n\n    this._referenceSearchVisible.reset();\n\n    this._disposables.clear();\n\n    dispose(this._widget);\n    dispose(this._model);\n    this._widget = undefined;\n    this._model = undefined;\n\n    if (focusEditor) {\n      this._editor.focus();\n    }\n\n    this._requestIdPool += 1; // Cancel pending requests\n  };\n\n  ReferencesController.prototype._gotoReference = function (ref) {\n    var _this = this;\n\n    if (this._widget) {\n      this._widget.hide();\n    }\n\n    this._ignoreModelChangeEvent = true;\n    var range = Range.lift(ref.range).collapseToStart();\n    return this._editorService.openCodeEditor({\n      resource: ref.uri,\n      options: {\n        selection: range\n      }\n    }, this._editor).then(function (openedEditor) {\n      var _a;\n\n      _this._ignoreModelChangeEvent = false;\n\n      if (!openedEditor || !_this._widget) {\n        // something went wrong...\n        _this.closeWidget();\n\n        return;\n      }\n\n      if (_this._editor === openedEditor) {\n        //\n        _this._widget.show(range);\n\n        _this._widget.focusOnReferenceTree();\n      } else {\n        // we opened a different editor instance which means a different controller instance.\n        // therefore we stop with this controller and continue with the other\n        var other = ReferencesController.get(openedEditor);\n\n        var model_1 = _this._model.clone();\n\n        _this.closeWidget();\n\n        openedEditor.focus();\n        other.toggleWidget(range, createCancelablePromise(function (_) {\n          return Promise.resolve(model_1);\n        }), (_a = _this._peekMode) !== null && _a !== void 0 ? _a : false);\n      }\n    }, function (err) {\n      _this._ignoreModelChangeEvent = false;\n      onUnexpectedError(err);\n    });\n  };\n\n  ReferencesController.prototype.openReference = function (ref, sideBySide) {\n    // clear stage\n    if (!sideBySide) {\n      this.closeWidget();\n    }\n\n    var uri = ref.uri,\n        range = ref.range;\n\n    this._editorService.openCodeEditor({\n      resource: uri,\n      options: {\n        selection: range\n      }\n    }, this._editor, sideBySide);\n  };\n\n  ReferencesController.ID = 'editor.contrib.referencesController';\n  ReferencesController = __decorate([__param(2, IContextKeyService), __param(3, ICodeEditorService), __param(4, INotificationService), __param(5, IInstantiationService), __param(6, IStorageService), __param(7, IConfigurationService)], ReferencesController);\n  return ReferencesController;\n}();\n\nexport { ReferencesController };\n\nfunction withController(accessor, fn) {\n  var outerEditor = getOuterEditor(accessor);\n\n  if (!outerEditor) {\n    return;\n  }\n\n  var controller = ReferencesController.get(outerEditor);\n\n  if (controller) {\n    fn(controller);\n  }\n}\n\nKeybindingsRegistry.registerCommandAndKeybindingRule({\n  id: 'togglePeekWidgetFocus',\n  weight: 100\n  /* EditorContrib */\n  ,\n  primary: KeyChord(2048\n  /* CtrlCmd */\n  | 41\n  /* KEY_K */\n  , 60\n  /* F2 */\n  ),\n  when: ContextKeyExpr.or(ctxReferenceSearchVisible, PeekContext.inPeekEditor),\n  handler: function (accessor) {\n    withController(accessor, function (controller) {\n      controller.changeFocusBetweenPreviewAndReferences();\n    });\n  }\n});\nKeybindingsRegistry.registerCommandAndKeybindingRule({\n  id: 'goToNextReference',\n  weight: 100\n  /* EditorContrib */\n  - 10,\n  primary: 62\n  /* F4 */\n  ,\n  secondary: [70\n  /* F12 */\n  ],\n  when: ContextKeyExpr.or(ctxReferenceSearchVisible, PeekContext.inPeekEditor),\n  handler: function (accessor) {\n    withController(accessor, function (controller) {\n      controller.goToNextOrPreviousReference(true);\n    });\n  }\n});\nKeybindingsRegistry.registerCommandAndKeybindingRule({\n  id: 'goToPreviousReference',\n  weight: 100\n  /* EditorContrib */\n  - 10,\n  primary: 1024\n  /* Shift */\n  | 62\n  /* F4 */\n  ,\n  secondary: [1024\n  /* Shift */\n  | 70\n  /* F12 */\n  ],\n  when: ContextKeyExpr.or(ctxReferenceSearchVisible, PeekContext.inPeekEditor),\n  handler: function (accessor) {\n    withController(accessor, function (controller) {\n      controller.goToNextOrPreviousReference(false);\n    });\n  }\n}); // commands that aren't needed anymore because there is now ContextKeyExpr.OR\n\nCommandsRegistry.registerCommandAlias('goToNextReferenceFromEmbeddedEditor', 'goToNextReference');\nCommandsRegistry.registerCommandAlias('goToPreviousReferenceFromEmbeddedEditor', 'goToPreviousReference'); // close\n\nCommandsRegistry.registerCommandAlias('closeReferenceSearchEditor', 'closeReferenceSearch');\nCommandsRegistry.registerCommand('closeReferenceSearch', function (accessor) {\n  return withController(accessor, function (controller) {\n    return controller.closeWidget();\n  });\n});\nKeybindingsRegistry.registerKeybindingRule({\n  id: 'closeReferenceSearch',\n  weight: 100\n  /* EditorContrib */\n  - 101,\n  primary: 9\n  /* Escape */\n  ,\n  secondary: [1024\n  /* Shift */\n  | 9\n  /* Escape */\n  ],\n  when: ContextKeyExpr.and(PeekContext.inPeekEditor, ContextKeyExpr.not('config.editor.stablePeek'))\n});\nKeybindingsRegistry.registerKeybindingRule({\n  id: 'closeReferenceSearch',\n  weight: 200\n  /* WorkbenchContrib */\n  + 50,\n  primary: 9\n  /* Escape */\n  ,\n  secondary: [1024\n  /* Shift */\n  | 9\n  /* Escape */\n  ],\n  when: ContextKeyExpr.and(ctxReferenceSearchVisible, ContextKeyExpr.not('config.editor.stablePeek'))\n});\nKeybindingsRegistry.registerCommandAndKeybindingRule({\n  id: 'openReferenceToSide',\n  weight: 100\n  /* EditorContrib */\n  ,\n  primary: 2048\n  /* CtrlCmd */\n  | 3\n  /* Enter */\n  ,\n  mac: {\n    primary: 256\n    /* WinCtrl */\n    | 3\n    /* Enter */\n\n  },\n  when: ContextKeyExpr.and(ctxReferenceSearchVisible, WorkbenchListFocusContextKey),\n  handler: function (accessor) {\n    var _a;\n\n    var listService = accessor.get(IListService);\n    var focus = (_a = listService.lastFocusedList) === null || _a === void 0 ? void 0 : _a.getFocus();\n\n    if (Array.isArray(focus) && focus[0] instanceof OneReference) {\n      withController(accessor, function (controller) {\n        return controller.openReference(focus[0], true);\n      });\n    }\n  }\n});\nCommandsRegistry.registerCommand('openReference', function (accessor) {\n  var _a;\n\n  var listService = accessor.get(IListService);\n  var focus = (_a = listService.lastFocusedList) === null || _a === void 0 ? void 0 : _a.getFocus();\n\n  if (Array.isArray(focus) && focus[0] instanceof OneReference) {\n    withController(accessor, function (controller) {\n      return controller.openReference(focus[0], false);\n    });\n  }\n});","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/editor/contrib/gotoSymbol/peek/referencesController.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__param","paramIndex","decorator","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","__generator","body","_","label","sent","t","trys","ops","f","y","g","verb","Symbol","iterator","n","v","op","TypeError","call","pop","push","nls","onUnexpectedError","dispose","DisposableStore","ICodeEditorService","IInstantiationService","IContextKeyService","RawContextKey","ContextKeyExpr","IConfigurationService","IStorageService","OneReference","ReferenceWidget","LayoutData","Range","Position","INotificationService","createCancelablePromise","getOuterEditor","PeekContext","IListService","WorkbenchListFocusContextKey","KeybindingsRegistry","KeyChord","CommandsRegistry","ctxReferenceSearchVisible","ReferencesController","_defaultTreeKeyboardSupport","_editor","contextKeyService","_editorService","_notificationService","_instantiationService","_storageService","_configurationService","_disposables","_requestIdPool","_ignoreModelChangeEvent","_referenceSearchVisible","bindTo","get","editor","getContribution","ID","prototype","reset","_widget","_model","undefined","toggleWidget","range","modelPromise","peekMode","_this","widgetPosition","position","closeWidget","containsPosition","_peekMode","set","add","onDidChangeModelLanguage","onDidChangeModel","storageKey","data","fromJSON","createInstance","setTitle","localize","show","onDidClose","cancel","store","JSON","stringify","layoutData","onDidSelectReference","event","element","kind","source","getValue","openReference","_gotoReference","requestId","model","setModel","hasModel","isEmpty","setMetaTitle","title","references","uri","getModel","pos","startLineNumber","startColumn","selection","nearestReference","setSelection","getOption","focusOnPreviewEditor","error","changeFocusBetweenPreviewAndReferences","isPreviewEditorFocused","focusOnReferenceTree","goToNextOrPreviousReference","fwd","currentPosition","editorFocus","previewEditorFocus","_a","nextOrPreviousReference","hasTextFocus","focus","focusEditor","clear","ref","hide","lift","collapseToStart","openCodeEditor","resource","options","openedEditor","other","model_1","clone","err","sideBySide","withController","accessor","fn","outerEditor","controller","registerCommandAndKeybindingRule","id","weight","primary","when","or","inPeekEditor","handler","secondary","registerCommandAlias","registerCommand","registerKeybindingRule","and","not","mac","listService","lastFocusedList","getFocus","Array","isArray"],"mappings":"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APD","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n};\r\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n};\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nimport * as nls from '../../../../nls.js';\r\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\r\nimport { dispose, DisposableStore } from '../../../../base/common/lifecycle.js';\r\nimport { ICodeEditorService } from '../../../browser/services/codeEditorService.js';\r\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\r\nimport { IContextKeyService, RawContextKey, ContextKeyExpr } from '../../../../platform/contextkey/common/contextkey.js';\r\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\r\nimport { IStorageService } from '../../../../platform/storage/common/storage.js';\r\nimport { OneReference } from '../referencesModel.js';\r\nimport { ReferenceWidget, LayoutData } from './referencesWidget.js';\r\nimport { Range } from '../../../common/core/range.js';\r\nimport { Position } from '../../../common/core/position.js';\r\nimport { INotificationService } from '../../../../platform/notification/common/notification.js';\r\nimport { createCancelablePromise } from '../../../../base/common/async.js';\r\nimport { getOuterEditor, PeekContext } from '../../peekView/peekView.js';\r\nimport { IListService, WorkbenchListFocusContextKey } from '../../../../platform/list/browser/listService.js';\r\nimport { KeybindingsRegistry } from '../../../../platform/keybinding/common/keybindingsRegistry.js';\r\nimport { KeyChord } from '../../../../base/common/keyCodes.js';\r\nimport { CommandsRegistry } from '../../../../platform/commands/common/commands.js';\r\nexport var ctxReferenceSearchVisible = new RawContextKey('referenceSearchVisible', false);\r\nvar ReferencesController = /** @class */ (function () {\r\n    function ReferencesController(_defaultTreeKeyboardSupport, _editor, contextKeyService, _editorService, _notificationService, _instantiationService, _storageService, _configurationService) {\r\n        this._defaultTreeKeyboardSupport = _defaultTreeKeyboardSupport;\r\n        this._editor = _editor;\r\n        this._editorService = _editorService;\r\n        this._notificationService = _notificationService;\r\n        this._instantiationService = _instantiationService;\r\n        this._storageService = _storageService;\r\n        this._configurationService = _configurationService;\r\n        this._disposables = new DisposableStore();\r\n        this._requestIdPool = 0;\r\n        this._ignoreModelChangeEvent = false;\r\n        this._referenceSearchVisible = ctxReferenceSearchVisible.bindTo(contextKeyService);\r\n    }\r\n    ReferencesController.get = function (editor) {\r\n        return editor.getContribution(ReferencesController.ID);\r\n    };\r\n    ReferencesController.prototype.dispose = function () {\r\n        this._referenceSearchVisible.reset();\r\n        this._disposables.dispose();\r\n        dispose(this._widget);\r\n        dispose(this._model);\r\n        this._widget = undefined;\r\n        this._model = undefined;\r\n    };\r\n    ReferencesController.prototype.toggleWidget = function (range, modelPromise, peekMode) {\r\n        var _this = this;\r\n        // close current widget and return early is position didn't change\r\n        var widgetPosition;\r\n        if (this._widget) {\r\n            widgetPosition = this._widget.position;\r\n        }\r\n        this.closeWidget();\r\n        if (!!widgetPosition && range.containsPosition(widgetPosition)) {\r\n            return;\r\n        }\r\n        this._peekMode = peekMode;\r\n        this._referenceSearchVisible.set(true);\r\n        // close the widget on model/mode changes\r\n        this._disposables.add(this._editor.onDidChangeModelLanguage(function () { _this.closeWidget(); }));\r\n        this._disposables.add(this._editor.onDidChangeModel(function () {\r\n            if (!_this._ignoreModelChangeEvent) {\r\n                _this.closeWidget();\r\n            }\r\n        }));\r\n        var storageKey = 'peekViewLayout';\r\n        var data = LayoutData.fromJSON(this._storageService.get(storageKey, 0 /* GLOBAL */, '{}'));\r\n        this._widget = this._instantiationService.createInstance(ReferenceWidget, this._editor, this._defaultTreeKeyboardSupport, data);\r\n        this._widget.setTitle(nls.localize('labelLoading', \"Loading...\"));\r\n        this._widget.show(range);\r\n        this._disposables.add(this._widget.onDidClose(function () {\r\n            modelPromise.cancel();\r\n            if (_this._widget) {\r\n                _this._storageService.store(storageKey, JSON.stringify(_this._widget.layoutData), 0 /* GLOBAL */);\r\n                _this._widget = undefined;\r\n            }\r\n            _this.closeWidget();\r\n        }));\r\n        this._disposables.add(this._widget.onDidSelectReference(function (event) {\r\n            var element = event.element, kind = event.kind;\r\n            if (!element) {\r\n                return;\r\n            }\r\n            switch (kind) {\r\n                case 'open':\r\n                    if (event.source !== 'editor' || !_this._configurationService.getValue('editor.stablePeek')) {\r\n                        // when stable peek is configured we don't close\r\n                        // the peek window on selecting the editor\r\n                        _this.openReference(element, false);\r\n                    }\r\n                    break;\r\n                case 'side':\r\n                    _this.openReference(element, true);\r\n                    break;\r\n                case 'goto':\r\n                    if (peekMode) {\r\n                        _this._gotoReference(element);\r\n                    }\r\n                    else {\r\n                        _this.openReference(element, false);\r\n                    }\r\n                    break;\r\n            }\r\n        }));\r\n        var requestId = ++this._requestIdPool;\r\n        modelPromise.then(function (model) {\r\n            // still current request? widget still open?\r\n            if (requestId !== _this._requestIdPool || !_this._widget) {\r\n                return undefined;\r\n            }\r\n            if (_this._model) {\r\n                _this._model.dispose();\r\n            }\r\n            _this._model = model;\r\n            // show widget\r\n            return _this._widget.setModel(_this._model).then(function () {\r\n                if (_this._widget && _this._model && _this._editor.hasModel()) { // might have been closed\r\n                    // set title\r\n                    if (!_this._model.isEmpty) {\r\n                        _this._widget.setMetaTitle(nls.localize('metaTitle.N', \"{0} ({1})\", _this._model.title, _this._model.references.length));\r\n                    }\r\n                    else {\r\n                        _this._widget.setMetaTitle('');\r\n                    }\r\n                    // set 'best' selection\r\n                    var uri = _this._editor.getModel().uri;\r\n                    var pos = new Position(range.startLineNumber, range.startColumn);\r\n                    var selection = _this._model.nearestReference(uri, pos);\r\n                    if (selection) {\r\n                        return _this._widget.setSelection(selection).then(function () {\r\n                            if (_this._widget && _this._editor.getOption(65 /* peekWidgetDefaultFocus */) === 'editor') {\r\n                                _this._widget.focusOnPreviewEditor();\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n                return undefined;\r\n            });\r\n        }, function (error) {\r\n            _this._notificationService.error(error);\r\n        });\r\n    };\r\n    ReferencesController.prototype.changeFocusBetweenPreviewAndReferences = function () {\r\n        if (!this._widget) {\r\n            // can be called while still resolving...\r\n            return;\r\n        }\r\n        if (this._widget.isPreviewEditorFocused()) {\r\n            this._widget.focusOnReferenceTree();\r\n        }\r\n        else {\r\n            this._widget.focusOnPreviewEditor();\r\n        }\r\n    };\r\n    ReferencesController.prototype.goToNextOrPreviousReference = function (fwd) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var currentPosition, source, target, editorFocus, previewEditorFocus;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!this._editor.hasModel() || !this._model || !this._widget) {\r\n                            // can be called while still resolving...\r\n                            return [2 /*return*/];\r\n                        }\r\n                        currentPosition = this._widget.position;\r\n                        if (!currentPosition) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        source = this._model.nearestReference(this._editor.getModel().uri, currentPosition);\r\n                        if (!source) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        target = this._model.nextOrPreviousReference(source, fwd);\r\n                        editorFocus = this._editor.hasTextFocus();\r\n                        previewEditorFocus = this._widget.isPreviewEditorFocused();\r\n                        return [4 /*yield*/, this._widget.setSelection(target)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, this._gotoReference(target)];\r\n                    case 2:\r\n                        _a.sent();\r\n                        if (editorFocus) {\r\n                            this._editor.focus();\r\n                        }\r\n                        else if (this._widget && previewEditorFocus) {\r\n                            this._widget.focusOnPreviewEditor();\r\n                        }\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    ReferencesController.prototype.closeWidget = function (focusEditor) {\r\n        if (focusEditor === void 0) { focusEditor = true; }\r\n        this._referenceSearchVisible.reset();\r\n        this._disposables.clear();\r\n        dispose(this._widget);\r\n        dispose(this._model);\r\n        this._widget = undefined;\r\n        this._model = undefined;\r\n        if (focusEditor) {\r\n            this._editor.focus();\r\n        }\r\n        this._requestIdPool += 1; // Cancel pending requests\r\n    };\r\n    ReferencesController.prototype._gotoReference = function (ref) {\r\n        var _this = this;\r\n        if (this._widget) {\r\n            this._widget.hide();\r\n        }\r\n        this._ignoreModelChangeEvent = true;\r\n        var range = Range.lift(ref.range).collapseToStart();\r\n        return this._editorService.openCodeEditor({\r\n            resource: ref.uri,\r\n            options: { selection: range }\r\n        }, this._editor).then(function (openedEditor) {\r\n            var _a;\r\n            _this._ignoreModelChangeEvent = false;\r\n            if (!openedEditor || !_this._widget) {\r\n                // something went wrong...\r\n                _this.closeWidget();\r\n                return;\r\n            }\r\n            if (_this._editor === openedEditor) {\r\n                //\r\n                _this._widget.show(range);\r\n                _this._widget.focusOnReferenceTree();\r\n            }\r\n            else {\r\n                // we opened a different editor instance which means a different controller instance.\r\n                // therefore we stop with this controller and continue with the other\r\n                var other = ReferencesController.get(openedEditor);\r\n                var model_1 = _this._model.clone();\r\n                _this.closeWidget();\r\n                openedEditor.focus();\r\n                other.toggleWidget(range, createCancelablePromise(function (_) { return Promise.resolve(model_1); }), (_a = _this._peekMode) !== null && _a !== void 0 ? _a : false);\r\n            }\r\n        }, function (err) {\r\n            _this._ignoreModelChangeEvent = false;\r\n            onUnexpectedError(err);\r\n        });\r\n    };\r\n    ReferencesController.prototype.openReference = function (ref, sideBySide) {\r\n        // clear stage\r\n        if (!sideBySide) {\r\n            this.closeWidget();\r\n        }\r\n        var uri = ref.uri, range = ref.range;\r\n        this._editorService.openCodeEditor({\r\n            resource: uri,\r\n            options: { selection: range }\r\n        }, this._editor, sideBySide);\r\n    };\r\n    ReferencesController.ID = 'editor.contrib.referencesController';\r\n    ReferencesController = __decorate([\r\n        __param(2, IContextKeyService),\r\n        __param(3, ICodeEditorService),\r\n        __param(4, INotificationService),\r\n        __param(5, IInstantiationService),\r\n        __param(6, IStorageService),\r\n        __param(7, IConfigurationService)\r\n    ], ReferencesController);\r\n    return ReferencesController;\r\n}());\r\nexport { ReferencesController };\r\nfunction withController(accessor, fn) {\r\n    var outerEditor = getOuterEditor(accessor);\r\n    if (!outerEditor) {\r\n        return;\r\n    }\r\n    var controller = ReferencesController.get(outerEditor);\r\n    if (controller) {\r\n        fn(controller);\r\n    }\r\n}\r\nKeybindingsRegistry.registerCommandAndKeybindingRule({\r\n    id: 'togglePeekWidgetFocus',\r\n    weight: 100 /* EditorContrib */,\r\n    primary: KeyChord(2048 /* CtrlCmd */ | 41 /* KEY_K */, 60 /* F2 */),\r\n    when: ContextKeyExpr.or(ctxReferenceSearchVisible, PeekContext.inPeekEditor),\r\n    handler: function (accessor) {\r\n        withController(accessor, function (controller) {\r\n            controller.changeFocusBetweenPreviewAndReferences();\r\n        });\r\n    }\r\n});\r\nKeybindingsRegistry.registerCommandAndKeybindingRule({\r\n    id: 'goToNextReference',\r\n    weight: 100 /* EditorContrib */ - 10,\r\n    primary: 62 /* F4 */,\r\n    secondary: [70 /* F12 */],\r\n    when: ContextKeyExpr.or(ctxReferenceSearchVisible, PeekContext.inPeekEditor),\r\n    handler: function (accessor) {\r\n        withController(accessor, function (controller) {\r\n            controller.goToNextOrPreviousReference(true);\r\n        });\r\n    }\r\n});\r\nKeybindingsRegistry.registerCommandAndKeybindingRule({\r\n    id: 'goToPreviousReference',\r\n    weight: 100 /* EditorContrib */ - 10,\r\n    primary: 1024 /* Shift */ | 62 /* F4 */,\r\n    secondary: [1024 /* Shift */ | 70 /* F12 */],\r\n    when: ContextKeyExpr.or(ctxReferenceSearchVisible, PeekContext.inPeekEditor),\r\n    handler: function (accessor) {\r\n        withController(accessor, function (controller) {\r\n            controller.goToNextOrPreviousReference(false);\r\n        });\r\n    }\r\n});\r\n// commands that aren't needed anymore because there is now ContextKeyExpr.OR\r\nCommandsRegistry.registerCommandAlias('goToNextReferenceFromEmbeddedEditor', 'goToNextReference');\r\nCommandsRegistry.registerCommandAlias('goToPreviousReferenceFromEmbeddedEditor', 'goToPreviousReference');\r\n// close\r\nCommandsRegistry.registerCommandAlias('closeReferenceSearchEditor', 'closeReferenceSearch');\r\nCommandsRegistry.registerCommand('closeReferenceSearch', function (accessor) { return withController(accessor, function (controller) { return controller.closeWidget(); }); });\r\nKeybindingsRegistry.registerKeybindingRule({\r\n    id: 'closeReferenceSearch',\r\n    weight: 100 /* EditorContrib */ - 101,\r\n    primary: 9 /* Escape */,\r\n    secondary: [1024 /* Shift */ | 9 /* Escape */],\r\n    when: ContextKeyExpr.and(PeekContext.inPeekEditor, ContextKeyExpr.not('config.editor.stablePeek'))\r\n});\r\nKeybindingsRegistry.registerKeybindingRule({\r\n    id: 'closeReferenceSearch',\r\n    weight: 200 /* WorkbenchContrib */ + 50,\r\n    primary: 9 /* Escape */,\r\n    secondary: [1024 /* Shift */ | 9 /* Escape */],\r\n    when: ContextKeyExpr.and(ctxReferenceSearchVisible, ContextKeyExpr.not('config.editor.stablePeek'))\r\n});\r\nKeybindingsRegistry.registerCommandAndKeybindingRule({\r\n    id: 'openReferenceToSide',\r\n    weight: 100 /* EditorContrib */,\r\n    primary: 2048 /* CtrlCmd */ | 3 /* Enter */,\r\n    mac: {\r\n        primary: 256 /* WinCtrl */ | 3 /* Enter */\r\n    },\r\n    when: ContextKeyExpr.and(ctxReferenceSearchVisible, WorkbenchListFocusContextKey),\r\n    handler: function (accessor) {\r\n        var _a;\r\n        var listService = accessor.get(IListService);\r\n        var focus = (_a = listService.lastFocusedList) === null || _a === void 0 ? void 0 : _a.getFocus();\r\n        if (Array.isArray(focus) && focus[0] instanceof OneReference) {\r\n            withController(accessor, function (controller) { return controller.openReference(focus[0], true); });\r\n        }\r\n    }\r\n});\r\nCommandsRegistry.registerCommand('openReference', function (accessor) {\r\n    var _a;\r\n    var listService = accessor.get(IListService);\r\n    var focus = (_a = listService.lastFocusedList) === null || _a === void 0 ? void 0 : _a.getFocus();\r\n    if (Array.isArray(focus) && focus[0] instanceof OneReference) {\r\n        withController(accessor, function (controller) { return controller.openReference(focus[0], false); });\r\n    }\r\n});\r\n"]},"metadata":{},"sourceType":"module"}