{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nimport { illegalState } from '../../../base/common/errors.js';\nimport { Graph } from './graph.js';\nimport { SyncDescriptor } from './descriptors.js';\nimport { IInstantiationService, _util, optional } from './instantiation.js';\nimport { ServiceCollection } from './serviceCollection.js';\nimport { IdleValue } from '../../../base/common/async.js'; // TRACING\n\nvar _enableTracing = false;\n\nvar _canUseProxy = typeof Proxy === 'function';\n\nvar CyclicDependencyError =\n/** @class */\nfunction (_super) {\n  __extends(CyclicDependencyError, _super);\n\n  function CyclicDependencyError(graph) {\n    var _this = _super.call(this, 'cyclic dependency between services') || this;\n\n    _this.message = graph.toString();\n    return _this;\n  }\n\n  return CyclicDependencyError;\n}(Error);\n\nvar InstantiationService =\n/** @class */\nfunction () {\n  function InstantiationService(services, strict, parent) {\n    if (services === void 0) {\n      services = new ServiceCollection();\n    }\n\n    if (strict === void 0) {\n      strict = false;\n    }\n\n    this._services = services;\n    this._strict = strict;\n    this._parent = parent;\n\n    this._services.set(IInstantiationService, this);\n  }\n\n  InstantiationService.prototype.createChild = function (services) {\n    return new InstantiationService(services, this._strict, this);\n  };\n\n  InstantiationService.prototype.invokeFunction = function (fn) {\n    var _this = this;\n\n    var args = [];\n\n    for (var _i = 1; _i < arguments.length; _i++) {\n      args[_i - 1] = arguments[_i];\n    }\n\n    var _trace = Trace.traceInvocation(fn);\n\n    var _done = false;\n\n    try {\n      var accessor = {\n        get: function (id, isOptional) {\n          if (_done) {\n            throw illegalState('service accessor is only valid during the invocation of its target method');\n          }\n\n          var result = _this._getOrCreateServiceInstance(id, _trace);\n\n          if (!result && isOptional !== optional) {\n            throw new Error(\"[invokeFunction] unknown service '\" + id + \"'\");\n          }\n\n          return result;\n        }\n      };\n      return fn.apply(undefined, __spreadArrays([accessor], args));\n    } finally {\n      _done = true;\n\n      _trace.stop();\n    }\n  };\n\n  InstantiationService.prototype.createInstance = function (ctorOrDescriptor) {\n    var rest = [];\n\n    for (var _i = 1; _i < arguments.length; _i++) {\n      rest[_i - 1] = arguments[_i];\n    }\n\n    var _trace;\n\n    var result;\n\n    if (ctorOrDescriptor instanceof SyncDescriptor) {\n      _trace = Trace.traceCreation(ctorOrDescriptor.ctor);\n      result = this._createInstance(ctorOrDescriptor.ctor, ctorOrDescriptor.staticArguments.concat(rest), _trace);\n    } else {\n      _trace = Trace.traceCreation(ctorOrDescriptor);\n      result = this._createInstance(ctorOrDescriptor, rest, _trace);\n    }\n\n    _trace.stop();\n\n    return result;\n  };\n\n  InstantiationService.prototype._createInstance = function (ctor, args, _trace) {\n    if (args === void 0) {\n      args = [];\n    } // arguments defined by service decorators\n\n\n    var serviceDependencies = _util.getServiceDependencies(ctor).sort(function (a, b) {\n      return a.index - b.index;\n    });\n\n    var serviceArgs = [];\n\n    for (var _i = 0, serviceDependencies_1 = serviceDependencies; _i < serviceDependencies_1.length; _i++) {\n      var dependency = serviceDependencies_1[_i];\n\n      var service = this._getOrCreateServiceInstance(dependency.id, _trace);\n\n      if (!service && this._strict && !dependency.optional) {\n        throw new Error(\"[createInstance] \" + ctor.name + \" depends on UNKNOWN service \" + dependency.id + \".\");\n      }\n\n      serviceArgs.push(service);\n    }\n\n    var firstServiceArgPos = serviceDependencies.length > 0 ? serviceDependencies[0].index : args.length; // check for argument mismatches, adjust static args if needed\n\n    if (args.length !== firstServiceArgPos) {\n      console.warn(\"[createInstance] First service dependency of \" + ctor.name + \" at position \" + (firstServiceArgPos + 1) + \" conflicts with \" + args.length + \" static arguments\");\n      var delta = firstServiceArgPos - args.length;\n\n      if (delta > 0) {\n        args = args.concat(new Array(delta));\n      } else {\n        args = args.slice(0, firstServiceArgPos);\n      }\n    } // now create the instance\n\n\n    return new (ctor.bind.apply(ctor, __spreadArrays([void 0], __spreadArrays(args, serviceArgs))))();\n  };\n\n  InstantiationService.prototype._setServiceInstance = function (id, instance) {\n    if (this._services.get(id) instanceof SyncDescriptor) {\n      this._services.set(id, instance);\n    } else if (this._parent) {\n      this._parent._setServiceInstance(id, instance);\n    } else {\n      throw new Error('illegalState - setting UNKNOWN service instance');\n    }\n  };\n\n  InstantiationService.prototype._getServiceInstanceOrDescriptor = function (id) {\n    var instanceOrDesc = this._services.get(id);\n\n    if (!instanceOrDesc && this._parent) {\n      return this._parent._getServiceInstanceOrDescriptor(id);\n    } else {\n      return instanceOrDesc;\n    }\n  };\n\n  InstantiationService.prototype._getOrCreateServiceInstance = function (id, _trace) {\n    var thing = this._getServiceInstanceOrDescriptor(id);\n\n    if (thing instanceof SyncDescriptor) {\n      return this._createAndCacheServiceInstance(id, thing, _trace.branch(id, true));\n    } else {\n      _trace.branch(id, false);\n\n      return thing;\n    }\n  };\n\n  InstantiationService.prototype._createAndCacheServiceInstance = function (id, desc, _trace) {\n    var graph = new Graph(function (data) {\n      return data.id.toString();\n    });\n    var cycleCount = 0;\n    var stack = [{\n      id: id,\n      desc: desc,\n      _trace: _trace\n    }];\n\n    while (stack.length) {\n      var item = stack.pop();\n      graph.lookupOrInsertNode(item); // a weak but working heuristic for cycle checks\n\n      if (cycleCount++ > 150) {\n        throw new CyclicDependencyError(graph);\n      } // check all dependencies for existence and if they need to be created first\n\n\n      for (var _i = 0, _a = _util.getServiceDependencies(item.desc.ctor); _i < _a.length; _i++) {\n        var dependency = _a[_i];\n\n        var instanceOrDesc = this._getServiceInstanceOrDescriptor(dependency.id);\n\n        if (!instanceOrDesc && !dependency.optional) {\n          console.warn(\"[createInstance] \" + id + \" depends on \" + dependency.id + \" which is NOT registered.\");\n        }\n\n        if (instanceOrDesc instanceof SyncDescriptor) {\n          var d = {\n            id: dependency.id,\n            desc: instanceOrDesc,\n            _trace: item._trace.branch(dependency.id, true)\n          };\n          graph.insertEdge(item, d);\n          stack.push(d);\n        }\n      }\n    }\n\n    while (true) {\n      var roots = graph.roots(); // if there is no more roots but still\n      // nodes in the graph we have a cycle\n\n      if (roots.length === 0) {\n        if (!graph.isEmpty()) {\n          throw new CyclicDependencyError(graph);\n        }\n\n        break;\n      }\n\n      for (var _b = 0, roots_1 = roots; _b < roots_1.length; _b++) {\n        var data = roots_1[_b].data; // create instance and overwrite the service collections\n\n        var instance = this._createServiceInstanceWithOwner(data.id, data.desc.ctor, data.desc.staticArguments, data.desc.supportsDelayedInstantiation, data._trace);\n\n        this._setServiceInstance(data.id, instance);\n\n        graph.removeNode(data);\n      }\n    }\n\n    return this._getServiceInstanceOrDescriptor(id);\n  };\n\n  InstantiationService.prototype._createServiceInstanceWithOwner = function (id, ctor, args, supportsDelayedInstantiation, _trace) {\n    if (args === void 0) {\n      args = [];\n    }\n\n    if (this._services.get(id) instanceof SyncDescriptor) {\n      return this._createServiceInstance(ctor, args, supportsDelayedInstantiation, _trace);\n    } else if (this._parent) {\n      return this._parent._createServiceInstanceWithOwner(id, ctor, args, supportsDelayedInstantiation, _trace);\n    } else {\n      throw new Error(\"illegalState - creating UNKNOWN service instance \" + ctor.name);\n    }\n  };\n\n  InstantiationService.prototype._createServiceInstance = function (ctor, args, _supportsDelayedInstantiation, _trace) {\n    var _this = this;\n\n    if (args === void 0) {\n      args = [];\n    }\n\n    if (!_supportsDelayedInstantiation || !_canUseProxy) {\n      // eager instantiation or no support JS proxies (e.g. IE11)\n      return this._createInstance(ctor, args, _trace);\n    } else {\n      // Return a proxy object that's backed by an idle value. That\n      // strategy is to instantiate services in our idle time or when actually\n      // needed but not when injected into a consumer\n      var idle_1 = new IdleValue(function () {\n        return _this._createInstance(ctor, args, _trace);\n      });\n      return new Proxy(Object.create(null), {\n        get: function (target, key) {\n          if (key in target) {\n            return target[key];\n          }\n\n          var obj = idle_1.getValue();\n          var prop = obj[key];\n\n          if (typeof prop !== 'function') {\n            return prop;\n          }\n\n          prop = prop.bind(obj);\n          target[key] = prop;\n          return prop;\n        },\n        set: function (_target, p, value) {\n          idle_1.getValue()[p] = value;\n          return true;\n        }\n      });\n    }\n  };\n\n  return InstantiationService;\n}();\n\nexport { InstantiationService };\n\nvar Trace =\n/** @class */\nfunction () {\n  function Trace(type, name) {\n    this.type = type;\n    this.name = name;\n    this._start = Date.now();\n    this._dep = [];\n  }\n\n  Trace.traceInvocation = function (ctor) {\n    return !_enableTracing ? Trace._None : new Trace(1\n    /* Invocation */\n    , ctor.name || ctor.toString().substring(0, 42).replace(/\\n/g, ''));\n  };\n\n  Trace.traceCreation = function (ctor) {\n    return !_enableTracing ? Trace._None : new Trace(0\n    /* Creation */\n    , ctor.name);\n  };\n\n  Trace.prototype.branch = function (id, first) {\n    var child = new Trace(2\n    /* Branch */\n    , id.toString());\n\n    this._dep.push([id, first, child]);\n\n    return child;\n  };\n\n  Trace.prototype.stop = function () {\n    var dur = Date.now() - this._start;\n\n    Trace._totals += dur;\n    var causedCreation = false;\n\n    function printChild(n, trace) {\n      var res = [];\n      var prefix = new Array(n + 1).join('\\t');\n\n      for (var _i = 0, _a = trace._dep; _i < _a.length; _i++) {\n        var _b = _a[_i],\n            id = _b[0],\n            first = _b[1],\n            child = _b[2];\n\n        if (first && child) {\n          causedCreation = true;\n          res.push(prefix + \"CREATES -> \" + id);\n          var nested = printChild(n + 1, child);\n\n          if (nested) {\n            res.push(nested);\n          }\n        } else {\n          res.push(prefix + \"uses -> \" + id);\n        }\n      }\n\n      return res.join('\\n');\n    }\n\n    var lines = [(this.type === 0\n    /* Creation */\n    ? 'CREATE' : 'CALL') + \" \" + this.name, \"\" + printChild(1, this), \"DONE, took \" + dur.toFixed(2) + \"ms (grand total \" + Trace._totals.toFixed(2) + \"ms)\"];\n\n    if (dur > 2 || causedCreation) {\n      console.log(lines.join('\\n'));\n    }\n  };\n\n  Trace._None = new (\n  /** @class */\n  function (_super) {\n    __extends(class_1, _super);\n\n    function class_1() {\n      return _super.call(this, -1, null) || this;\n    }\n\n    class_1.prototype.stop = function () {};\n\n    class_1.prototype.branch = function () {\n      return this;\n    };\n\n    return class_1;\n  }(Trace))();\n  Trace._totals = 0;\n  return Trace;\n}(); //#endregion","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/platform/instantiation/common/instantiationService.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__spreadArrays","s","i","il","arguments","length","r","k","a","j","jl","illegalState","Graph","SyncDescriptor","IInstantiationService","_util","optional","ServiceCollection","IdleValue","_enableTracing","_canUseProxy","Proxy","CyclicDependencyError","_super","graph","_this","call","message","toString","Error","InstantiationService","services","strict","parent","_services","_strict","_parent","set","createChild","invokeFunction","fn","args","_i","_trace","Trace","traceInvocation","_done","accessor","get","id","isOptional","result","_getOrCreateServiceInstance","apply","undefined","stop","createInstance","ctorOrDescriptor","rest","traceCreation","ctor","_createInstance","staticArguments","concat","serviceDependencies","getServiceDependencies","sort","index","serviceArgs","serviceDependencies_1","dependency","service","name","push","firstServiceArgPos","console","warn","delta","slice","bind","_setServiceInstance","instance","_getServiceInstanceOrDescriptor","instanceOrDesc","thing","_createAndCacheServiceInstance","branch","desc","data","cycleCount","stack","item","pop","lookupOrInsertNode","_a","insertEdge","roots","isEmpty","_b","roots_1","_createServiceInstanceWithOwner","supportsDelayedInstantiation","removeNode","_createServiceInstance","_supportsDelayedInstantiation","idle_1","target","key","obj","getValue","prop","_target","value","type","_start","Date","now","_dep","_None","substring","replace","first","child","dur","_totals","causedCreation","printChild","n","trace","res","prefix","join","nested","lines","toFixed","log","class_1"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\nimport { illegalState } from '../../../base/common/errors.js';\r\nimport { Graph } from './graph.js';\r\nimport { SyncDescriptor } from './descriptors.js';\r\nimport { IInstantiationService, _util, optional } from './instantiation.js';\r\nimport { ServiceCollection } from './serviceCollection.js';\r\nimport { IdleValue } from '../../../base/common/async.js';\r\n// TRACING\r\nvar _enableTracing = false;\r\nvar _canUseProxy = typeof Proxy === 'function';\r\nvar CyclicDependencyError = /** @class */ (function (_super) {\r\n    __extends(CyclicDependencyError, _super);\r\n    function CyclicDependencyError(graph) {\r\n        var _this = _super.call(this, 'cyclic dependency between services') || this;\r\n        _this.message = graph.toString();\r\n        return _this;\r\n    }\r\n    return CyclicDependencyError;\r\n}(Error));\r\nvar InstantiationService = /** @class */ (function () {\r\n    function InstantiationService(services, strict, parent) {\r\n        if (services === void 0) { services = new ServiceCollection(); }\r\n        if (strict === void 0) { strict = false; }\r\n        this._services = services;\r\n        this._strict = strict;\r\n        this._parent = parent;\r\n        this._services.set(IInstantiationService, this);\r\n    }\r\n    InstantiationService.prototype.createChild = function (services) {\r\n        return new InstantiationService(services, this._strict, this);\r\n    };\r\n    InstantiationService.prototype.invokeFunction = function (fn) {\r\n        var _this = this;\r\n        var args = [];\r\n        for (var _i = 1; _i < arguments.length; _i++) {\r\n            args[_i - 1] = arguments[_i];\r\n        }\r\n        var _trace = Trace.traceInvocation(fn);\r\n        var _done = false;\r\n        try {\r\n            var accessor = {\r\n                get: function (id, isOptional) {\r\n                    if (_done) {\r\n                        throw illegalState('service accessor is only valid during the invocation of its target method');\r\n                    }\r\n                    var result = _this._getOrCreateServiceInstance(id, _trace);\r\n                    if (!result && isOptional !== optional) {\r\n                        throw new Error(\"[invokeFunction] unknown service '\" + id + \"'\");\r\n                    }\r\n                    return result;\r\n                }\r\n            };\r\n            return fn.apply(undefined, __spreadArrays([accessor], args));\r\n        }\r\n        finally {\r\n            _done = true;\r\n            _trace.stop();\r\n        }\r\n    };\r\n    InstantiationService.prototype.createInstance = function (ctorOrDescriptor) {\r\n        var rest = [];\r\n        for (var _i = 1; _i < arguments.length; _i++) {\r\n            rest[_i - 1] = arguments[_i];\r\n        }\r\n        var _trace;\r\n        var result;\r\n        if (ctorOrDescriptor instanceof SyncDescriptor) {\r\n            _trace = Trace.traceCreation(ctorOrDescriptor.ctor);\r\n            result = this._createInstance(ctorOrDescriptor.ctor, ctorOrDescriptor.staticArguments.concat(rest), _trace);\r\n        }\r\n        else {\r\n            _trace = Trace.traceCreation(ctorOrDescriptor);\r\n            result = this._createInstance(ctorOrDescriptor, rest, _trace);\r\n        }\r\n        _trace.stop();\r\n        return result;\r\n    };\r\n    InstantiationService.prototype._createInstance = function (ctor, args, _trace) {\r\n        if (args === void 0) { args = []; }\r\n        // arguments defined by service decorators\r\n        var serviceDependencies = _util.getServiceDependencies(ctor).sort(function (a, b) { return a.index - b.index; });\r\n        var serviceArgs = [];\r\n        for (var _i = 0, serviceDependencies_1 = serviceDependencies; _i < serviceDependencies_1.length; _i++) {\r\n            var dependency = serviceDependencies_1[_i];\r\n            var service = this._getOrCreateServiceInstance(dependency.id, _trace);\r\n            if (!service && this._strict && !dependency.optional) {\r\n                throw new Error(\"[createInstance] \" + ctor.name + \" depends on UNKNOWN service \" + dependency.id + \".\");\r\n            }\r\n            serviceArgs.push(service);\r\n        }\r\n        var firstServiceArgPos = serviceDependencies.length > 0 ? serviceDependencies[0].index : args.length;\r\n        // check for argument mismatches, adjust static args if needed\r\n        if (args.length !== firstServiceArgPos) {\r\n            console.warn(\"[createInstance] First service dependency of \" + ctor.name + \" at position \" + (firstServiceArgPos + 1) + \" conflicts with \" + args.length + \" static arguments\");\r\n            var delta = firstServiceArgPos - args.length;\r\n            if (delta > 0) {\r\n                args = args.concat(new Array(delta));\r\n            }\r\n            else {\r\n                args = args.slice(0, firstServiceArgPos);\r\n            }\r\n        }\r\n        // now create the instance\r\n        return new (ctor.bind.apply(ctor, __spreadArrays([void 0], __spreadArrays(args, serviceArgs))))();\r\n    };\r\n    InstantiationService.prototype._setServiceInstance = function (id, instance) {\r\n        if (this._services.get(id) instanceof SyncDescriptor) {\r\n            this._services.set(id, instance);\r\n        }\r\n        else if (this._parent) {\r\n            this._parent._setServiceInstance(id, instance);\r\n        }\r\n        else {\r\n            throw new Error('illegalState - setting UNKNOWN service instance');\r\n        }\r\n    };\r\n    InstantiationService.prototype._getServiceInstanceOrDescriptor = function (id) {\r\n        var instanceOrDesc = this._services.get(id);\r\n        if (!instanceOrDesc && this._parent) {\r\n            return this._parent._getServiceInstanceOrDescriptor(id);\r\n        }\r\n        else {\r\n            return instanceOrDesc;\r\n        }\r\n    };\r\n    InstantiationService.prototype._getOrCreateServiceInstance = function (id, _trace) {\r\n        var thing = this._getServiceInstanceOrDescriptor(id);\r\n        if (thing instanceof SyncDescriptor) {\r\n            return this._createAndCacheServiceInstance(id, thing, _trace.branch(id, true));\r\n        }\r\n        else {\r\n            _trace.branch(id, false);\r\n            return thing;\r\n        }\r\n    };\r\n    InstantiationService.prototype._createAndCacheServiceInstance = function (id, desc, _trace) {\r\n        var graph = new Graph(function (data) { return data.id.toString(); });\r\n        var cycleCount = 0;\r\n        var stack = [{ id: id, desc: desc, _trace: _trace }];\r\n        while (stack.length) {\r\n            var item = stack.pop();\r\n            graph.lookupOrInsertNode(item);\r\n            // a weak but working heuristic for cycle checks\r\n            if (cycleCount++ > 150) {\r\n                throw new CyclicDependencyError(graph);\r\n            }\r\n            // check all dependencies for existence and if they need to be created first\r\n            for (var _i = 0, _a = _util.getServiceDependencies(item.desc.ctor); _i < _a.length; _i++) {\r\n                var dependency = _a[_i];\r\n                var instanceOrDesc = this._getServiceInstanceOrDescriptor(dependency.id);\r\n                if (!instanceOrDesc && !dependency.optional) {\r\n                    console.warn(\"[createInstance] \" + id + \" depends on \" + dependency.id + \" which is NOT registered.\");\r\n                }\r\n                if (instanceOrDesc instanceof SyncDescriptor) {\r\n                    var d = { id: dependency.id, desc: instanceOrDesc, _trace: item._trace.branch(dependency.id, true) };\r\n                    graph.insertEdge(item, d);\r\n                    stack.push(d);\r\n                }\r\n            }\r\n        }\r\n        while (true) {\r\n            var roots = graph.roots();\r\n            // if there is no more roots but still\r\n            // nodes in the graph we have a cycle\r\n            if (roots.length === 0) {\r\n                if (!graph.isEmpty()) {\r\n                    throw new CyclicDependencyError(graph);\r\n                }\r\n                break;\r\n            }\r\n            for (var _b = 0, roots_1 = roots; _b < roots_1.length; _b++) {\r\n                var data = roots_1[_b].data;\r\n                // create instance and overwrite the service collections\r\n                var instance = this._createServiceInstanceWithOwner(data.id, data.desc.ctor, data.desc.staticArguments, data.desc.supportsDelayedInstantiation, data._trace);\r\n                this._setServiceInstance(data.id, instance);\r\n                graph.removeNode(data);\r\n            }\r\n        }\r\n        return this._getServiceInstanceOrDescriptor(id);\r\n    };\r\n    InstantiationService.prototype._createServiceInstanceWithOwner = function (id, ctor, args, supportsDelayedInstantiation, _trace) {\r\n        if (args === void 0) { args = []; }\r\n        if (this._services.get(id) instanceof SyncDescriptor) {\r\n            return this._createServiceInstance(ctor, args, supportsDelayedInstantiation, _trace);\r\n        }\r\n        else if (this._parent) {\r\n            return this._parent._createServiceInstanceWithOwner(id, ctor, args, supportsDelayedInstantiation, _trace);\r\n        }\r\n        else {\r\n            throw new Error(\"illegalState - creating UNKNOWN service instance \" + ctor.name);\r\n        }\r\n    };\r\n    InstantiationService.prototype._createServiceInstance = function (ctor, args, _supportsDelayedInstantiation, _trace) {\r\n        var _this = this;\r\n        if (args === void 0) { args = []; }\r\n        if (!_supportsDelayedInstantiation || !_canUseProxy) {\r\n            // eager instantiation or no support JS proxies (e.g. IE11)\r\n            return this._createInstance(ctor, args, _trace);\r\n        }\r\n        else {\r\n            // Return a proxy object that's backed by an idle value. That\r\n            // strategy is to instantiate services in our idle time or when actually\r\n            // needed but not when injected into a consumer\r\n            var idle_1 = new IdleValue(function () { return _this._createInstance(ctor, args, _trace); });\r\n            return new Proxy(Object.create(null), {\r\n                get: function (target, key) {\r\n                    if (key in target) {\r\n                        return target[key];\r\n                    }\r\n                    var obj = idle_1.getValue();\r\n                    var prop = obj[key];\r\n                    if (typeof prop !== 'function') {\r\n                        return prop;\r\n                    }\r\n                    prop = prop.bind(obj);\r\n                    target[key] = prop;\r\n                    return prop;\r\n                },\r\n                set: function (_target, p, value) {\r\n                    idle_1.getValue()[p] = value;\r\n                    return true;\r\n                }\r\n            });\r\n        }\r\n    };\r\n    return InstantiationService;\r\n}());\r\nexport { InstantiationService };\r\nvar Trace = /** @class */ (function () {\r\n    function Trace(type, name) {\r\n        this.type = type;\r\n        this.name = name;\r\n        this._start = Date.now();\r\n        this._dep = [];\r\n    }\r\n    Trace.traceInvocation = function (ctor) {\r\n        return !_enableTracing ? Trace._None : new Trace(1 /* Invocation */, ctor.name || ctor.toString().substring(0, 42).replace(/\\n/g, ''));\r\n    };\r\n    Trace.traceCreation = function (ctor) {\r\n        return !_enableTracing ? Trace._None : new Trace(0 /* Creation */, ctor.name);\r\n    };\r\n    Trace.prototype.branch = function (id, first) {\r\n        var child = new Trace(2 /* Branch */, id.toString());\r\n        this._dep.push([id, first, child]);\r\n        return child;\r\n    };\r\n    Trace.prototype.stop = function () {\r\n        var dur = Date.now() - this._start;\r\n        Trace._totals += dur;\r\n        var causedCreation = false;\r\n        function printChild(n, trace) {\r\n            var res = [];\r\n            var prefix = new Array(n + 1).join('\\t');\r\n            for (var _i = 0, _a = trace._dep; _i < _a.length; _i++) {\r\n                var _b = _a[_i], id = _b[0], first = _b[1], child = _b[2];\r\n                if (first && child) {\r\n                    causedCreation = true;\r\n                    res.push(prefix + \"CREATES -> \" + id);\r\n                    var nested = printChild(n + 1, child);\r\n                    if (nested) {\r\n                        res.push(nested);\r\n                    }\r\n                }\r\n                else {\r\n                    res.push(prefix + \"uses -> \" + id);\r\n                }\r\n            }\r\n            return res.join('\\n');\r\n        }\r\n        var lines = [\r\n            (this.type === 0 /* Creation */ ? 'CREATE' : 'CALL') + \" \" + this.name,\r\n            \"\" + printChild(1, this),\r\n            \"DONE, took \" + dur.toFixed(2) + \"ms (grand total \" + Trace._totals.toFixed(2) + \"ms)\"\r\n        ];\r\n        if (dur > 2 || causedCreation) {\r\n            console.log(lines.join('\\n'));\r\n        }\r\n    };\r\n    Trace._None = new /** @class */ (function (_super) {\r\n        __extends(class_1, _super);\r\n        function class_1() {\r\n            return _super.call(this, -1, null) || this;\r\n        }\r\n        class_1.prototype.stop = function () { };\r\n        class_1.prototype.branch = function () { return this; };\r\n        return class_1;\r\n    }(Trace));\r\n    Trace._totals = 0;\r\n    return Trace;\r\n}());\r\n//#endregion\r\n"]},"metadata":{},"sourceType":"module"}