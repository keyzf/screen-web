{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore } from '../../../base/common/lifecycle.js';\nimport * as platform from '../../../base/common/platform.js';\nimport * as errors from '../../../base/common/errors.js';\nimport { EDITOR_MODEL_DEFAULTS } from '../config/editorOptions.js';\nimport { TextModel } from '../model/textModel.js';\nimport { DocumentSemanticTokensProviderRegistry, TokenMetadata } from '../modes.js';\nimport { PLAINTEXT_LANGUAGE_IDENTIFIER } from '../modes/modesRegistry.js';\nimport { ITextResourcePropertiesService } from './textResourceConfigurationService.js';\nimport { IConfigurationService } from '../../../platform/configuration/common/configuration.js';\nimport { RunOnceScheduler } from '../../../base/common/async.js';\nimport { CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { SparseEncodedTokens, MultilineTokens2 } from '../model/tokensStore.js';\nimport { IThemeService } from '../../../platform/theme/common/themeService.js';\nimport { ILogService, LogLevel } from '../../../platform/log/common/log.js';\n\nfunction MODEL_ID(resource) {\n  return resource.toString();\n}\n\nvar ModelData =\n/** @class */\nfunction () {\n  function ModelData(model, onWillDispose, onDidChangeLanguage) {\n    this._modelEventListeners = new DisposableStore();\n    this.model = model;\n    this._languageSelection = null;\n    this._languageSelectionListener = null;\n\n    this._modelEventListeners.add(model.onWillDispose(function () {\n      return onWillDispose(model);\n    }));\n\n    this._modelEventListeners.add(model.onDidChangeLanguage(function (e) {\n      return onDidChangeLanguage(model, e);\n    }));\n  }\n\n  ModelData.prototype._disposeLanguageSelection = function () {\n    if (this._languageSelectionListener) {\n      this._languageSelectionListener.dispose();\n\n      this._languageSelectionListener = null;\n    }\n\n    if (this._languageSelection) {\n      this._languageSelection.dispose();\n\n      this._languageSelection = null;\n    }\n  };\n\n  ModelData.prototype.dispose = function () {\n    this._modelEventListeners.dispose();\n\n    this._disposeLanguageSelection();\n  };\n\n  ModelData.prototype.setLanguage = function (languageSelection) {\n    var _this = this;\n\n    this._disposeLanguageSelection();\n\n    this._languageSelection = languageSelection;\n    this._languageSelectionListener = this._languageSelection.onDidChange(function () {\n      return _this.model.setMode(languageSelection.languageIdentifier);\n    });\n    this.model.setMode(languageSelection.languageIdentifier);\n  };\n\n  return ModelData;\n}();\n\nvar DEFAULT_EOL = platform.isLinux || platform.isMacintosh ? 1\n/* LF */\n: 2\n/* CRLF */\n;\n\nvar ModelServiceImpl =\n/** @class */\nfunction (_super) {\n  __extends(ModelServiceImpl, _super);\n\n  function ModelServiceImpl(configurationService, resourcePropertiesService, themeService, logService) {\n    var _this = _super.call(this) || this;\n\n    _this._onModelAdded = _this._register(new Emitter());\n    _this.onModelAdded = _this._onModelAdded.event;\n    _this._onModelRemoved = _this._register(new Emitter());\n    _this.onModelRemoved = _this._onModelRemoved.event;\n    _this._onModelModeChanged = _this._register(new Emitter());\n    _this.onModelModeChanged = _this._onModelModeChanged.event;\n    _this._configurationService = configurationService;\n    _this._resourcePropertiesService = resourcePropertiesService;\n    _this._models = {};\n    _this._modelCreationOptionsByLanguageAndResource = Object.create(null);\n    _this._configurationServiceSubscription = _this._configurationService.onDidChangeConfiguration(function (e) {\n      return _this._updateModelOptions();\n    });\n\n    _this._updateModelOptions();\n\n    _this._register(new SemanticColoringFeature(_this, themeService, configurationService, logService));\n\n    return _this;\n  }\n\n  ModelServiceImpl._readModelOptions = function (config, isForSimpleWidget) {\n    var tabSize = EDITOR_MODEL_DEFAULTS.tabSize;\n\n    if (config.editor && typeof config.editor.tabSize !== 'undefined') {\n      var parsedTabSize = parseInt(config.editor.tabSize, 10);\n\n      if (!isNaN(parsedTabSize)) {\n        tabSize = parsedTabSize;\n      }\n\n      if (tabSize < 1) {\n        tabSize = 1;\n      }\n    }\n\n    var indentSize = tabSize;\n\n    if (config.editor && typeof config.editor.indentSize !== 'undefined' && config.editor.indentSize !== 'tabSize') {\n      var parsedIndentSize = parseInt(config.editor.indentSize, 10);\n\n      if (!isNaN(parsedIndentSize)) {\n        indentSize = parsedIndentSize;\n      }\n\n      if (indentSize < 1) {\n        indentSize = 1;\n      }\n    }\n\n    var insertSpaces = EDITOR_MODEL_DEFAULTS.insertSpaces;\n\n    if (config.editor && typeof config.editor.insertSpaces !== 'undefined') {\n      insertSpaces = config.editor.insertSpaces === 'false' ? false : Boolean(config.editor.insertSpaces);\n    }\n\n    var newDefaultEOL = DEFAULT_EOL;\n    var eol = config.eol;\n\n    if (eol === '\\r\\n') {\n      newDefaultEOL = 2\n      /* CRLF */\n      ;\n    } else if (eol === '\\n') {\n      newDefaultEOL = 1\n      /* LF */\n      ;\n    }\n\n    var trimAutoWhitespace = EDITOR_MODEL_DEFAULTS.trimAutoWhitespace;\n\n    if (config.editor && typeof config.editor.trimAutoWhitespace !== 'undefined') {\n      trimAutoWhitespace = config.editor.trimAutoWhitespace === 'false' ? false : Boolean(config.editor.trimAutoWhitespace);\n    }\n\n    var detectIndentation = EDITOR_MODEL_DEFAULTS.detectIndentation;\n\n    if (config.editor && typeof config.editor.detectIndentation !== 'undefined') {\n      detectIndentation = config.editor.detectIndentation === 'false' ? false : Boolean(config.editor.detectIndentation);\n    }\n\n    var largeFileOptimizations = EDITOR_MODEL_DEFAULTS.largeFileOptimizations;\n\n    if (config.editor && typeof config.editor.largeFileOptimizations !== 'undefined') {\n      largeFileOptimizations = config.editor.largeFileOptimizations === 'false' ? false : Boolean(config.editor.largeFileOptimizations);\n    }\n\n    return {\n      isForSimpleWidget: isForSimpleWidget,\n      tabSize: tabSize,\n      indentSize: indentSize,\n      insertSpaces: insertSpaces,\n      detectIndentation: detectIndentation,\n      defaultEOL: newDefaultEOL,\n      trimAutoWhitespace: trimAutoWhitespace,\n      largeFileOptimizations: largeFileOptimizations\n    };\n  };\n\n  ModelServiceImpl.prototype.getCreationOptions = function (language, resource, isForSimpleWidget) {\n    var creationOptions = this._modelCreationOptionsByLanguageAndResource[language + resource];\n\n    if (!creationOptions) {\n      var editor = this._configurationService.getValue('editor', {\n        overrideIdentifier: language,\n        resource: resource\n      });\n\n      var eol = this._resourcePropertiesService.getEOL(resource, language);\n\n      creationOptions = ModelServiceImpl._readModelOptions({\n        editor: editor,\n        eol: eol\n      }, isForSimpleWidget);\n      this._modelCreationOptionsByLanguageAndResource[language + resource] = creationOptions;\n    }\n\n    return creationOptions;\n  };\n\n  ModelServiceImpl.prototype._updateModelOptions = function () {\n    var oldOptionsByLanguageAndResource = this._modelCreationOptionsByLanguageAndResource;\n    this._modelCreationOptionsByLanguageAndResource = Object.create(null); // Update options on all models\n\n    var keys = Object.keys(this._models);\n\n    for (var i = 0, len = keys.length; i < len; i++) {\n      var modelId = keys[i];\n      var modelData = this._models[modelId];\n      var language = modelData.model.getLanguageIdentifier().language;\n      var uri = modelData.model.uri;\n      var oldOptions = oldOptionsByLanguageAndResource[language + uri];\n      var newOptions = this.getCreationOptions(language, uri, modelData.model.isForSimpleWidget);\n\n      ModelServiceImpl._setModelOptionsForModel(modelData.model, newOptions, oldOptions);\n    }\n  };\n\n  ModelServiceImpl._setModelOptionsForModel = function (model, newOptions, currentOptions) {\n    if (currentOptions && currentOptions.defaultEOL !== newOptions.defaultEOL && model.getLineCount() === 1) {\n      model.setEOL(newOptions.defaultEOL === 1\n      /* LF */\n      ? 0\n      /* LF */\n      : 1\n      /* CRLF */\n      );\n    }\n\n    if (currentOptions && currentOptions.detectIndentation === newOptions.detectIndentation && currentOptions.insertSpaces === newOptions.insertSpaces && currentOptions.tabSize === newOptions.tabSize && currentOptions.indentSize === newOptions.indentSize && currentOptions.trimAutoWhitespace === newOptions.trimAutoWhitespace) {\n      // Same indent opts, no need to touch the model\n      return;\n    }\n\n    if (newOptions.detectIndentation) {\n      model.detectIndentation(newOptions.insertSpaces, newOptions.tabSize);\n      model.updateOptions({\n        trimAutoWhitespace: newOptions.trimAutoWhitespace\n      });\n    } else {\n      model.updateOptions({\n        insertSpaces: newOptions.insertSpaces,\n        tabSize: newOptions.tabSize,\n        indentSize: newOptions.indentSize,\n        trimAutoWhitespace: newOptions.trimAutoWhitespace\n      });\n    }\n  };\n\n  ModelServiceImpl.prototype.dispose = function () {\n    this._configurationServiceSubscription.dispose();\n\n    _super.prototype.dispose.call(this);\n  }; // --- begin IModelService\n\n\n  ModelServiceImpl.prototype._createModelData = function (value, languageIdentifier, resource, isForSimpleWidget) {\n    var _this = this; // create & save the model\n\n\n    var options = this.getCreationOptions(languageIdentifier.language, resource, isForSimpleWidget);\n    var model = new TextModel(value, options, languageIdentifier, resource);\n    var modelId = MODEL_ID(model.uri);\n\n    if (this._models[modelId]) {\n      // There already exists a model with this id => this is a programmer error\n      throw new Error('ModelService: Cannot add model because it already exists!');\n    }\n\n    var modelData = new ModelData(model, function (model) {\n      return _this._onWillDispose(model);\n    }, function (model, e) {\n      return _this._onDidChangeLanguage(model, e);\n    });\n    this._models[modelId] = modelData;\n    return modelData;\n  };\n\n  ModelServiceImpl.prototype.createModel = function (value, languageSelection, resource, isForSimpleWidget) {\n    if (isForSimpleWidget === void 0) {\n      isForSimpleWidget = false;\n    }\n\n    var modelData;\n\n    if (languageSelection) {\n      modelData = this._createModelData(value, languageSelection.languageIdentifier, resource, isForSimpleWidget);\n      this.setMode(modelData.model, languageSelection);\n    } else {\n      modelData = this._createModelData(value, PLAINTEXT_LANGUAGE_IDENTIFIER, resource, isForSimpleWidget);\n    }\n\n    this._onModelAdded.fire(modelData.model);\n\n    return modelData.model;\n  };\n\n  ModelServiceImpl.prototype.setMode = function (model, languageSelection) {\n    if (!languageSelection) {\n      return;\n    }\n\n    var modelData = this._models[MODEL_ID(model.uri)];\n\n    if (!modelData) {\n      return;\n    }\n\n    modelData.setLanguage(languageSelection);\n  };\n\n  ModelServiceImpl.prototype.getModels = function () {\n    var ret = [];\n    var keys = Object.keys(this._models);\n\n    for (var i = 0, len = keys.length; i < len; i++) {\n      var modelId = keys[i];\n      ret.push(this._models[modelId].model);\n    }\n\n    return ret;\n  };\n\n  ModelServiceImpl.prototype.getModel = function (resource) {\n    var modelId = MODEL_ID(resource);\n    var modelData = this._models[modelId];\n\n    if (!modelData) {\n      return null;\n    }\n\n    return modelData.model;\n  }; // --- end IModelService\n\n\n  ModelServiceImpl.prototype._onWillDispose = function (model) {\n    var modelId = MODEL_ID(model.uri);\n    var modelData = this._models[modelId];\n    delete this._models[modelId];\n    modelData.dispose(); // clean up cache\n\n    delete this._modelCreationOptionsByLanguageAndResource[model.getLanguageIdentifier().language + model.uri];\n\n    this._onModelRemoved.fire(model);\n  };\n\n  ModelServiceImpl.prototype._onDidChangeLanguage = function (model, e) {\n    var oldModeId = e.oldLanguage;\n    var newModeId = model.getLanguageIdentifier().language;\n    var oldOptions = this.getCreationOptions(oldModeId, model.uri, model.isForSimpleWidget);\n    var newOptions = this.getCreationOptions(newModeId, model.uri, model.isForSimpleWidget);\n\n    ModelServiceImpl._setModelOptionsForModel(model, newOptions, oldOptions);\n\n    this._onModelModeChanged.fire({\n      model: model,\n      oldModeId: oldModeId\n    });\n  };\n\n  ModelServiceImpl = __decorate([__param(0, IConfigurationService), __param(1, ITextResourcePropertiesService), __param(2, IThemeService), __param(3, ILogService)], ModelServiceImpl);\n  return ModelServiceImpl;\n}(Disposable);\n\nexport { ModelServiceImpl };\n\nvar SemanticColoringFeature =\n/** @class */\nfunction (_super) {\n  __extends(SemanticColoringFeature, _super);\n\n  function SemanticColoringFeature(modelService, themeService, configurationService, logService) {\n    var _this = _super.call(this) || this;\n\n    _this._configurationService = configurationService;\n    _this._watchers = Object.create(null);\n    _this._semanticStyling = _this._register(new SemanticStyling(themeService, logService));\n\n    var isSemanticColoringEnabled = function (model) {\n      var options = configurationService.getValue(SemanticColoringFeature.SETTING_ID, {\n        overrideIdentifier: model.getLanguageIdentifier().language,\n        resource: model.uri\n      });\n      return options && options.enabled;\n    };\n\n    var register = function (model) {\n      _this._watchers[model.uri.toString()] = new ModelSemanticColoring(model, themeService, _this._semanticStyling);\n    };\n\n    var deregister = function (model, modelSemanticColoring) {\n      modelSemanticColoring.dispose();\n      delete _this._watchers[model.uri.toString()];\n    };\n\n    _this._register(modelService.onModelAdded(function (model) {\n      if (isSemanticColoringEnabled(model)) {\n        register(model);\n      }\n    }));\n\n    _this._register(modelService.onModelRemoved(function (model) {\n      var curr = _this._watchers[model.uri.toString()];\n\n      if (curr) {\n        deregister(model, curr);\n      }\n    }));\n\n    _this._configurationService.onDidChangeConfiguration(function (e) {\n      if (e.affectsConfiguration(SemanticColoringFeature.SETTING_ID)) {\n        for (var _i = 0, _a = modelService.getModels(); _i < _a.length; _i++) {\n          var model = _a[_i];\n\n          var curr = _this._watchers[model.uri.toString()];\n\n          if (isSemanticColoringEnabled(model)) {\n            if (!curr) {\n              register(model);\n            }\n          } else {\n            if (curr) {\n              deregister(model, curr);\n            }\n          }\n        }\n      }\n    });\n\n    return _this;\n  }\n\n  SemanticColoringFeature.SETTING_ID = 'editor.semanticHighlighting';\n  return SemanticColoringFeature;\n}(Disposable);\n\nvar SemanticStyling =\n/** @class */\nfunction (_super) {\n  __extends(SemanticStyling, _super);\n\n  function SemanticStyling(_themeService, _logService) {\n    var _this = _super.call(this) || this;\n\n    _this._themeService = _themeService;\n    _this._logService = _logService;\n    _this._caches = new WeakMap();\n\n    if (_this._themeService) {\n      // workaround for tests which use undefined... :/\n      _this._register(_this._themeService.onThemeChange(function () {\n        _this._caches = new WeakMap();\n      }));\n    }\n\n    return _this;\n  }\n\n  SemanticStyling.prototype.get = function (provider) {\n    if (!this._caches.has(provider)) {\n      this._caches.set(provider, new SemanticColoringProviderStyling(provider.getLegend(), this._themeService, this._logService));\n    }\n\n    return this._caches.get(provider);\n  };\n\n  return SemanticStyling;\n}(Disposable);\n\nvar HashTableEntry =\n/** @class */\nfunction () {\n  function HashTableEntry(tokenTypeIndex, tokenModifierSet, metadata) {\n    this.tokenTypeIndex = tokenTypeIndex;\n    this.tokenModifierSet = tokenModifierSet;\n    this.metadata = metadata;\n    this.next = null;\n  }\n\n  return HashTableEntry;\n}();\n\nvar HashTable =\n/** @class */\nfunction () {\n  function HashTable() {\n    this._elementsCount = 0;\n    this._currentLengthIndex = 0;\n    this._currentLength = HashTable._SIZES[this._currentLengthIndex];\n    this._growCount = Math.round(this._currentLengthIndex + 1 < HashTable._SIZES.length ? 2 / 3 * this._currentLength : 0);\n    this._elements = [];\n\n    HashTable._nullOutEntries(this._elements, this._currentLength);\n  }\n\n  HashTable._nullOutEntries = function (entries, length) {\n    for (var i = 0; i < length; i++) {\n      entries[i] = null;\n    }\n  };\n\n  HashTable.prototype._hashFunc = function (tokenTypeIndex, tokenModifierSet) {\n    return ((tokenTypeIndex << 5) - tokenTypeIndex + tokenModifierSet | 0) % this._currentLength; // tokenTypeIndex * 31 + tokenModifierSet, keep as int32\n  };\n\n  HashTable.prototype.get = function (tokenTypeIndex, tokenModifierSet) {\n    var hash = this._hashFunc(tokenTypeIndex, tokenModifierSet);\n\n    var p = this._elements[hash];\n\n    while (p) {\n      if (p.tokenTypeIndex === tokenTypeIndex && p.tokenModifierSet === tokenModifierSet) {\n        return p;\n      }\n\n      p = p.next;\n    }\n\n    return null;\n  };\n\n  HashTable.prototype.add = function (tokenTypeIndex, tokenModifierSet, metadata) {\n    this._elementsCount++;\n\n    if (this._growCount !== 0 && this._elementsCount >= this._growCount) {\n      // expand!\n      var oldElements = this._elements;\n      this._currentLengthIndex++;\n      this._currentLength = HashTable._SIZES[this._currentLengthIndex];\n      this._growCount = Math.round(this._currentLengthIndex + 1 < HashTable._SIZES.length ? 2 / 3 * this._currentLength : 0);\n      this._elements = [];\n\n      HashTable._nullOutEntries(this._elements, this._currentLength);\n\n      for (var _i = 0, oldElements_1 = oldElements; _i < oldElements_1.length; _i++) {\n        var first = oldElements_1[_i];\n        var p = first;\n\n        while (p) {\n          var oldNext = p.next;\n          p.next = null;\n\n          this._add(p);\n\n          p = oldNext;\n        }\n      }\n    }\n\n    this._add(new HashTableEntry(tokenTypeIndex, tokenModifierSet, metadata));\n  };\n\n  HashTable.prototype._add = function (element) {\n    var hash = this._hashFunc(element.tokenTypeIndex, element.tokenModifierSet);\n\n    element.next = this._elements[hash];\n    this._elements[hash] = element;\n  };\n\n  HashTable._SIZES = [3, 7, 13, 31, 61, 127, 251, 509, 1021, 2039, 4093, 8191, 16381, 32749, 65521, 131071, 262139, 524287, 1048573, 2097143];\n  return HashTable;\n}();\n\nvar SemanticColoringProviderStyling =\n/** @class */\nfunction () {\n  function SemanticColoringProviderStyling(_legend, _themeService, _logService) {\n    this._legend = _legend;\n    this._themeService = _themeService;\n    this._logService = _logService;\n    this._hashTable = new HashTable();\n  }\n\n  SemanticColoringProviderStyling.prototype.getMetadata = function (tokenTypeIndex, tokenModifierSet) {\n    var entry = this._hashTable.get(tokenTypeIndex, tokenModifierSet);\n\n    var metadata;\n\n    if (entry) {\n      metadata = entry.metadata;\n    } else {\n      var tokenType = this._legend.tokenTypes[tokenTypeIndex];\n      var tokenModifiers = [];\n      var modifierSet = tokenModifierSet;\n\n      for (var modifierIndex = 0; modifierSet > 0 && modifierIndex < this._legend.tokenModifiers.length; modifierIndex++) {\n        if (modifierSet & 1) {\n          tokenModifiers.push(this._legend.tokenModifiers[modifierIndex]);\n        }\n\n        modifierSet = modifierSet >> 1;\n      }\n\n      var tokenStyle = this._themeService.getTheme().getTokenStyleMetadata(tokenType, tokenModifiers);\n\n      if (typeof tokenStyle === 'undefined') {\n        metadata = 2147483647\n        /* NO_STYLING */\n        ;\n      } else {\n        metadata = 0;\n\n        if (typeof tokenStyle.italic !== 'undefined') {\n          var italicBit = (tokenStyle.italic ? 1\n          /* Italic */\n          : 0) << 11\n          /* FONT_STYLE_OFFSET */\n          ;\n          metadata |= italicBit | 1\n          /* SEMANTIC_USE_ITALIC */\n          ;\n        }\n\n        if (typeof tokenStyle.bold !== 'undefined') {\n          var boldBit = (tokenStyle.bold ? 2\n          /* Bold */\n          : 0) << 11\n          /* FONT_STYLE_OFFSET */\n          ;\n          metadata |= boldBit | 2\n          /* SEMANTIC_USE_BOLD */\n          ;\n        }\n\n        if (typeof tokenStyle.underline !== 'undefined') {\n          var underlineBit = (tokenStyle.underline ? 4\n          /* Underline */\n          : 0) << 11\n          /* FONT_STYLE_OFFSET */\n          ;\n          metadata |= underlineBit | 4\n          /* SEMANTIC_USE_UNDERLINE */\n          ;\n        }\n\n        if (tokenStyle.foreground) {\n          var foregroundBits = tokenStyle.foreground << 14\n          /* FOREGROUND_OFFSET */\n          ;\n          metadata |= foregroundBits | 8\n          /* SEMANTIC_USE_FOREGROUND */\n          ;\n        }\n\n        if (metadata === 0) {\n          // Nothing!\n          metadata = 2147483647\n          /* NO_STYLING */\n          ;\n        }\n      }\n\n      this._hashTable.add(tokenTypeIndex, tokenModifierSet, metadata);\n    }\n\n    if (this._logService.getLevel() === LogLevel.Trace) {\n      var type = this._legend.tokenTypes[tokenTypeIndex];\n      var modifiers = tokenModifierSet ? ' ' + this._legend.tokenModifiers.filter(function (_, i) {\n        return tokenModifierSet & 1 << i;\n      }).join(' ') : '';\n\n      this._logService.trace(\"tokenStyleMetadata \" + (entry ? '[CACHED] ' : '') + type + modifiers + \": foreground \" + TokenMetadata.getForeground(metadata) + \", fontStyle \" + TokenMetadata.getFontStyle(metadata).toString(2));\n    }\n\n    return metadata;\n  };\n\n  return SemanticColoringProviderStyling;\n}();\n\nvar SemanticTokensResponse =\n/** @class */\nfunction () {\n  function SemanticTokensResponse(_provider, resultId, data) {\n    this._provider = _provider;\n    this.resultId = resultId;\n    this.data = data;\n  }\n\n  SemanticTokensResponse.prototype.dispose = function () {\n    this._provider.releaseDocumentSemanticTokens(this.resultId);\n  };\n\n  return SemanticTokensResponse;\n}();\n\nvar ModelSemanticColoring =\n/** @class */\nfunction (_super) {\n  __extends(ModelSemanticColoring, _super);\n\n  function ModelSemanticColoring(model, themeService, stylingProvider) {\n    var _this = _super.call(this) || this;\n\n    _this._isDisposed = false;\n    _this._model = model;\n    _this._semanticStyling = stylingProvider;\n    _this._fetchSemanticTokens = _this._register(new RunOnceScheduler(function () {\n      return _this._fetchSemanticTokensNow();\n    }, 300));\n    _this._currentResponse = null;\n    _this._currentRequestCancellationTokenSource = null;\n\n    _this._register(_this._model.onDidChangeContent(function (e) {\n      if (!_this._fetchSemanticTokens.isScheduled()) {\n        _this._fetchSemanticTokens.schedule();\n      }\n    }));\n\n    _this._register(DocumentSemanticTokensProviderRegistry.onDidChange(function (e) {\n      return _this._fetchSemanticTokens.schedule();\n    }));\n\n    if (themeService) {\n      // workaround for tests which use undefined... :/\n      _this._register(themeService.onThemeChange(function (_) {\n        // clear out existing tokens\n        _this._setSemanticTokens(null, null, null, []);\n\n        _this._fetchSemanticTokens.schedule();\n      }));\n    }\n\n    _this._fetchSemanticTokens.schedule(0);\n\n    return _this;\n  }\n\n  ModelSemanticColoring.prototype.dispose = function () {\n    if (this._currentResponse) {\n      this._currentResponse.dispose();\n\n      this._currentResponse = null;\n    }\n\n    if (this._currentRequestCancellationTokenSource) {\n      this._currentRequestCancellationTokenSource.cancel();\n\n      this._currentRequestCancellationTokenSource = null;\n    }\n\n    this._setSemanticTokens(null, null, null, []);\n\n    this._isDisposed = true;\n\n    _super.prototype.dispose.call(this);\n  };\n\n  ModelSemanticColoring.prototype._fetchSemanticTokensNow = function () {\n    var _this = this;\n\n    if (this._currentRequestCancellationTokenSource) {\n      // there is already a request running, let it finish...\n      return;\n    }\n\n    var provider = this._getSemanticColoringProvider();\n\n    if (!provider) {\n      return;\n    }\n\n    this._currentRequestCancellationTokenSource = new CancellationTokenSource();\n    var pendingChanges = [];\n\n    var contentChangeListener = this._model.onDidChangeContent(function (e) {\n      pendingChanges.push(e);\n    });\n\n    var styling = this._semanticStyling.get(provider);\n\n    var lastResultId = this._currentResponse ? this._currentResponse.resultId || null : null;\n    var request = Promise.resolve(provider.provideDocumentSemanticTokens(this._model, lastResultId, this._currentRequestCancellationTokenSource.token));\n    request.then(function (res) {\n      _this._currentRequestCancellationTokenSource = null;\n      contentChangeListener.dispose();\n\n      _this._setSemanticTokens(provider, res || null, styling, pendingChanges);\n    }, function (err) {\n      if (!err || typeof err.message !== 'string' || err.message.indexOf('busy') === -1) {\n        errors.onUnexpectedError(err);\n      } // Semantic tokens eats up all errors and considers errors to mean that the result is temporarily not available\n      // The API does not have a special error kind to express this...\n\n\n      _this._currentRequestCancellationTokenSource = null;\n      contentChangeListener.dispose();\n\n      if (pendingChanges.length > 0) {\n        // More changes occurred while the request was running\n        if (!_this._fetchSemanticTokens.isScheduled()) {\n          _this._fetchSemanticTokens.schedule();\n        }\n      }\n    });\n  };\n\n  ModelSemanticColoring._isSemanticTokens = function (v) {\n    return v && !!v.data;\n  };\n\n  ModelSemanticColoring._isSemanticTokensEdits = function (v) {\n    return v && Array.isArray(v.edits);\n  };\n\n  ModelSemanticColoring._copy = function (src, srcOffset, dest, destOffset, length) {\n    for (var i = 0; i < length; i++) {\n      dest[destOffset + i] = src[srcOffset + i];\n    }\n  };\n\n  ModelSemanticColoring.prototype._setSemanticTokens = function (provider, tokens, styling, pendingChanges) {\n    var currentResponse = this._currentResponse;\n\n    if (this._currentResponse) {\n      this._currentResponse.dispose();\n\n      this._currentResponse = null;\n    }\n\n    if (this._isDisposed) {\n      // disposed!\n      if (provider && tokens) {\n        provider.releaseDocumentSemanticTokens(tokens.resultId);\n      }\n\n      return;\n    }\n\n    if (!provider || !tokens || !styling) {\n      this._model.setSemanticTokens(null);\n\n      return;\n    }\n\n    if (ModelSemanticColoring._isSemanticTokensEdits(tokens)) {\n      if (!currentResponse) {\n        // not possible!\n        this._model.setSemanticTokens(null);\n\n        return;\n      }\n\n      if (tokens.edits.length === 0) {\n        // nothing to do!\n        tokens = {\n          resultId: tokens.resultId,\n          data: currentResponse.data\n        };\n      } else {\n        var deltaLength = 0;\n\n        for (var _i = 0, _a = tokens.edits; _i < _a.length; _i++) {\n          var edit = _a[_i];\n          deltaLength += (edit.data ? edit.data.length : 0) - edit.deleteCount;\n        }\n\n        var srcData = currentResponse.data;\n        var destData = new Uint32Array(srcData.length + deltaLength);\n        var srcLastStart = srcData.length;\n        var destLastStart = destData.length;\n\n        for (var i = tokens.edits.length - 1; i >= 0; i--) {\n          var edit = tokens.edits[i];\n          var copyCount = srcLastStart - (edit.start + edit.deleteCount);\n\n          if (copyCount > 0) {\n            ModelSemanticColoring._copy(srcData, srcLastStart - copyCount, destData, destLastStart - copyCount, copyCount);\n\n            destLastStart -= copyCount;\n          }\n\n          if (edit.data) {\n            ModelSemanticColoring._copy(edit.data, 0, destData, destLastStart - edit.data.length, edit.data.length);\n\n            destLastStart -= edit.data.length;\n          }\n\n          srcLastStart = edit.start;\n        }\n\n        if (srcLastStart > 0) {\n          ModelSemanticColoring._copy(srcData, 0, destData, 0, srcLastStart);\n        }\n\n        tokens = {\n          resultId: tokens.resultId,\n          data: destData\n        };\n      }\n    }\n\n    if (ModelSemanticColoring._isSemanticTokens(tokens)) {\n      this._currentResponse = new SemanticTokensResponse(provider, tokens.resultId, tokens.data);\n      var srcData = tokens.data;\n      var tokenCount = tokens.data.length / 5 | 0;\n      var tokensPerArea = Math.max(Math.ceil(tokenCount / 1024\n      /* DesiredMaxAreas */\n      ), 400\n      /* DesiredTokensPerArea */\n      );\n      var result = [];\n      var tokenIndex = 0;\n      var lastLineNumber = 1;\n      var lastStartCharacter = 0;\n\n      while (tokenIndex < tokenCount) {\n        var tokenStartIndex = tokenIndex;\n        var tokenEndIndex = Math.min(tokenStartIndex + tokensPerArea, tokenCount); // Keep tokens on the same line in the same area...\n\n        if (tokenEndIndex < tokenCount) {\n          var smallTokenEndIndex = tokenEndIndex;\n\n          while (smallTokenEndIndex - 1 > tokenStartIndex && srcData[5 * smallTokenEndIndex] === 0) {\n            smallTokenEndIndex--;\n          }\n\n          if (smallTokenEndIndex - 1 === tokenStartIndex) {\n            // there are so many tokens on this line that our area would be empty, we must now go right\n            var bigTokenEndIndex = tokenEndIndex;\n\n            while (bigTokenEndIndex + 1 < tokenCount && srcData[5 * bigTokenEndIndex] === 0) {\n              bigTokenEndIndex++;\n            }\n\n            tokenEndIndex = bigTokenEndIndex;\n          } else {\n            tokenEndIndex = smallTokenEndIndex;\n          }\n        }\n\n        var destData = new Uint32Array((tokenEndIndex - tokenStartIndex) * 4);\n        var destOffset = 0;\n        var areaLine = 0;\n\n        while (tokenIndex < tokenEndIndex) {\n          var srcOffset = 5 * tokenIndex;\n          var deltaLine = srcData[srcOffset];\n          var deltaCharacter = srcData[srcOffset + 1];\n          var lineNumber = lastLineNumber + deltaLine;\n          var startCharacter = deltaLine === 0 ? lastStartCharacter + deltaCharacter : deltaCharacter;\n          var length_1 = srcData[srcOffset + 2];\n          var tokenTypeIndex = srcData[srcOffset + 3];\n          var tokenModifierSet = srcData[srcOffset + 4];\n          var metadata = styling.getMetadata(tokenTypeIndex, tokenModifierSet);\n\n          if (metadata !== 2147483647\n          /* NO_STYLING */\n          ) {\n              if (areaLine === 0) {\n                areaLine = lineNumber;\n              }\n\n              destData[destOffset] = lineNumber - areaLine;\n              destData[destOffset + 1] = startCharacter;\n              destData[destOffset + 2] = startCharacter + length_1;\n              destData[destOffset + 3] = metadata;\n              destOffset += 4;\n            }\n\n          lastLineNumber = lineNumber;\n          lastStartCharacter = startCharacter;\n          tokenIndex++;\n        }\n\n        if (destOffset !== destData.length) {\n          destData = destData.subarray(0, destOffset);\n        }\n\n        var tokens_1 = new MultilineTokens2(areaLine, new SparseEncodedTokens(destData));\n        result.push(tokens_1);\n      } // Adjust incoming semantic tokens\n\n\n      if (pendingChanges.length > 0) {\n        // More changes occurred while the request was running\n        // We need to:\n        // 1. Adjust incoming semantic tokens\n        // 2. Request them again\n        for (var _b = 0, pendingChanges_1 = pendingChanges; _b < pendingChanges_1.length; _b++) {\n          var change = pendingChanges_1[_b];\n\n          for (var _c = 0, result_1 = result; _c < result_1.length; _c++) {\n            var area = result_1[_c];\n\n            for (var _d = 0, _e = change.changes; _d < _e.length; _d++) {\n              var singleChange = _e[_d];\n              area.applyEdit(singleChange.range, singleChange.text);\n            }\n          }\n        }\n\n        if (!this._fetchSemanticTokens.isScheduled()) {\n          this._fetchSemanticTokens.schedule();\n        }\n      }\n\n      this._model.setSemanticTokens(result);\n\n      return;\n    }\n\n    this._model.setSemanticTokens(null);\n  };\n\n  ModelSemanticColoring.prototype._getSemanticColoringProvider = function () {\n    var result = DocumentSemanticTokensProviderRegistry.ordered(this._model);\n    return result.length > 0 ? result[0] : null;\n  };\n\n  return ModelSemanticColoring;\n}(Disposable);","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/editor/common/services/modelServiceImpl.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__decorate","decorators","target","key","desc","c","arguments","length","r","getOwnPropertyDescriptor","Reflect","decorate","i","defineProperty","__param","paramIndex","decorator","Emitter","Disposable","DisposableStore","platform","errors","EDITOR_MODEL_DEFAULTS","TextModel","DocumentSemanticTokensProviderRegistry","TokenMetadata","PLAINTEXT_LANGUAGE_IDENTIFIER","ITextResourcePropertiesService","IConfigurationService","RunOnceScheduler","CancellationTokenSource","SparseEncodedTokens","MultilineTokens2","IThemeService","ILogService","LogLevel","MODEL_ID","resource","toString","ModelData","model","onWillDispose","onDidChangeLanguage","_modelEventListeners","_languageSelection","_languageSelectionListener","add","e","_disposeLanguageSelection","dispose","setLanguage","languageSelection","_this","onDidChange","setMode","languageIdentifier","DEFAULT_EOL","isLinux","isMacintosh","ModelServiceImpl","_super","configurationService","resourcePropertiesService","themeService","logService","call","_onModelAdded","_register","onModelAdded","event","_onModelRemoved","onModelRemoved","_onModelModeChanged","onModelModeChanged","_configurationService","_resourcePropertiesService","_models","_modelCreationOptionsByLanguageAndResource","_configurationServiceSubscription","onDidChangeConfiguration","_updateModelOptions","SemanticColoringFeature","_readModelOptions","config","isForSimpleWidget","tabSize","editor","parsedTabSize","parseInt","isNaN","indentSize","parsedIndentSize","insertSpaces","Boolean","newDefaultEOL","eol","trimAutoWhitespace","detectIndentation","largeFileOptimizations","defaultEOL","getCreationOptions","language","creationOptions","getValue","overrideIdentifier","getEOL","oldOptionsByLanguageAndResource","keys","len","modelId","modelData","getLanguageIdentifier","uri","oldOptions","newOptions","_setModelOptionsForModel","currentOptions","getLineCount","setEOL","updateOptions","_createModelData","value","options","Error","_onWillDispose","_onDidChangeLanguage","createModel","fire","getModels","ret","push","getModel","oldModeId","oldLanguage","newModeId","modelService","_watchers","_semanticStyling","SemanticStyling","isSemanticColoringEnabled","SETTING_ID","enabled","register","ModelSemanticColoring","deregister","modelSemanticColoring","curr","affectsConfiguration","_i","_a","_themeService","_logService","_caches","WeakMap","onThemeChange","get","provider","has","set","SemanticColoringProviderStyling","getLegend","HashTableEntry","tokenTypeIndex","tokenModifierSet","metadata","next","HashTable","_elementsCount","_currentLengthIndex","_currentLength","_SIZES","_growCount","Math","round","_elements","_nullOutEntries","entries","_hashFunc","hash","oldElements","oldElements_1","first","oldNext","_add","element","_legend","_hashTable","getMetadata","entry","tokenType","tokenTypes","tokenModifiers","modifierSet","modifierIndex","tokenStyle","getTheme","getTokenStyleMetadata","italic","italicBit","bold","boldBit","underline","underlineBit","foreground","foregroundBits","getLevel","Trace","type","modifiers","filter","_","join","trace","getForeground","getFontStyle","SemanticTokensResponse","_provider","resultId","data","releaseDocumentSemanticTokens","stylingProvider","_isDisposed","_model","_fetchSemanticTokens","_fetchSemanticTokensNow","_currentResponse","_currentRequestCancellationTokenSource","onDidChangeContent","isScheduled","schedule","_setSemanticTokens","cancel","_getSemanticColoringProvider","pendingChanges","contentChangeListener","styling","lastResultId","request","Promise","resolve","provideDocumentSemanticTokens","token","then","res","err","message","indexOf","onUnexpectedError","_isSemanticTokens","v","_isSemanticTokensEdits","isArray","edits","_copy","src","srcOffset","dest","destOffset","tokens","currentResponse","setSemanticTokens","deltaLength","edit","deleteCount","srcData","destData","Uint32Array","srcLastStart","destLastStart","copyCount","start","tokenCount","tokensPerArea","max","ceil","result","tokenIndex","lastLineNumber","lastStartCharacter","tokenStartIndex","tokenEndIndex","min","smallTokenEndIndex","bigTokenEndIndex","areaLine","deltaLine","deltaCharacter","lineNumber","startCharacter","length_1","subarray","tokens_1","_b","pendingChanges_1","change","_c","result_1","area","_d","_e","changes","singleChange","applyEdit","range","text","ordered"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n};\r\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n};\r\nimport { Emitter } from '../../../base/common/event.js';\r\nimport { Disposable, DisposableStore } from '../../../base/common/lifecycle.js';\r\nimport * as platform from '../../../base/common/platform.js';\r\nimport * as errors from '../../../base/common/errors.js';\r\nimport { EDITOR_MODEL_DEFAULTS } from '../config/editorOptions.js';\r\nimport { TextModel } from '../model/textModel.js';\r\nimport { DocumentSemanticTokensProviderRegistry, TokenMetadata } from '../modes.js';\r\nimport { PLAINTEXT_LANGUAGE_IDENTIFIER } from '../modes/modesRegistry.js';\r\nimport { ITextResourcePropertiesService } from './textResourceConfigurationService.js';\r\nimport { IConfigurationService } from '../../../platform/configuration/common/configuration.js';\r\nimport { RunOnceScheduler } from '../../../base/common/async.js';\r\nimport { CancellationTokenSource } from '../../../base/common/cancellation.js';\r\nimport { SparseEncodedTokens, MultilineTokens2 } from '../model/tokensStore.js';\r\nimport { IThemeService } from '../../../platform/theme/common/themeService.js';\r\nimport { ILogService, LogLevel } from '../../../platform/log/common/log.js';\r\nfunction MODEL_ID(resource) {\r\n    return resource.toString();\r\n}\r\nvar ModelData = /** @class */ (function () {\r\n    function ModelData(model, onWillDispose, onDidChangeLanguage) {\r\n        this._modelEventListeners = new DisposableStore();\r\n        this.model = model;\r\n        this._languageSelection = null;\r\n        this._languageSelectionListener = null;\r\n        this._modelEventListeners.add(model.onWillDispose(function () { return onWillDispose(model); }));\r\n        this._modelEventListeners.add(model.onDidChangeLanguage(function (e) { return onDidChangeLanguage(model, e); }));\r\n    }\r\n    ModelData.prototype._disposeLanguageSelection = function () {\r\n        if (this._languageSelectionListener) {\r\n            this._languageSelectionListener.dispose();\r\n            this._languageSelectionListener = null;\r\n        }\r\n        if (this._languageSelection) {\r\n            this._languageSelection.dispose();\r\n            this._languageSelection = null;\r\n        }\r\n    };\r\n    ModelData.prototype.dispose = function () {\r\n        this._modelEventListeners.dispose();\r\n        this._disposeLanguageSelection();\r\n    };\r\n    ModelData.prototype.setLanguage = function (languageSelection) {\r\n        var _this = this;\r\n        this._disposeLanguageSelection();\r\n        this._languageSelection = languageSelection;\r\n        this._languageSelectionListener = this._languageSelection.onDidChange(function () { return _this.model.setMode(languageSelection.languageIdentifier); });\r\n        this.model.setMode(languageSelection.languageIdentifier);\r\n    };\r\n    return ModelData;\r\n}());\r\nvar DEFAULT_EOL = (platform.isLinux || platform.isMacintosh) ? 1 /* LF */ : 2 /* CRLF */;\r\nvar ModelServiceImpl = /** @class */ (function (_super) {\r\n    __extends(ModelServiceImpl, _super);\r\n    function ModelServiceImpl(configurationService, resourcePropertiesService, themeService, logService) {\r\n        var _this = _super.call(this) || this;\r\n        _this._onModelAdded = _this._register(new Emitter());\r\n        _this.onModelAdded = _this._onModelAdded.event;\r\n        _this._onModelRemoved = _this._register(new Emitter());\r\n        _this.onModelRemoved = _this._onModelRemoved.event;\r\n        _this._onModelModeChanged = _this._register(new Emitter());\r\n        _this.onModelModeChanged = _this._onModelModeChanged.event;\r\n        _this._configurationService = configurationService;\r\n        _this._resourcePropertiesService = resourcePropertiesService;\r\n        _this._models = {};\r\n        _this._modelCreationOptionsByLanguageAndResource = Object.create(null);\r\n        _this._configurationServiceSubscription = _this._configurationService.onDidChangeConfiguration(function (e) { return _this._updateModelOptions(); });\r\n        _this._updateModelOptions();\r\n        _this._register(new SemanticColoringFeature(_this, themeService, configurationService, logService));\r\n        return _this;\r\n    }\r\n    ModelServiceImpl._readModelOptions = function (config, isForSimpleWidget) {\r\n        var tabSize = EDITOR_MODEL_DEFAULTS.tabSize;\r\n        if (config.editor && typeof config.editor.tabSize !== 'undefined') {\r\n            var parsedTabSize = parseInt(config.editor.tabSize, 10);\r\n            if (!isNaN(parsedTabSize)) {\r\n                tabSize = parsedTabSize;\r\n            }\r\n            if (tabSize < 1) {\r\n                tabSize = 1;\r\n            }\r\n        }\r\n        var indentSize = tabSize;\r\n        if (config.editor && typeof config.editor.indentSize !== 'undefined' && config.editor.indentSize !== 'tabSize') {\r\n            var parsedIndentSize = parseInt(config.editor.indentSize, 10);\r\n            if (!isNaN(parsedIndentSize)) {\r\n                indentSize = parsedIndentSize;\r\n            }\r\n            if (indentSize < 1) {\r\n                indentSize = 1;\r\n            }\r\n        }\r\n        var insertSpaces = EDITOR_MODEL_DEFAULTS.insertSpaces;\r\n        if (config.editor && typeof config.editor.insertSpaces !== 'undefined') {\r\n            insertSpaces = (config.editor.insertSpaces === 'false' ? false : Boolean(config.editor.insertSpaces));\r\n        }\r\n        var newDefaultEOL = DEFAULT_EOL;\r\n        var eol = config.eol;\r\n        if (eol === '\\r\\n') {\r\n            newDefaultEOL = 2 /* CRLF */;\r\n        }\r\n        else if (eol === '\\n') {\r\n            newDefaultEOL = 1 /* LF */;\r\n        }\r\n        var trimAutoWhitespace = EDITOR_MODEL_DEFAULTS.trimAutoWhitespace;\r\n        if (config.editor && typeof config.editor.trimAutoWhitespace !== 'undefined') {\r\n            trimAutoWhitespace = (config.editor.trimAutoWhitespace === 'false' ? false : Boolean(config.editor.trimAutoWhitespace));\r\n        }\r\n        var detectIndentation = EDITOR_MODEL_DEFAULTS.detectIndentation;\r\n        if (config.editor && typeof config.editor.detectIndentation !== 'undefined') {\r\n            detectIndentation = (config.editor.detectIndentation === 'false' ? false : Boolean(config.editor.detectIndentation));\r\n        }\r\n        var largeFileOptimizations = EDITOR_MODEL_DEFAULTS.largeFileOptimizations;\r\n        if (config.editor && typeof config.editor.largeFileOptimizations !== 'undefined') {\r\n            largeFileOptimizations = (config.editor.largeFileOptimizations === 'false' ? false : Boolean(config.editor.largeFileOptimizations));\r\n        }\r\n        return {\r\n            isForSimpleWidget: isForSimpleWidget,\r\n            tabSize: tabSize,\r\n            indentSize: indentSize,\r\n            insertSpaces: insertSpaces,\r\n            detectIndentation: detectIndentation,\r\n            defaultEOL: newDefaultEOL,\r\n            trimAutoWhitespace: trimAutoWhitespace,\r\n            largeFileOptimizations: largeFileOptimizations\r\n        };\r\n    };\r\n    ModelServiceImpl.prototype.getCreationOptions = function (language, resource, isForSimpleWidget) {\r\n        var creationOptions = this._modelCreationOptionsByLanguageAndResource[language + resource];\r\n        if (!creationOptions) {\r\n            var editor = this._configurationService.getValue('editor', { overrideIdentifier: language, resource: resource });\r\n            var eol = this._resourcePropertiesService.getEOL(resource, language);\r\n            creationOptions = ModelServiceImpl._readModelOptions({ editor: editor, eol: eol }, isForSimpleWidget);\r\n            this._modelCreationOptionsByLanguageAndResource[language + resource] = creationOptions;\r\n        }\r\n        return creationOptions;\r\n    };\r\n    ModelServiceImpl.prototype._updateModelOptions = function () {\r\n        var oldOptionsByLanguageAndResource = this._modelCreationOptionsByLanguageAndResource;\r\n        this._modelCreationOptionsByLanguageAndResource = Object.create(null);\r\n        // Update options on all models\r\n        var keys = Object.keys(this._models);\r\n        for (var i = 0, len = keys.length; i < len; i++) {\r\n            var modelId = keys[i];\r\n            var modelData = this._models[modelId];\r\n            var language = modelData.model.getLanguageIdentifier().language;\r\n            var uri = modelData.model.uri;\r\n            var oldOptions = oldOptionsByLanguageAndResource[language + uri];\r\n            var newOptions = this.getCreationOptions(language, uri, modelData.model.isForSimpleWidget);\r\n            ModelServiceImpl._setModelOptionsForModel(modelData.model, newOptions, oldOptions);\r\n        }\r\n    };\r\n    ModelServiceImpl._setModelOptionsForModel = function (model, newOptions, currentOptions) {\r\n        if (currentOptions && currentOptions.defaultEOL !== newOptions.defaultEOL && model.getLineCount() === 1) {\r\n            model.setEOL(newOptions.defaultEOL === 1 /* LF */ ? 0 /* LF */ : 1 /* CRLF */);\r\n        }\r\n        if (currentOptions\r\n            && (currentOptions.detectIndentation === newOptions.detectIndentation)\r\n            && (currentOptions.insertSpaces === newOptions.insertSpaces)\r\n            && (currentOptions.tabSize === newOptions.tabSize)\r\n            && (currentOptions.indentSize === newOptions.indentSize)\r\n            && (currentOptions.trimAutoWhitespace === newOptions.trimAutoWhitespace)) {\r\n            // Same indent opts, no need to touch the model\r\n            return;\r\n        }\r\n        if (newOptions.detectIndentation) {\r\n            model.detectIndentation(newOptions.insertSpaces, newOptions.tabSize);\r\n            model.updateOptions({\r\n                trimAutoWhitespace: newOptions.trimAutoWhitespace\r\n            });\r\n        }\r\n        else {\r\n            model.updateOptions({\r\n                insertSpaces: newOptions.insertSpaces,\r\n                tabSize: newOptions.tabSize,\r\n                indentSize: newOptions.indentSize,\r\n                trimAutoWhitespace: newOptions.trimAutoWhitespace\r\n            });\r\n        }\r\n    };\r\n    ModelServiceImpl.prototype.dispose = function () {\r\n        this._configurationServiceSubscription.dispose();\r\n        _super.prototype.dispose.call(this);\r\n    };\r\n    // --- begin IModelService\r\n    ModelServiceImpl.prototype._createModelData = function (value, languageIdentifier, resource, isForSimpleWidget) {\r\n        var _this = this;\r\n        // create & save the model\r\n        var options = this.getCreationOptions(languageIdentifier.language, resource, isForSimpleWidget);\r\n        var model = new TextModel(value, options, languageIdentifier, resource);\r\n        var modelId = MODEL_ID(model.uri);\r\n        if (this._models[modelId]) {\r\n            // There already exists a model with this id => this is a programmer error\r\n            throw new Error('ModelService: Cannot add model because it already exists!');\r\n        }\r\n        var modelData = new ModelData(model, function (model) { return _this._onWillDispose(model); }, function (model, e) { return _this._onDidChangeLanguage(model, e); });\r\n        this._models[modelId] = modelData;\r\n        return modelData;\r\n    };\r\n    ModelServiceImpl.prototype.createModel = function (value, languageSelection, resource, isForSimpleWidget) {\r\n        if (isForSimpleWidget === void 0) { isForSimpleWidget = false; }\r\n        var modelData;\r\n        if (languageSelection) {\r\n            modelData = this._createModelData(value, languageSelection.languageIdentifier, resource, isForSimpleWidget);\r\n            this.setMode(modelData.model, languageSelection);\r\n        }\r\n        else {\r\n            modelData = this._createModelData(value, PLAINTEXT_LANGUAGE_IDENTIFIER, resource, isForSimpleWidget);\r\n        }\r\n        this._onModelAdded.fire(modelData.model);\r\n        return modelData.model;\r\n    };\r\n    ModelServiceImpl.prototype.setMode = function (model, languageSelection) {\r\n        if (!languageSelection) {\r\n            return;\r\n        }\r\n        var modelData = this._models[MODEL_ID(model.uri)];\r\n        if (!modelData) {\r\n            return;\r\n        }\r\n        modelData.setLanguage(languageSelection);\r\n    };\r\n    ModelServiceImpl.prototype.getModels = function () {\r\n        var ret = [];\r\n        var keys = Object.keys(this._models);\r\n        for (var i = 0, len = keys.length; i < len; i++) {\r\n            var modelId = keys[i];\r\n            ret.push(this._models[modelId].model);\r\n        }\r\n        return ret;\r\n    };\r\n    ModelServiceImpl.prototype.getModel = function (resource) {\r\n        var modelId = MODEL_ID(resource);\r\n        var modelData = this._models[modelId];\r\n        if (!modelData) {\r\n            return null;\r\n        }\r\n        return modelData.model;\r\n    };\r\n    // --- end IModelService\r\n    ModelServiceImpl.prototype._onWillDispose = function (model) {\r\n        var modelId = MODEL_ID(model.uri);\r\n        var modelData = this._models[modelId];\r\n        delete this._models[modelId];\r\n        modelData.dispose();\r\n        // clean up cache\r\n        delete this._modelCreationOptionsByLanguageAndResource[model.getLanguageIdentifier().language + model.uri];\r\n        this._onModelRemoved.fire(model);\r\n    };\r\n    ModelServiceImpl.prototype._onDidChangeLanguage = function (model, e) {\r\n        var oldModeId = e.oldLanguage;\r\n        var newModeId = model.getLanguageIdentifier().language;\r\n        var oldOptions = this.getCreationOptions(oldModeId, model.uri, model.isForSimpleWidget);\r\n        var newOptions = this.getCreationOptions(newModeId, model.uri, model.isForSimpleWidget);\r\n        ModelServiceImpl._setModelOptionsForModel(model, newOptions, oldOptions);\r\n        this._onModelModeChanged.fire({ model: model, oldModeId: oldModeId });\r\n    };\r\n    ModelServiceImpl = __decorate([\r\n        __param(0, IConfigurationService),\r\n        __param(1, ITextResourcePropertiesService),\r\n        __param(2, IThemeService),\r\n        __param(3, ILogService)\r\n    ], ModelServiceImpl);\r\n    return ModelServiceImpl;\r\n}(Disposable));\r\nexport { ModelServiceImpl };\r\nvar SemanticColoringFeature = /** @class */ (function (_super) {\r\n    __extends(SemanticColoringFeature, _super);\r\n    function SemanticColoringFeature(modelService, themeService, configurationService, logService) {\r\n        var _this = _super.call(this) || this;\r\n        _this._configurationService = configurationService;\r\n        _this._watchers = Object.create(null);\r\n        _this._semanticStyling = _this._register(new SemanticStyling(themeService, logService));\r\n        var isSemanticColoringEnabled = function (model) {\r\n            var options = configurationService.getValue(SemanticColoringFeature.SETTING_ID, { overrideIdentifier: model.getLanguageIdentifier().language, resource: model.uri });\r\n            return options && options.enabled;\r\n        };\r\n        var register = function (model) {\r\n            _this._watchers[model.uri.toString()] = new ModelSemanticColoring(model, themeService, _this._semanticStyling);\r\n        };\r\n        var deregister = function (model, modelSemanticColoring) {\r\n            modelSemanticColoring.dispose();\r\n            delete _this._watchers[model.uri.toString()];\r\n        };\r\n        _this._register(modelService.onModelAdded(function (model) {\r\n            if (isSemanticColoringEnabled(model)) {\r\n                register(model);\r\n            }\r\n        }));\r\n        _this._register(modelService.onModelRemoved(function (model) {\r\n            var curr = _this._watchers[model.uri.toString()];\r\n            if (curr) {\r\n                deregister(model, curr);\r\n            }\r\n        }));\r\n        _this._configurationService.onDidChangeConfiguration(function (e) {\r\n            if (e.affectsConfiguration(SemanticColoringFeature.SETTING_ID)) {\r\n                for (var _i = 0, _a = modelService.getModels(); _i < _a.length; _i++) {\r\n                    var model = _a[_i];\r\n                    var curr = _this._watchers[model.uri.toString()];\r\n                    if (isSemanticColoringEnabled(model)) {\r\n                        if (!curr) {\r\n                            register(model);\r\n                        }\r\n                    }\r\n                    else {\r\n                        if (curr) {\r\n                            deregister(model, curr);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        return _this;\r\n    }\r\n    SemanticColoringFeature.SETTING_ID = 'editor.semanticHighlighting';\r\n    return SemanticColoringFeature;\r\n}(Disposable));\r\nvar SemanticStyling = /** @class */ (function (_super) {\r\n    __extends(SemanticStyling, _super);\r\n    function SemanticStyling(_themeService, _logService) {\r\n        var _this = _super.call(this) || this;\r\n        _this._themeService = _themeService;\r\n        _this._logService = _logService;\r\n        _this._caches = new WeakMap();\r\n        if (_this._themeService) {\r\n            // workaround for tests which use undefined... :/\r\n            _this._register(_this._themeService.onThemeChange(function () {\r\n                _this._caches = new WeakMap();\r\n            }));\r\n        }\r\n        return _this;\r\n    }\r\n    SemanticStyling.prototype.get = function (provider) {\r\n        if (!this._caches.has(provider)) {\r\n            this._caches.set(provider, new SemanticColoringProviderStyling(provider.getLegend(), this._themeService, this._logService));\r\n        }\r\n        return this._caches.get(provider);\r\n    };\r\n    return SemanticStyling;\r\n}(Disposable));\r\nvar HashTableEntry = /** @class */ (function () {\r\n    function HashTableEntry(tokenTypeIndex, tokenModifierSet, metadata) {\r\n        this.tokenTypeIndex = tokenTypeIndex;\r\n        this.tokenModifierSet = tokenModifierSet;\r\n        this.metadata = metadata;\r\n        this.next = null;\r\n    }\r\n    return HashTableEntry;\r\n}());\r\nvar HashTable = /** @class */ (function () {\r\n    function HashTable() {\r\n        this._elementsCount = 0;\r\n        this._currentLengthIndex = 0;\r\n        this._currentLength = HashTable._SIZES[this._currentLengthIndex];\r\n        this._growCount = Math.round(this._currentLengthIndex + 1 < HashTable._SIZES.length ? 2 / 3 * this._currentLength : 0);\r\n        this._elements = [];\r\n        HashTable._nullOutEntries(this._elements, this._currentLength);\r\n    }\r\n    HashTable._nullOutEntries = function (entries, length) {\r\n        for (var i = 0; i < length; i++) {\r\n            entries[i] = null;\r\n        }\r\n    };\r\n    HashTable.prototype._hashFunc = function (tokenTypeIndex, tokenModifierSet) {\r\n        return ((((tokenTypeIndex << 5) - tokenTypeIndex) + tokenModifierSet) | 0) % this._currentLength; // tokenTypeIndex * 31 + tokenModifierSet, keep as int32\r\n    };\r\n    HashTable.prototype.get = function (tokenTypeIndex, tokenModifierSet) {\r\n        var hash = this._hashFunc(tokenTypeIndex, tokenModifierSet);\r\n        var p = this._elements[hash];\r\n        while (p) {\r\n            if (p.tokenTypeIndex === tokenTypeIndex && p.tokenModifierSet === tokenModifierSet) {\r\n                return p;\r\n            }\r\n            p = p.next;\r\n        }\r\n        return null;\r\n    };\r\n    HashTable.prototype.add = function (tokenTypeIndex, tokenModifierSet, metadata) {\r\n        this._elementsCount++;\r\n        if (this._growCount !== 0 && this._elementsCount >= this._growCount) {\r\n            // expand!\r\n            var oldElements = this._elements;\r\n            this._currentLengthIndex++;\r\n            this._currentLength = HashTable._SIZES[this._currentLengthIndex];\r\n            this._growCount = Math.round(this._currentLengthIndex + 1 < HashTable._SIZES.length ? 2 / 3 * this._currentLength : 0);\r\n            this._elements = [];\r\n            HashTable._nullOutEntries(this._elements, this._currentLength);\r\n            for (var _i = 0, oldElements_1 = oldElements; _i < oldElements_1.length; _i++) {\r\n                var first = oldElements_1[_i];\r\n                var p = first;\r\n                while (p) {\r\n                    var oldNext = p.next;\r\n                    p.next = null;\r\n                    this._add(p);\r\n                    p = oldNext;\r\n                }\r\n            }\r\n        }\r\n        this._add(new HashTableEntry(tokenTypeIndex, tokenModifierSet, metadata));\r\n    };\r\n    HashTable.prototype._add = function (element) {\r\n        var hash = this._hashFunc(element.tokenTypeIndex, element.tokenModifierSet);\r\n        element.next = this._elements[hash];\r\n        this._elements[hash] = element;\r\n    };\r\n    HashTable._SIZES = [3, 7, 13, 31, 61, 127, 251, 509, 1021, 2039, 4093, 8191, 16381, 32749, 65521, 131071, 262139, 524287, 1048573, 2097143];\r\n    return HashTable;\r\n}());\r\nvar SemanticColoringProviderStyling = /** @class */ (function () {\r\n    function SemanticColoringProviderStyling(_legend, _themeService, _logService) {\r\n        this._legend = _legend;\r\n        this._themeService = _themeService;\r\n        this._logService = _logService;\r\n        this._hashTable = new HashTable();\r\n    }\r\n    SemanticColoringProviderStyling.prototype.getMetadata = function (tokenTypeIndex, tokenModifierSet) {\r\n        var entry = this._hashTable.get(tokenTypeIndex, tokenModifierSet);\r\n        var metadata;\r\n        if (entry) {\r\n            metadata = entry.metadata;\r\n        }\r\n        else {\r\n            var tokenType = this._legend.tokenTypes[tokenTypeIndex];\r\n            var tokenModifiers = [];\r\n            var modifierSet = tokenModifierSet;\r\n            for (var modifierIndex = 0; modifierSet > 0 && modifierIndex < this._legend.tokenModifiers.length; modifierIndex++) {\r\n                if (modifierSet & 1) {\r\n                    tokenModifiers.push(this._legend.tokenModifiers[modifierIndex]);\r\n                }\r\n                modifierSet = modifierSet >> 1;\r\n            }\r\n            var tokenStyle = this._themeService.getTheme().getTokenStyleMetadata(tokenType, tokenModifiers);\r\n            if (typeof tokenStyle === 'undefined') {\r\n                metadata = 2147483647 /* NO_STYLING */;\r\n            }\r\n            else {\r\n                metadata = 0;\r\n                if (typeof tokenStyle.italic !== 'undefined') {\r\n                    var italicBit = (tokenStyle.italic ? 1 /* Italic */ : 0) << 11 /* FONT_STYLE_OFFSET */;\r\n                    metadata |= italicBit | 1 /* SEMANTIC_USE_ITALIC */;\r\n                }\r\n                if (typeof tokenStyle.bold !== 'undefined') {\r\n                    var boldBit = (tokenStyle.bold ? 2 /* Bold */ : 0) << 11 /* FONT_STYLE_OFFSET */;\r\n                    metadata |= boldBit | 2 /* SEMANTIC_USE_BOLD */;\r\n                }\r\n                if (typeof tokenStyle.underline !== 'undefined') {\r\n                    var underlineBit = (tokenStyle.underline ? 4 /* Underline */ : 0) << 11 /* FONT_STYLE_OFFSET */;\r\n                    metadata |= underlineBit | 4 /* SEMANTIC_USE_UNDERLINE */;\r\n                }\r\n                if (tokenStyle.foreground) {\r\n                    var foregroundBits = (tokenStyle.foreground) << 14 /* FOREGROUND_OFFSET */;\r\n                    metadata |= foregroundBits | 8 /* SEMANTIC_USE_FOREGROUND */;\r\n                }\r\n                if (metadata === 0) {\r\n                    // Nothing!\r\n                    metadata = 2147483647 /* NO_STYLING */;\r\n                }\r\n            }\r\n            this._hashTable.add(tokenTypeIndex, tokenModifierSet, metadata);\r\n        }\r\n        if (this._logService.getLevel() === LogLevel.Trace) {\r\n            var type = this._legend.tokenTypes[tokenTypeIndex];\r\n            var modifiers = tokenModifierSet ? ' ' + this._legend.tokenModifiers.filter(function (_, i) { return tokenModifierSet & (1 << i); }).join(' ') : '';\r\n            this._logService.trace(\"tokenStyleMetadata \" + (entry ? '[CACHED] ' : '') + type + modifiers + \": foreground \" + TokenMetadata.getForeground(metadata) + \", fontStyle \" + TokenMetadata.getFontStyle(metadata).toString(2));\r\n        }\r\n        return metadata;\r\n    };\r\n    return SemanticColoringProviderStyling;\r\n}());\r\nvar SemanticTokensResponse = /** @class */ (function () {\r\n    function SemanticTokensResponse(_provider, resultId, data) {\r\n        this._provider = _provider;\r\n        this.resultId = resultId;\r\n        this.data = data;\r\n    }\r\n    SemanticTokensResponse.prototype.dispose = function () {\r\n        this._provider.releaseDocumentSemanticTokens(this.resultId);\r\n    };\r\n    return SemanticTokensResponse;\r\n}());\r\nvar ModelSemanticColoring = /** @class */ (function (_super) {\r\n    __extends(ModelSemanticColoring, _super);\r\n    function ModelSemanticColoring(model, themeService, stylingProvider) {\r\n        var _this = _super.call(this) || this;\r\n        _this._isDisposed = false;\r\n        _this._model = model;\r\n        _this._semanticStyling = stylingProvider;\r\n        _this._fetchSemanticTokens = _this._register(new RunOnceScheduler(function () { return _this._fetchSemanticTokensNow(); }, 300));\r\n        _this._currentResponse = null;\r\n        _this._currentRequestCancellationTokenSource = null;\r\n        _this._register(_this._model.onDidChangeContent(function (e) {\r\n            if (!_this._fetchSemanticTokens.isScheduled()) {\r\n                _this._fetchSemanticTokens.schedule();\r\n            }\r\n        }));\r\n        _this._register(DocumentSemanticTokensProviderRegistry.onDidChange(function (e) { return _this._fetchSemanticTokens.schedule(); }));\r\n        if (themeService) {\r\n            // workaround for tests which use undefined... :/\r\n            _this._register(themeService.onThemeChange(function (_) {\r\n                // clear out existing tokens\r\n                _this._setSemanticTokens(null, null, null, []);\r\n                _this._fetchSemanticTokens.schedule();\r\n            }));\r\n        }\r\n        _this._fetchSemanticTokens.schedule(0);\r\n        return _this;\r\n    }\r\n    ModelSemanticColoring.prototype.dispose = function () {\r\n        if (this._currentResponse) {\r\n            this._currentResponse.dispose();\r\n            this._currentResponse = null;\r\n        }\r\n        if (this._currentRequestCancellationTokenSource) {\r\n            this._currentRequestCancellationTokenSource.cancel();\r\n            this._currentRequestCancellationTokenSource = null;\r\n        }\r\n        this._setSemanticTokens(null, null, null, []);\r\n        this._isDisposed = true;\r\n        _super.prototype.dispose.call(this);\r\n    };\r\n    ModelSemanticColoring.prototype._fetchSemanticTokensNow = function () {\r\n        var _this = this;\r\n        if (this._currentRequestCancellationTokenSource) {\r\n            // there is already a request running, let it finish...\r\n            return;\r\n        }\r\n        var provider = this._getSemanticColoringProvider();\r\n        if (!provider) {\r\n            return;\r\n        }\r\n        this._currentRequestCancellationTokenSource = new CancellationTokenSource();\r\n        var pendingChanges = [];\r\n        var contentChangeListener = this._model.onDidChangeContent(function (e) {\r\n            pendingChanges.push(e);\r\n        });\r\n        var styling = this._semanticStyling.get(provider);\r\n        var lastResultId = this._currentResponse ? this._currentResponse.resultId || null : null;\r\n        var request = Promise.resolve(provider.provideDocumentSemanticTokens(this._model, lastResultId, this._currentRequestCancellationTokenSource.token));\r\n        request.then(function (res) {\r\n            _this._currentRequestCancellationTokenSource = null;\r\n            contentChangeListener.dispose();\r\n            _this._setSemanticTokens(provider, res || null, styling, pendingChanges);\r\n        }, function (err) {\r\n            if (!err || typeof err.message !== 'string' || err.message.indexOf('busy') === -1) {\r\n                errors.onUnexpectedError(err);\r\n            }\r\n            // Semantic tokens eats up all errors and considers errors to mean that the result is temporarily not available\r\n            // The API does not have a special error kind to express this...\r\n            _this._currentRequestCancellationTokenSource = null;\r\n            contentChangeListener.dispose();\r\n            if (pendingChanges.length > 0) {\r\n                // More changes occurred while the request was running\r\n                if (!_this._fetchSemanticTokens.isScheduled()) {\r\n                    _this._fetchSemanticTokens.schedule();\r\n                }\r\n            }\r\n        });\r\n    };\r\n    ModelSemanticColoring._isSemanticTokens = function (v) {\r\n        return v && !!(v.data);\r\n    };\r\n    ModelSemanticColoring._isSemanticTokensEdits = function (v) {\r\n        return v && Array.isArray(v.edits);\r\n    };\r\n    ModelSemanticColoring._copy = function (src, srcOffset, dest, destOffset, length) {\r\n        for (var i = 0; i < length; i++) {\r\n            dest[destOffset + i] = src[srcOffset + i];\r\n        }\r\n    };\r\n    ModelSemanticColoring.prototype._setSemanticTokens = function (provider, tokens, styling, pendingChanges) {\r\n        var currentResponse = this._currentResponse;\r\n        if (this._currentResponse) {\r\n            this._currentResponse.dispose();\r\n            this._currentResponse = null;\r\n        }\r\n        if (this._isDisposed) {\r\n            // disposed!\r\n            if (provider && tokens) {\r\n                provider.releaseDocumentSemanticTokens(tokens.resultId);\r\n            }\r\n            return;\r\n        }\r\n        if (!provider || !tokens || !styling) {\r\n            this._model.setSemanticTokens(null);\r\n            return;\r\n        }\r\n        if (ModelSemanticColoring._isSemanticTokensEdits(tokens)) {\r\n            if (!currentResponse) {\r\n                // not possible!\r\n                this._model.setSemanticTokens(null);\r\n                return;\r\n            }\r\n            if (tokens.edits.length === 0) {\r\n                // nothing to do!\r\n                tokens = {\r\n                    resultId: tokens.resultId,\r\n                    data: currentResponse.data\r\n                };\r\n            }\r\n            else {\r\n                var deltaLength = 0;\r\n                for (var _i = 0, _a = tokens.edits; _i < _a.length; _i++) {\r\n                    var edit = _a[_i];\r\n                    deltaLength += (edit.data ? edit.data.length : 0) - edit.deleteCount;\r\n                }\r\n                var srcData = currentResponse.data;\r\n                var destData = new Uint32Array(srcData.length + deltaLength);\r\n                var srcLastStart = srcData.length;\r\n                var destLastStart = destData.length;\r\n                for (var i = tokens.edits.length - 1; i >= 0; i--) {\r\n                    var edit = tokens.edits[i];\r\n                    var copyCount = srcLastStart - (edit.start + edit.deleteCount);\r\n                    if (copyCount > 0) {\r\n                        ModelSemanticColoring._copy(srcData, srcLastStart - copyCount, destData, destLastStart - copyCount, copyCount);\r\n                        destLastStart -= copyCount;\r\n                    }\r\n                    if (edit.data) {\r\n                        ModelSemanticColoring._copy(edit.data, 0, destData, destLastStart - edit.data.length, edit.data.length);\r\n                        destLastStart -= edit.data.length;\r\n                    }\r\n                    srcLastStart = edit.start;\r\n                }\r\n                if (srcLastStart > 0) {\r\n                    ModelSemanticColoring._copy(srcData, 0, destData, 0, srcLastStart);\r\n                }\r\n                tokens = {\r\n                    resultId: tokens.resultId,\r\n                    data: destData\r\n                };\r\n            }\r\n        }\r\n        if (ModelSemanticColoring._isSemanticTokens(tokens)) {\r\n            this._currentResponse = new SemanticTokensResponse(provider, tokens.resultId, tokens.data);\r\n            var srcData = tokens.data;\r\n            var tokenCount = (tokens.data.length / 5) | 0;\r\n            var tokensPerArea = Math.max(Math.ceil(tokenCount / 1024 /* DesiredMaxAreas */), 400 /* DesiredTokensPerArea */);\r\n            var result = [];\r\n            var tokenIndex = 0;\r\n            var lastLineNumber = 1;\r\n            var lastStartCharacter = 0;\r\n            while (tokenIndex < tokenCount) {\r\n                var tokenStartIndex = tokenIndex;\r\n                var tokenEndIndex = Math.min(tokenStartIndex + tokensPerArea, tokenCount);\r\n                // Keep tokens on the same line in the same area...\r\n                if (tokenEndIndex < tokenCount) {\r\n                    var smallTokenEndIndex = tokenEndIndex;\r\n                    while (smallTokenEndIndex - 1 > tokenStartIndex && srcData[5 * smallTokenEndIndex] === 0) {\r\n                        smallTokenEndIndex--;\r\n                    }\r\n                    if (smallTokenEndIndex - 1 === tokenStartIndex) {\r\n                        // there are so many tokens on this line that our area would be empty, we must now go right\r\n                        var bigTokenEndIndex = tokenEndIndex;\r\n                        while (bigTokenEndIndex + 1 < tokenCount && srcData[5 * bigTokenEndIndex] === 0) {\r\n                            bigTokenEndIndex++;\r\n                        }\r\n                        tokenEndIndex = bigTokenEndIndex;\r\n                    }\r\n                    else {\r\n                        tokenEndIndex = smallTokenEndIndex;\r\n                    }\r\n                }\r\n                var destData = new Uint32Array((tokenEndIndex - tokenStartIndex) * 4);\r\n                var destOffset = 0;\r\n                var areaLine = 0;\r\n                while (tokenIndex < tokenEndIndex) {\r\n                    var srcOffset = 5 * tokenIndex;\r\n                    var deltaLine = srcData[srcOffset];\r\n                    var deltaCharacter = srcData[srcOffset + 1];\r\n                    var lineNumber = lastLineNumber + deltaLine;\r\n                    var startCharacter = (deltaLine === 0 ? lastStartCharacter + deltaCharacter : deltaCharacter);\r\n                    var length_1 = srcData[srcOffset + 2];\r\n                    var tokenTypeIndex = srcData[srcOffset + 3];\r\n                    var tokenModifierSet = srcData[srcOffset + 4];\r\n                    var metadata = styling.getMetadata(tokenTypeIndex, tokenModifierSet);\r\n                    if (metadata !== 2147483647 /* NO_STYLING */) {\r\n                        if (areaLine === 0) {\r\n                            areaLine = lineNumber;\r\n                        }\r\n                        destData[destOffset] = lineNumber - areaLine;\r\n                        destData[destOffset + 1] = startCharacter;\r\n                        destData[destOffset + 2] = startCharacter + length_1;\r\n                        destData[destOffset + 3] = metadata;\r\n                        destOffset += 4;\r\n                    }\r\n                    lastLineNumber = lineNumber;\r\n                    lastStartCharacter = startCharacter;\r\n                    tokenIndex++;\r\n                }\r\n                if (destOffset !== destData.length) {\r\n                    destData = destData.subarray(0, destOffset);\r\n                }\r\n                var tokens_1 = new MultilineTokens2(areaLine, new SparseEncodedTokens(destData));\r\n                result.push(tokens_1);\r\n            }\r\n            // Adjust incoming semantic tokens\r\n            if (pendingChanges.length > 0) {\r\n                // More changes occurred while the request was running\r\n                // We need to:\r\n                // 1. Adjust incoming semantic tokens\r\n                // 2. Request them again\r\n                for (var _b = 0, pendingChanges_1 = pendingChanges; _b < pendingChanges_1.length; _b++) {\r\n                    var change = pendingChanges_1[_b];\r\n                    for (var _c = 0, result_1 = result; _c < result_1.length; _c++) {\r\n                        var area = result_1[_c];\r\n                        for (var _d = 0, _e = change.changes; _d < _e.length; _d++) {\r\n                            var singleChange = _e[_d];\r\n                            area.applyEdit(singleChange.range, singleChange.text);\r\n                        }\r\n                    }\r\n                }\r\n                if (!this._fetchSemanticTokens.isScheduled()) {\r\n                    this._fetchSemanticTokens.schedule();\r\n                }\r\n            }\r\n            this._model.setSemanticTokens(result);\r\n            return;\r\n        }\r\n        this._model.setSemanticTokens(null);\r\n    };\r\n    ModelSemanticColoring.prototype._getSemanticColoringProvider = function () {\r\n        var result = DocumentSemanticTokensProviderRegistry.ordered(this._model);\r\n        return (result.length > 0 ? result[0] : null);\r\n    };\r\n    return ModelSemanticColoring;\r\n}(Disposable));\r\n"]},"metadata":{},"sourceType":"module"}