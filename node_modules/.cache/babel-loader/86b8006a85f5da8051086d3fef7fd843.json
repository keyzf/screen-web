{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nimport { RunOnceScheduler, createCancelablePromise, disposableTimeout } from '../../../base/common/async.js';\nimport { onUnexpectedError, onUnexpectedExternalError } from '../../../base/common/errors.js';\nimport { toDisposable, DisposableStore, dispose } from '../../../base/common/lifecycle.js';\nimport { StableEditorScrollState } from '../../browser/core/editorState.js';\nimport { registerEditorContribution } from '../../browser/editorExtensions.js';\nimport { CodeLensProviderRegistry } from '../../common/modes.js';\nimport { getCodeLensData } from './codelens.js';\nimport { CodeLensWidget, CodeLensHelper } from './codelensWidget.js';\nimport { ICommandService } from '../../../platform/commands/common/commands.js';\nimport { INotificationService } from '../../../platform/notification/common/notification.js';\nimport { ICodeLensCache } from './codeLensCache.js';\nimport * as dom from '../../../base/browser/dom.js';\nimport { hash } from '../../../base/common/hash.js';\n\nvar CodeLensContribution =\n/** @class */\nfunction () {\n  function CodeLensContribution(_editor, _commandService, _notificationService, _codeLensCache) {\n    var _this = this;\n\n    this._editor = _editor;\n    this._commandService = _commandService;\n    this._notificationService = _notificationService;\n    this._codeLensCache = _codeLensCache;\n    this._globalToDispose = new DisposableStore();\n    this._localToDispose = new DisposableStore();\n    this._lenses = [];\n    this._oldCodeLensModels = new DisposableStore();\n    this._modelChangeCounter = 0;\n    this._isEnabled = this._editor.getOption(11\n    /* codeLens */\n    );\n\n    this._globalToDispose.add(this._editor.onDidChangeModel(function () {\n      return _this._onModelChange();\n    }));\n\n    this._globalToDispose.add(this._editor.onDidChangeModelLanguage(function () {\n      return _this._onModelChange();\n    }));\n\n    this._globalToDispose.add(this._editor.onDidChangeConfiguration(function () {\n      var prevIsEnabled = _this._isEnabled;\n      _this._isEnabled = _this._editor.getOption(11\n      /* codeLens */\n      );\n\n      if (prevIsEnabled !== _this._isEnabled) {\n        _this._onModelChange();\n      }\n    }));\n\n    this._globalToDispose.add(CodeLensProviderRegistry.onDidChange(this._onModelChange, this));\n\n    this._globalToDispose.add(this._editor.onDidChangeConfiguration(function (e) {\n      if (e.hasChanged(34\n      /* fontInfo */\n      )) {\n        _this._updateLensStyle();\n      }\n    }));\n\n    this._onModelChange();\n\n    this._styleClassName = hash(this._editor.getId()).toString(16);\n    this._styleElement = dom.createStyleSheet(dom.isInShadowDOM(this._editor.getContainerDomNode()) ? this._editor.getContainerDomNode() : undefined);\n\n    this._updateLensStyle();\n  }\n\n  CodeLensContribution.prototype.dispose = function () {\n    this._localDispose();\n\n    this._globalToDispose.dispose();\n\n    this._oldCodeLensModels.dispose();\n\n    dispose(this._currentCodeLensModel);\n  };\n\n  CodeLensContribution.prototype._updateLensStyle = function () {\n    var options = this._editor.getOptions();\n\n    var fontInfo = options.get(34\n    /* fontInfo */\n    );\n    var lineHeight = options.get(49\n    /* lineHeight */\n    );\n    var height = Math.round(lineHeight * 1.1);\n    var fontSize = Math.round(fontInfo.fontSize * 0.9);\n    var newStyle = \"\\n\\t\\t.monaco-editor .codelens-decoration.\" + this._styleClassName + \" { height: \" + height + \"px; line-height: \" + lineHeight + \"px; font-size: \" + fontSize + \"px; padding-right: \" + Math.round(fontInfo.fontSize * 0.45) + \"px;}\\n\\t\\t.monaco-editor .codelens-decoration.\" + this._styleClassName + \" > a > .codicon { line-height: \" + lineHeight + \"px; font-size: \" + fontSize + \"px; }\\n\\t\\t\";\n    this._styleElement.innerHTML = newStyle;\n  };\n\n  CodeLensContribution.prototype._localDispose = function () {\n    if (this._currentFindCodeLensSymbolsPromise) {\n      this._currentFindCodeLensSymbolsPromise.cancel();\n\n      this._currentFindCodeLensSymbolsPromise = undefined;\n      this._modelChangeCounter++;\n    }\n\n    if (this._currentResolveCodeLensSymbolsPromise) {\n      this._currentResolveCodeLensSymbolsPromise.cancel();\n\n      this._currentResolveCodeLensSymbolsPromise = undefined;\n    }\n\n    this._localToDispose.clear();\n\n    this._oldCodeLensModels.clear();\n\n    dispose(this._currentCodeLensModel);\n  };\n\n  CodeLensContribution.prototype._onModelChange = function () {\n    var _this = this;\n\n    this._localDispose();\n\n    var model = this._editor.getModel();\n\n    if (!model) {\n      return;\n    }\n\n    if (!this._isEnabled) {\n      return;\n    }\n\n    var cachedLenses = this._codeLensCache.get(model);\n\n    if (cachedLenses) {\n      this._renderCodeLensSymbols(cachedLenses);\n    }\n\n    if (!CodeLensProviderRegistry.has(model)) {\n      // no provider -> return but check with\n      // cached lenses. they expire after 30 seconds\n      if (cachedLenses) {\n        this._localToDispose.add(disposableTimeout(function () {\n          var cachedLensesNow = _this._codeLensCache.get(model);\n\n          if (cachedLenses === cachedLensesNow) {\n            _this._codeLensCache.delete(model);\n\n            _this._onModelChange();\n          }\n        }, 30 * 1000));\n      }\n\n      return;\n    }\n\n    for (var _i = 0, _a = CodeLensProviderRegistry.all(model); _i < _a.length; _i++) {\n      var provider = _a[_i];\n\n      if (typeof provider.onDidChange === 'function') {\n        var registration = provider.onDidChange(function () {\n          return scheduler.schedule();\n        });\n\n        this._localToDispose.add(registration);\n      }\n    }\n\n    var detectVisibleLenses = this._detectVisibleLenses = new RunOnceScheduler(function () {\n      return _this._onViewportChanged();\n    }, 250);\n    var scheduler = new RunOnceScheduler(function () {\n      var counterValue = ++_this._modelChangeCounter;\n\n      if (_this._currentFindCodeLensSymbolsPromise) {\n        _this._currentFindCodeLensSymbolsPromise.cancel();\n      }\n\n      _this._currentFindCodeLensSymbolsPromise = createCancelablePromise(function (token) {\n        return getCodeLensData(model, token);\n      });\n\n      _this._currentFindCodeLensSymbolsPromise.then(function (result) {\n        if (counterValue === _this._modelChangeCounter) {\n          // only the last one wins\n          if (_this._currentCodeLensModel) {\n            _this._oldCodeLensModels.add(_this._currentCodeLensModel);\n          }\n\n          _this._currentCodeLensModel = result; // cache model to reduce flicker\n\n          _this._codeLensCache.put(model, result); // render lenses\n\n\n          _this._renderCodeLensSymbols(result);\n\n          detectVisibleLenses.schedule();\n        }\n      }, onUnexpectedError);\n    }, 250);\n\n    this._localToDispose.add(scheduler);\n\n    this._localToDispose.add(detectVisibleLenses);\n\n    this._localToDispose.add(this._editor.onDidChangeModelContent(function () {\n      _this._editor.changeDecorations(function (decorationsAccessor) {\n        _this._editor.changeViewZones(function (viewZonesAccessor) {\n          var toDispose = [];\n          var lastLensLineNumber = -1;\n\n          _this._lenses.forEach(function (lens) {\n            if (!lens.isValid() || lastLensLineNumber === lens.getLineNumber()) {\n              // invalid -> lens collapsed, attach range doesn't exist anymore\n              // line_number -> lenses should never be on the same line\n              toDispose.push(lens);\n            } else {\n              lens.update(viewZonesAccessor);\n              lastLensLineNumber = lens.getLineNumber();\n            }\n          });\n\n          var helper = new CodeLensHelper();\n          toDispose.forEach(function (l) {\n            l.dispose(helper, viewZonesAccessor);\n\n            _this._lenses.splice(_this._lenses.indexOf(l), 1);\n          });\n          helper.commit(decorationsAccessor);\n        });\n      }); // Compute new `visible` code lenses\n\n\n      detectVisibleLenses.schedule(); // Ask for all references again\n\n      scheduler.schedule();\n    }));\n\n    this._localToDispose.add(this._editor.onDidScrollChange(function (e) {\n      if (e.scrollTopChanged && _this._lenses.length > 0) {\n        detectVisibleLenses.schedule();\n      }\n    }));\n\n    this._localToDispose.add(this._editor.onDidLayoutChange(function () {\n      detectVisibleLenses.schedule();\n    }));\n\n    this._localToDispose.add(toDisposable(function () {\n      if (_this._editor.getModel()) {\n        var scrollState = StableEditorScrollState.capture(_this._editor);\n\n        _this._editor.changeDecorations(function (decorationsAccessor) {\n          _this._editor.changeViewZones(function (viewZonesAccessor) {\n            _this._disposeAllLenses(decorationsAccessor, viewZonesAccessor);\n          });\n        });\n\n        scrollState.restore(_this._editor);\n      } else {\n        // No accessors available\n        _this._disposeAllLenses(undefined, undefined);\n      }\n    }));\n\n    this._localToDispose.add(this._editor.onMouseUp(function (e) {\n      var _a;\n\n      if (e.target.type !== 9\n      /* CONTENT_WIDGET */\n      ) {\n          return;\n        }\n\n      var target = e.target.element;\n\n      if ((target === null || target === void 0 ? void 0 : target.tagName) === 'SPAN') {\n        target = target.parentElement;\n      }\n\n      if ((target === null || target === void 0 ? void 0 : target.tagName) === 'A') {\n        for (var _i = 0, _b = _this._lenses; _i < _b.length; _i++) {\n          var lens = _b[_i];\n          var command = lens.getCommand(target);\n\n          if (command) {\n            (_a = _this._commandService).executeCommand.apply(_a, __spreadArrays([command.id], command.arguments || [])).catch(function (err) {\n              return _this._notificationService.error(err);\n            });\n\n            break;\n          }\n        }\n      }\n    }));\n\n    scheduler.schedule();\n  };\n\n  CodeLensContribution.prototype._disposeAllLenses = function (decChangeAccessor, viewZoneChangeAccessor) {\n    var helper = new CodeLensHelper();\n\n    for (var _i = 0, _a = this._lenses; _i < _a.length; _i++) {\n      var lens = _a[_i];\n      lens.dispose(helper, viewZoneChangeAccessor);\n    }\n\n    if (decChangeAccessor) {\n      helper.commit(decChangeAccessor);\n    }\n\n    this._lenses = [];\n  };\n\n  CodeLensContribution.prototype._renderCodeLensSymbols = function (symbols) {\n    var _this = this;\n\n    if (!this._editor.hasModel()) {\n      return;\n    }\n\n    var maxLineNumber = this._editor.getModel().getLineCount();\n\n    var groups = [];\n    var lastGroup;\n\n    for (var _i = 0, _a = symbols.lenses; _i < _a.length; _i++) {\n      var symbol = _a[_i];\n      var line = symbol.symbol.range.startLineNumber;\n\n      if (line < 1 || line > maxLineNumber) {\n        // invalid code lens\n        continue;\n      } else if (lastGroup && lastGroup[lastGroup.length - 1].symbol.range.startLineNumber === line) {\n        // on same line as previous\n        lastGroup.push(symbol);\n      } else {\n        // on later line as previous\n        lastGroup = [symbol];\n        groups.push(lastGroup);\n      }\n    }\n\n    var scrollState = StableEditorScrollState.capture(this._editor);\n\n    this._editor.changeDecorations(function (decorationsAccessor) {\n      _this._editor.changeViewZones(function (viewZoneAccessor) {\n        var helper = new CodeLensHelper();\n        var codeLensIndex = 0;\n        var groupsIndex = 0;\n\n        while (groupsIndex < groups.length && codeLensIndex < _this._lenses.length) {\n          var symbolsLineNumber = groups[groupsIndex][0].symbol.range.startLineNumber;\n\n          var codeLensLineNumber = _this._lenses[codeLensIndex].getLineNumber();\n\n          if (codeLensLineNumber < symbolsLineNumber) {\n            _this._lenses[codeLensIndex].dispose(helper, viewZoneAccessor);\n\n            _this._lenses.splice(codeLensIndex, 1);\n          } else if (codeLensLineNumber === symbolsLineNumber) {\n            _this._lenses[codeLensIndex].updateCodeLensSymbols(groups[groupsIndex], helper);\n\n            groupsIndex++;\n            codeLensIndex++;\n          } else {\n            _this._lenses.splice(codeLensIndex, 0, new CodeLensWidget(groups[groupsIndex], _this._editor, _this._styleClassName, helper, viewZoneAccessor, function () {\n              return _this._detectVisibleLenses && _this._detectVisibleLenses.schedule();\n            }));\n\n            codeLensIndex++;\n            groupsIndex++;\n          }\n        } // Delete extra code lenses\n\n\n        while (codeLensIndex < _this._lenses.length) {\n          _this._lenses[codeLensIndex].dispose(helper, viewZoneAccessor);\n\n          _this._lenses.splice(codeLensIndex, 1);\n        } // Create extra symbols\n\n\n        while (groupsIndex < groups.length) {\n          _this._lenses.push(new CodeLensWidget(groups[groupsIndex], _this._editor, _this._styleClassName, helper, viewZoneAccessor, function () {\n            return _this._detectVisibleLenses && _this._detectVisibleLenses.schedule();\n          }));\n\n          groupsIndex++;\n        }\n\n        helper.commit(decorationsAccessor);\n      });\n    });\n\n    scrollState.restore(this._editor);\n  };\n\n  CodeLensContribution.prototype._onViewportChanged = function () {\n    var _this = this;\n\n    if (this._currentResolveCodeLensSymbolsPromise) {\n      this._currentResolveCodeLensSymbolsPromise.cancel();\n\n      this._currentResolveCodeLensSymbolsPromise = undefined;\n    }\n\n    var model = this._editor.getModel();\n\n    if (!model) {\n      return;\n    }\n\n    var toResolve = [];\n    var lenses = [];\n\n    this._lenses.forEach(function (lens) {\n      var request = lens.computeIfNecessary(model);\n\n      if (request) {\n        toResolve.push(request);\n        lenses.push(lens);\n      }\n    });\n\n    if (toResolve.length === 0) {\n      return;\n    }\n\n    var resolvePromise = createCancelablePromise(function (token) {\n      var promises = toResolve.map(function (request, i) {\n        var resolvedSymbols = new Array(request.length);\n        var promises = request.map(function (request, i) {\n          if (!request.symbol.command && typeof request.provider.resolveCodeLens === 'function') {\n            return Promise.resolve(request.provider.resolveCodeLens(model, request.symbol, token)).then(function (symbol) {\n              resolvedSymbols[i] = symbol;\n            }, onUnexpectedExternalError);\n          } else {\n            resolvedSymbols[i] = request.symbol;\n            return Promise.resolve(undefined);\n          }\n        });\n        return Promise.all(promises).then(function () {\n          if (!token.isCancellationRequested && !lenses[i].isDisposed()) {\n            lenses[i].updateCommands(resolvedSymbols);\n          }\n        });\n      });\n      return Promise.all(promises);\n    });\n    this._currentResolveCodeLensSymbolsPromise = resolvePromise;\n\n    this._currentResolveCodeLensSymbolsPromise.then(function () {\n      if (_this._currentCodeLensModel) {\n        // update the cached state with new resolved items\n        _this._codeLensCache.put(model, _this._currentCodeLensModel);\n      }\n\n      _this._oldCodeLensModels.clear(); // dispose old models once we have updated the UI with the current model\n\n\n      if (resolvePromise === _this._currentResolveCodeLensSymbolsPromise) {\n        _this._currentResolveCodeLensSymbolsPromise = undefined;\n      }\n    }, function (err) {\n      onUnexpectedError(err); // can also be cancellation!\n\n      if (resolvePromise === _this._currentResolveCodeLensSymbolsPromise) {\n        _this._currentResolveCodeLensSymbolsPromise = undefined;\n      }\n    });\n  };\n\n  CodeLensContribution.ID = 'css.editor.codeLens';\n  CodeLensContribution = __decorate([__param(1, ICommandService), __param(2, INotificationService), __param(3, ICodeLensCache)], CodeLensContribution);\n  return CodeLensContribution;\n}();\n\nexport { CodeLensContribution };\nregisterEditorContribution(CodeLensContribution.ID, CodeLensContribution);","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/editor/contrib/codelens/codelensController.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__param","paramIndex","decorator","__spreadArrays","s","il","Array","k","a","j","jl","RunOnceScheduler","createCancelablePromise","disposableTimeout","onUnexpectedError","onUnexpectedExternalError","toDisposable","DisposableStore","dispose","StableEditorScrollState","registerEditorContribution","CodeLensProviderRegistry","getCodeLensData","CodeLensWidget","CodeLensHelper","ICommandService","INotificationService","ICodeLensCache","dom","hash","CodeLensContribution","_editor","_commandService","_notificationService","_codeLensCache","_this","_globalToDispose","_localToDispose","_lenses","_oldCodeLensModels","_modelChangeCounter","_isEnabled","getOption","add","onDidChangeModel","_onModelChange","onDidChangeModelLanguage","onDidChangeConfiguration","prevIsEnabled","onDidChange","e","hasChanged","_updateLensStyle","_styleClassName","getId","toString","_styleElement","createStyleSheet","isInShadowDOM","getContainerDomNode","undefined","prototype","_localDispose","_currentCodeLensModel","options","getOptions","fontInfo","get","lineHeight","height","Math","round","fontSize","newStyle","innerHTML","_currentFindCodeLensSymbolsPromise","cancel","_currentResolveCodeLensSymbolsPromise","clear","model","getModel","cachedLenses","_renderCodeLensSymbols","has","cachedLensesNow","delete","_i","_a","all","provider","registration","scheduler","schedule","detectVisibleLenses","_detectVisibleLenses","_onViewportChanged","counterValue","token","then","result","put","onDidChangeModelContent","changeDecorations","decorationsAccessor","changeViewZones","viewZonesAccessor","toDispose","lastLensLineNumber","forEach","lens","isValid","getLineNumber","push","update","helper","l","splice","indexOf","commit","onDidScrollChange","scrollTopChanged","onDidLayoutChange","scrollState","capture","_disposeAllLenses","restore","onMouseUp","type","element","tagName","parentElement","_b","command","getCommand","executeCommand","apply","id","catch","err","error","decChangeAccessor","viewZoneChangeAccessor","symbols","hasModel","maxLineNumber","getLineCount","groups","lastGroup","lenses","symbol","line","range","startLineNumber","viewZoneAccessor","codeLensIndex","groupsIndex","symbolsLineNumber","codeLensLineNumber","updateCodeLensSymbols","toResolve","request","computeIfNecessary","resolvePromise","promises","map","resolvedSymbols","resolveCodeLens","Promise","resolve","isCancellationRequested","isDisposed","updateCommands","ID"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n};\r\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n};\r\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\nimport { RunOnceScheduler, createCancelablePromise, disposableTimeout } from '../../../base/common/async.js';\r\nimport { onUnexpectedError, onUnexpectedExternalError } from '../../../base/common/errors.js';\r\nimport { toDisposable, DisposableStore, dispose } from '../../../base/common/lifecycle.js';\r\nimport { StableEditorScrollState } from '../../browser/core/editorState.js';\r\nimport { registerEditorContribution } from '../../browser/editorExtensions.js';\r\nimport { CodeLensProviderRegistry } from '../../common/modes.js';\r\nimport { getCodeLensData } from './codelens.js';\r\nimport { CodeLensWidget, CodeLensHelper } from './codelensWidget.js';\r\nimport { ICommandService } from '../../../platform/commands/common/commands.js';\r\nimport { INotificationService } from '../../../platform/notification/common/notification.js';\r\nimport { ICodeLensCache } from './codeLensCache.js';\r\nimport * as dom from '../../../base/browser/dom.js';\r\nimport { hash } from '../../../base/common/hash.js';\r\nvar CodeLensContribution = /** @class */ (function () {\r\n    function CodeLensContribution(_editor, _commandService, _notificationService, _codeLensCache) {\r\n        var _this = this;\r\n        this._editor = _editor;\r\n        this._commandService = _commandService;\r\n        this._notificationService = _notificationService;\r\n        this._codeLensCache = _codeLensCache;\r\n        this._globalToDispose = new DisposableStore();\r\n        this._localToDispose = new DisposableStore();\r\n        this._lenses = [];\r\n        this._oldCodeLensModels = new DisposableStore();\r\n        this._modelChangeCounter = 0;\r\n        this._isEnabled = this._editor.getOption(11 /* codeLens */);\r\n        this._globalToDispose.add(this._editor.onDidChangeModel(function () { return _this._onModelChange(); }));\r\n        this._globalToDispose.add(this._editor.onDidChangeModelLanguage(function () { return _this._onModelChange(); }));\r\n        this._globalToDispose.add(this._editor.onDidChangeConfiguration(function () {\r\n            var prevIsEnabled = _this._isEnabled;\r\n            _this._isEnabled = _this._editor.getOption(11 /* codeLens */);\r\n            if (prevIsEnabled !== _this._isEnabled) {\r\n                _this._onModelChange();\r\n            }\r\n        }));\r\n        this._globalToDispose.add(CodeLensProviderRegistry.onDidChange(this._onModelChange, this));\r\n        this._globalToDispose.add(this._editor.onDidChangeConfiguration(function (e) {\r\n            if (e.hasChanged(34 /* fontInfo */)) {\r\n                _this._updateLensStyle();\r\n            }\r\n        }));\r\n        this._onModelChange();\r\n        this._styleClassName = hash(this._editor.getId()).toString(16);\r\n        this._styleElement = dom.createStyleSheet(dom.isInShadowDOM(this._editor.getContainerDomNode())\r\n            ? this._editor.getContainerDomNode()\r\n            : undefined);\r\n        this._updateLensStyle();\r\n    }\r\n    CodeLensContribution.prototype.dispose = function () {\r\n        this._localDispose();\r\n        this._globalToDispose.dispose();\r\n        this._oldCodeLensModels.dispose();\r\n        dispose(this._currentCodeLensModel);\r\n    };\r\n    CodeLensContribution.prototype._updateLensStyle = function () {\r\n        var options = this._editor.getOptions();\r\n        var fontInfo = options.get(34 /* fontInfo */);\r\n        var lineHeight = options.get(49 /* lineHeight */);\r\n        var height = Math.round(lineHeight * 1.1);\r\n        var fontSize = Math.round(fontInfo.fontSize * 0.9);\r\n        var newStyle = \"\\n\\t\\t.monaco-editor .codelens-decoration.\" + this._styleClassName + \" { height: \" + height + \"px; line-height: \" + lineHeight + \"px; font-size: \" + fontSize + \"px; padding-right: \" + Math.round(fontInfo.fontSize * 0.45) + \"px;}\\n\\t\\t.monaco-editor .codelens-decoration.\" + this._styleClassName + \" > a > .codicon { line-height: \" + lineHeight + \"px; font-size: \" + fontSize + \"px; }\\n\\t\\t\";\r\n        this._styleElement.innerHTML = newStyle;\r\n    };\r\n    CodeLensContribution.prototype._localDispose = function () {\r\n        if (this._currentFindCodeLensSymbolsPromise) {\r\n            this._currentFindCodeLensSymbolsPromise.cancel();\r\n            this._currentFindCodeLensSymbolsPromise = undefined;\r\n            this._modelChangeCounter++;\r\n        }\r\n        if (this._currentResolveCodeLensSymbolsPromise) {\r\n            this._currentResolveCodeLensSymbolsPromise.cancel();\r\n            this._currentResolveCodeLensSymbolsPromise = undefined;\r\n        }\r\n        this._localToDispose.clear();\r\n        this._oldCodeLensModels.clear();\r\n        dispose(this._currentCodeLensModel);\r\n    };\r\n    CodeLensContribution.prototype._onModelChange = function () {\r\n        var _this = this;\r\n        this._localDispose();\r\n        var model = this._editor.getModel();\r\n        if (!model) {\r\n            return;\r\n        }\r\n        if (!this._isEnabled) {\r\n            return;\r\n        }\r\n        var cachedLenses = this._codeLensCache.get(model);\r\n        if (cachedLenses) {\r\n            this._renderCodeLensSymbols(cachedLenses);\r\n        }\r\n        if (!CodeLensProviderRegistry.has(model)) {\r\n            // no provider -> return but check with\r\n            // cached lenses. they expire after 30 seconds\r\n            if (cachedLenses) {\r\n                this._localToDispose.add(disposableTimeout(function () {\r\n                    var cachedLensesNow = _this._codeLensCache.get(model);\r\n                    if (cachedLenses === cachedLensesNow) {\r\n                        _this._codeLensCache.delete(model);\r\n                        _this._onModelChange();\r\n                    }\r\n                }, 30 * 1000));\r\n            }\r\n            return;\r\n        }\r\n        for (var _i = 0, _a = CodeLensProviderRegistry.all(model); _i < _a.length; _i++) {\r\n            var provider = _a[_i];\r\n            if (typeof provider.onDidChange === 'function') {\r\n                var registration = provider.onDidChange(function () { return scheduler.schedule(); });\r\n                this._localToDispose.add(registration);\r\n            }\r\n        }\r\n        var detectVisibleLenses = this._detectVisibleLenses = new RunOnceScheduler(function () { return _this._onViewportChanged(); }, 250);\r\n        var scheduler = new RunOnceScheduler(function () {\r\n            var counterValue = ++_this._modelChangeCounter;\r\n            if (_this._currentFindCodeLensSymbolsPromise) {\r\n                _this._currentFindCodeLensSymbolsPromise.cancel();\r\n            }\r\n            _this._currentFindCodeLensSymbolsPromise = createCancelablePromise(function (token) { return getCodeLensData(model, token); });\r\n            _this._currentFindCodeLensSymbolsPromise.then(function (result) {\r\n                if (counterValue === _this._modelChangeCounter) { // only the last one wins\r\n                    if (_this._currentCodeLensModel) {\r\n                        _this._oldCodeLensModels.add(_this._currentCodeLensModel);\r\n                    }\r\n                    _this._currentCodeLensModel = result;\r\n                    // cache model to reduce flicker\r\n                    _this._codeLensCache.put(model, result);\r\n                    // render lenses\r\n                    _this._renderCodeLensSymbols(result);\r\n                    detectVisibleLenses.schedule();\r\n                }\r\n            }, onUnexpectedError);\r\n        }, 250);\r\n        this._localToDispose.add(scheduler);\r\n        this._localToDispose.add(detectVisibleLenses);\r\n        this._localToDispose.add(this._editor.onDidChangeModelContent(function () {\r\n            _this._editor.changeDecorations(function (decorationsAccessor) {\r\n                _this._editor.changeViewZones(function (viewZonesAccessor) {\r\n                    var toDispose = [];\r\n                    var lastLensLineNumber = -1;\r\n                    _this._lenses.forEach(function (lens) {\r\n                        if (!lens.isValid() || lastLensLineNumber === lens.getLineNumber()) {\r\n                            // invalid -> lens collapsed, attach range doesn't exist anymore\r\n                            // line_number -> lenses should never be on the same line\r\n                            toDispose.push(lens);\r\n                        }\r\n                        else {\r\n                            lens.update(viewZonesAccessor);\r\n                            lastLensLineNumber = lens.getLineNumber();\r\n                        }\r\n                    });\r\n                    var helper = new CodeLensHelper();\r\n                    toDispose.forEach(function (l) {\r\n                        l.dispose(helper, viewZonesAccessor);\r\n                        _this._lenses.splice(_this._lenses.indexOf(l), 1);\r\n                    });\r\n                    helper.commit(decorationsAccessor);\r\n                });\r\n            });\r\n            // Compute new `visible` code lenses\r\n            detectVisibleLenses.schedule();\r\n            // Ask for all references again\r\n            scheduler.schedule();\r\n        }));\r\n        this._localToDispose.add(this._editor.onDidScrollChange(function (e) {\r\n            if (e.scrollTopChanged && _this._lenses.length > 0) {\r\n                detectVisibleLenses.schedule();\r\n            }\r\n        }));\r\n        this._localToDispose.add(this._editor.onDidLayoutChange(function () {\r\n            detectVisibleLenses.schedule();\r\n        }));\r\n        this._localToDispose.add(toDisposable(function () {\r\n            if (_this._editor.getModel()) {\r\n                var scrollState = StableEditorScrollState.capture(_this._editor);\r\n                _this._editor.changeDecorations(function (decorationsAccessor) {\r\n                    _this._editor.changeViewZones(function (viewZonesAccessor) {\r\n                        _this._disposeAllLenses(decorationsAccessor, viewZonesAccessor);\r\n                    });\r\n                });\r\n                scrollState.restore(_this._editor);\r\n            }\r\n            else {\r\n                // No accessors available\r\n                _this._disposeAllLenses(undefined, undefined);\r\n            }\r\n        }));\r\n        this._localToDispose.add(this._editor.onMouseUp(function (e) {\r\n            var _a;\r\n            if (e.target.type !== 9 /* CONTENT_WIDGET */) {\r\n                return;\r\n            }\r\n            var target = e.target.element;\r\n            if ((target === null || target === void 0 ? void 0 : target.tagName) === 'SPAN') {\r\n                target = target.parentElement;\r\n            }\r\n            if ((target === null || target === void 0 ? void 0 : target.tagName) === 'A') {\r\n                for (var _i = 0, _b = _this._lenses; _i < _b.length; _i++) {\r\n                    var lens = _b[_i];\r\n                    var command = lens.getCommand(target);\r\n                    if (command) {\r\n                        (_a = _this._commandService).executeCommand.apply(_a, __spreadArrays([command.id], (command.arguments || []))).catch(function (err) { return _this._notificationService.error(err); });\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }));\r\n        scheduler.schedule();\r\n    };\r\n    CodeLensContribution.prototype._disposeAllLenses = function (decChangeAccessor, viewZoneChangeAccessor) {\r\n        var helper = new CodeLensHelper();\r\n        for (var _i = 0, _a = this._lenses; _i < _a.length; _i++) {\r\n            var lens = _a[_i];\r\n            lens.dispose(helper, viewZoneChangeAccessor);\r\n        }\r\n        if (decChangeAccessor) {\r\n            helper.commit(decChangeAccessor);\r\n        }\r\n        this._lenses = [];\r\n    };\r\n    CodeLensContribution.prototype._renderCodeLensSymbols = function (symbols) {\r\n        var _this = this;\r\n        if (!this._editor.hasModel()) {\r\n            return;\r\n        }\r\n        var maxLineNumber = this._editor.getModel().getLineCount();\r\n        var groups = [];\r\n        var lastGroup;\r\n        for (var _i = 0, _a = symbols.lenses; _i < _a.length; _i++) {\r\n            var symbol = _a[_i];\r\n            var line = symbol.symbol.range.startLineNumber;\r\n            if (line < 1 || line > maxLineNumber) {\r\n                // invalid code lens\r\n                continue;\r\n            }\r\n            else if (lastGroup && lastGroup[lastGroup.length - 1].symbol.range.startLineNumber === line) {\r\n                // on same line as previous\r\n                lastGroup.push(symbol);\r\n            }\r\n            else {\r\n                // on later line as previous\r\n                lastGroup = [symbol];\r\n                groups.push(lastGroup);\r\n            }\r\n        }\r\n        var scrollState = StableEditorScrollState.capture(this._editor);\r\n        this._editor.changeDecorations(function (decorationsAccessor) {\r\n            _this._editor.changeViewZones(function (viewZoneAccessor) {\r\n                var helper = new CodeLensHelper();\r\n                var codeLensIndex = 0;\r\n                var groupsIndex = 0;\r\n                while (groupsIndex < groups.length && codeLensIndex < _this._lenses.length) {\r\n                    var symbolsLineNumber = groups[groupsIndex][0].symbol.range.startLineNumber;\r\n                    var codeLensLineNumber = _this._lenses[codeLensIndex].getLineNumber();\r\n                    if (codeLensLineNumber < symbolsLineNumber) {\r\n                        _this._lenses[codeLensIndex].dispose(helper, viewZoneAccessor);\r\n                        _this._lenses.splice(codeLensIndex, 1);\r\n                    }\r\n                    else if (codeLensLineNumber === symbolsLineNumber) {\r\n                        _this._lenses[codeLensIndex].updateCodeLensSymbols(groups[groupsIndex], helper);\r\n                        groupsIndex++;\r\n                        codeLensIndex++;\r\n                    }\r\n                    else {\r\n                        _this._lenses.splice(codeLensIndex, 0, new CodeLensWidget(groups[groupsIndex], _this._editor, _this._styleClassName, helper, viewZoneAccessor, function () { return _this._detectVisibleLenses && _this._detectVisibleLenses.schedule(); }));\r\n                        codeLensIndex++;\r\n                        groupsIndex++;\r\n                    }\r\n                }\r\n                // Delete extra code lenses\r\n                while (codeLensIndex < _this._lenses.length) {\r\n                    _this._lenses[codeLensIndex].dispose(helper, viewZoneAccessor);\r\n                    _this._lenses.splice(codeLensIndex, 1);\r\n                }\r\n                // Create extra symbols\r\n                while (groupsIndex < groups.length) {\r\n                    _this._lenses.push(new CodeLensWidget(groups[groupsIndex], _this._editor, _this._styleClassName, helper, viewZoneAccessor, function () { return _this._detectVisibleLenses && _this._detectVisibleLenses.schedule(); }));\r\n                    groupsIndex++;\r\n                }\r\n                helper.commit(decorationsAccessor);\r\n            });\r\n        });\r\n        scrollState.restore(this._editor);\r\n    };\r\n    CodeLensContribution.prototype._onViewportChanged = function () {\r\n        var _this = this;\r\n        if (this._currentResolveCodeLensSymbolsPromise) {\r\n            this._currentResolveCodeLensSymbolsPromise.cancel();\r\n            this._currentResolveCodeLensSymbolsPromise = undefined;\r\n        }\r\n        var model = this._editor.getModel();\r\n        if (!model) {\r\n            return;\r\n        }\r\n        var toResolve = [];\r\n        var lenses = [];\r\n        this._lenses.forEach(function (lens) {\r\n            var request = lens.computeIfNecessary(model);\r\n            if (request) {\r\n                toResolve.push(request);\r\n                lenses.push(lens);\r\n            }\r\n        });\r\n        if (toResolve.length === 0) {\r\n            return;\r\n        }\r\n        var resolvePromise = createCancelablePromise(function (token) {\r\n            var promises = toResolve.map(function (request, i) {\r\n                var resolvedSymbols = new Array(request.length);\r\n                var promises = request.map(function (request, i) {\r\n                    if (!request.symbol.command && typeof request.provider.resolveCodeLens === 'function') {\r\n                        return Promise.resolve(request.provider.resolveCodeLens(model, request.symbol, token)).then(function (symbol) {\r\n                            resolvedSymbols[i] = symbol;\r\n                        }, onUnexpectedExternalError);\r\n                    }\r\n                    else {\r\n                        resolvedSymbols[i] = request.symbol;\r\n                        return Promise.resolve(undefined);\r\n                    }\r\n                });\r\n                return Promise.all(promises).then(function () {\r\n                    if (!token.isCancellationRequested && !lenses[i].isDisposed()) {\r\n                        lenses[i].updateCommands(resolvedSymbols);\r\n                    }\r\n                });\r\n            });\r\n            return Promise.all(promises);\r\n        });\r\n        this._currentResolveCodeLensSymbolsPromise = resolvePromise;\r\n        this._currentResolveCodeLensSymbolsPromise.then(function () {\r\n            if (_this._currentCodeLensModel) { // update the cached state with new resolved items\r\n                _this._codeLensCache.put(model, _this._currentCodeLensModel);\r\n            }\r\n            _this._oldCodeLensModels.clear(); // dispose old models once we have updated the UI with the current model\r\n            if (resolvePromise === _this._currentResolveCodeLensSymbolsPromise) {\r\n                _this._currentResolveCodeLensSymbolsPromise = undefined;\r\n            }\r\n        }, function (err) {\r\n            onUnexpectedError(err); // can also be cancellation!\r\n            if (resolvePromise === _this._currentResolveCodeLensSymbolsPromise) {\r\n                _this._currentResolveCodeLensSymbolsPromise = undefined;\r\n            }\r\n        });\r\n    };\r\n    CodeLensContribution.ID = 'css.editor.codeLens';\r\n    CodeLensContribution = __decorate([\r\n        __param(1, ICommandService),\r\n        __param(2, INotificationService),\r\n        __param(3, ICodeLensCache)\r\n    ], CodeLensContribution);\r\n    return CodeLensContribution;\r\n}());\r\nexport { CodeLensContribution };\r\nregisterEditorContribution(CodeLensContribution.ID, CodeLensContribution);\r\n"]},"metadata":{},"sourceType":"module"}