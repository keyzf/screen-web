{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nimport { IntervalTimer } from '../../../base/common/async.js';\nimport { Disposable, dispose, toDisposable, DisposableStore } from '../../../base/common/lifecycle.js';\nimport { SimpleWorkerClient, logOnceWebWorkerWarning } from '../../../base/common/worker/simpleWorker.js';\nimport { DefaultWorkerFactory } from '../../../base/worker/defaultWorkerFactory.js';\nimport { Range } from '../core/range.js';\nimport * as modes from '../modes.js';\nimport { LanguageConfigurationRegistry } from '../modes/languageConfigurationRegistry.js';\nimport { EditorSimpleWorker } from './editorSimpleWorker.js';\nimport { IModelService } from './modelService.js';\nimport { ITextResourceConfigurationService } from './textResourceConfigurationService.js';\nimport { regExpFlags } from '../../../base/common/strings.js';\nimport { isNonEmptyArray } from '../../../base/common/arrays.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { StopWatch } from '../../../base/common/stopwatch.js';\n/**\r\n * Stop syncing a model to the worker if it was not needed for 1 min.\r\n */\n\nvar STOP_SYNC_MODEL_DELTA_TIME_MS = 60 * 1000;\n/**\r\n * Stop the worker if it was not needed for 5 min.\r\n */\n\nvar STOP_WORKER_DELTA_TIME_MS = 5 * 60 * 1000;\n\nfunction canSyncModel(modelService, resource) {\n  var model = modelService.getModel(resource);\n\n  if (!model) {\n    return false;\n  }\n\n  if (model.isTooLargeForSyncing()) {\n    return false;\n  }\n\n  return true;\n}\n\nvar EditorWorkerServiceImpl =\n/** @class */\nfunction (_super) {\n  __extends(EditorWorkerServiceImpl, _super);\n\n  function EditorWorkerServiceImpl(modelService, configurationService, logService) {\n    var _this = _super.call(this) || this;\n\n    _this._modelService = modelService;\n    _this._workerManager = _this._register(new WorkerManager(_this._modelService));\n    _this._logService = logService; // todo@joh make sure this happens only once\n\n    _this._register(modes.LinkProviderRegistry.register('*', {\n      provideLinks: function (model, token) {\n        if (!canSyncModel(_this._modelService, model.uri)) {\n          return Promise.resolve({\n            links: []\n          }); // File too large\n        }\n\n        return _this._workerManager.withWorker().then(function (client) {\n          return client.computeLinks(model.uri);\n        }).then(function (links) {\n          return links && {\n            links: links\n          };\n        });\n      }\n    }));\n\n    _this._register(modes.CompletionProviderRegistry.register('*', new WordBasedCompletionItemProvider(_this._workerManager, configurationService, _this._modelService)));\n\n    return _this;\n  }\n\n  EditorWorkerServiceImpl.prototype.dispose = function () {\n    _super.prototype.dispose.call(this);\n  };\n\n  EditorWorkerServiceImpl.prototype.canComputeDiff = function (original, modified) {\n    return canSyncModel(this._modelService, original) && canSyncModel(this._modelService, modified);\n  };\n\n  EditorWorkerServiceImpl.prototype.computeDiff = function (original, modified, ignoreTrimWhitespace, maxComputationTime) {\n    return this._workerManager.withWorker().then(function (client) {\n      return client.computeDiff(original, modified, ignoreTrimWhitespace, maxComputationTime);\n    });\n  };\n\n  EditorWorkerServiceImpl.prototype.computeMoreMinimalEdits = function (resource, edits) {\n    var _this = this;\n\n    if (isNonEmptyArray(edits)) {\n      if (!canSyncModel(this._modelService, resource)) {\n        return Promise.resolve(edits); // File too large\n      }\n\n      var sw_1 = StopWatch.create(true);\n\n      var result = this._workerManager.withWorker().then(function (client) {\n        return client.computeMoreMinimalEdits(resource, edits);\n      });\n\n      result.finally(function () {\n        return _this._logService.trace('FORMAT#computeMoreMinimalEdits', resource.toString(true), sw_1.elapsed());\n      });\n      return result;\n    } else {\n      return Promise.resolve(undefined);\n    }\n  };\n\n  EditorWorkerServiceImpl.prototype.canNavigateValueSet = function (resource) {\n    return canSyncModel(this._modelService, resource);\n  };\n\n  EditorWorkerServiceImpl.prototype.navigateValueSet = function (resource, range, up) {\n    return this._workerManager.withWorker().then(function (client) {\n      return client.navigateValueSet(resource, range, up);\n    });\n  };\n\n  EditorWorkerServiceImpl.prototype.canComputeWordRanges = function (resource) {\n    return canSyncModel(this._modelService, resource);\n  };\n\n  EditorWorkerServiceImpl.prototype.computeWordRanges = function (resource, range) {\n    return this._workerManager.withWorker().then(function (client) {\n      return client.computeWordRanges(resource, range);\n    });\n  };\n\n  EditorWorkerServiceImpl = __decorate([__param(0, IModelService), __param(1, ITextResourceConfigurationService), __param(2, ILogService)], EditorWorkerServiceImpl);\n  return EditorWorkerServiceImpl;\n}(Disposable);\n\nexport { EditorWorkerServiceImpl };\n\nvar WordBasedCompletionItemProvider =\n/** @class */\nfunction () {\n  function WordBasedCompletionItemProvider(workerManager, configurationService, modelService) {\n    this._debugDisplayName = 'wordbasedCompletions';\n    this._workerManager = workerManager;\n    this._configurationService = configurationService;\n    this._modelService = modelService;\n  }\n\n  WordBasedCompletionItemProvider.prototype.provideCompletionItems = function (model, position) {\n    return __awaiter(this, void 0, void 0, function () {\n      var wordBasedSuggestions, word, replace, insert, client, words;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            wordBasedSuggestions = this._configurationService.getValue(model.uri, position, 'editor').wordBasedSuggestions;\n\n            if (!wordBasedSuggestions) {\n              return [2\n              /*return*/\n              , undefined];\n            }\n\n            if (!canSyncModel(this._modelService, model.uri)) {\n              return [2\n              /*return*/\n              , undefined]; // File too large\n            }\n\n            word = model.getWordAtPosition(position);\n            replace = !word ? Range.fromPositions(position) : new Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn);\n            insert = replace.setEndPosition(position.lineNumber, position.column);\n            return [4\n            /*yield*/\n            , this._workerManager.withWorker()];\n\n          case 1:\n            client = _a.sent();\n            return [4\n            /*yield*/\n            , client.textualSuggest(model.uri, position)];\n\n          case 2:\n            words = _a.sent();\n\n            if (!words) {\n              return [2\n              /*return*/\n              , undefined];\n            }\n\n            return [2\n            /*return*/\n            , {\n              suggestions: words.map(function (word) {\n                return {\n                  kind: 18\n                  /* Text */\n                  ,\n                  label: word,\n                  insertText: word,\n                  range: {\n                    insert: insert,\n                    replace: replace\n                  }\n                };\n              })\n            }];\n        }\n      });\n    });\n  };\n\n  return WordBasedCompletionItemProvider;\n}();\n\nvar WorkerManager =\n/** @class */\nfunction (_super) {\n  __extends(WorkerManager, _super);\n\n  function WorkerManager(modelService) {\n    var _this = _super.call(this) || this;\n\n    _this._modelService = modelService;\n    _this._editorWorkerClient = null;\n    _this._lastWorkerUsedTime = new Date().getTime();\n\n    var stopWorkerInterval = _this._register(new IntervalTimer());\n\n    stopWorkerInterval.cancelAndSet(function () {\n      return _this._checkStopIdleWorker();\n    }, Math.round(STOP_WORKER_DELTA_TIME_MS / 2));\n\n    _this._register(_this._modelService.onModelRemoved(function (_) {\n      return _this._checkStopEmptyWorker();\n    }));\n\n    return _this;\n  }\n\n  WorkerManager.prototype.dispose = function () {\n    if (this._editorWorkerClient) {\n      this._editorWorkerClient.dispose();\n\n      this._editorWorkerClient = null;\n    }\n\n    _super.prototype.dispose.call(this);\n  };\n  /**\r\n   * Check if the model service has no more models and stop the worker if that is the case.\r\n   */\n\n\n  WorkerManager.prototype._checkStopEmptyWorker = function () {\n    if (!this._editorWorkerClient) {\n      return;\n    }\n\n    var models = this._modelService.getModels();\n\n    if (models.length === 0) {\n      // There are no more models => nothing possible for me to do\n      this._editorWorkerClient.dispose();\n\n      this._editorWorkerClient = null;\n    }\n  };\n  /**\r\n   * Check if the worker has been idle for a while and then stop it.\r\n   */\n\n\n  WorkerManager.prototype._checkStopIdleWorker = function () {\n    if (!this._editorWorkerClient) {\n      return;\n    }\n\n    var timeSinceLastWorkerUsedTime = new Date().getTime() - this._lastWorkerUsedTime;\n\n    if (timeSinceLastWorkerUsedTime > STOP_WORKER_DELTA_TIME_MS) {\n      this._editorWorkerClient.dispose();\n\n      this._editorWorkerClient = null;\n    }\n  };\n\n  WorkerManager.prototype.withWorker = function () {\n    this._lastWorkerUsedTime = new Date().getTime();\n\n    if (!this._editorWorkerClient) {\n      this._editorWorkerClient = new EditorWorkerClient(this._modelService, false, 'editorWorkerService');\n    }\n\n    return Promise.resolve(this._editorWorkerClient);\n  };\n\n  return WorkerManager;\n}(Disposable);\n\nvar EditorModelManager =\n/** @class */\nfunction (_super) {\n  __extends(EditorModelManager, _super);\n\n  function EditorModelManager(proxy, modelService, keepIdleModels) {\n    var _this = _super.call(this) || this;\n\n    _this._syncedModels = Object.create(null);\n    _this._syncedModelsLastUsedTime = Object.create(null);\n    _this._proxy = proxy;\n    _this._modelService = modelService;\n\n    if (!keepIdleModels) {\n      var timer = new IntervalTimer();\n      timer.cancelAndSet(function () {\n        return _this._checkStopModelSync();\n      }, Math.round(STOP_SYNC_MODEL_DELTA_TIME_MS / 2));\n\n      _this._register(timer);\n    }\n\n    return _this;\n  }\n\n  EditorModelManager.prototype.dispose = function () {\n    for (var modelUrl in this._syncedModels) {\n      dispose(this._syncedModels[modelUrl]);\n    }\n\n    this._syncedModels = Object.create(null);\n    this._syncedModelsLastUsedTime = Object.create(null);\n\n    _super.prototype.dispose.call(this);\n  };\n\n  EditorModelManager.prototype.ensureSyncedResources = function (resources) {\n    for (var _i = 0, resources_1 = resources; _i < resources_1.length; _i++) {\n      var resource = resources_1[_i];\n      var resourceStr = resource.toString();\n\n      if (!this._syncedModels[resourceStr]) {\n        this._beginModelSync(resource);\n      }\n\n      if (this._syncedModels[resourceStr]) {\n        this._syncedModelsLastUsedTime[resourceStr] = new Date().getTime();\n      }\n    }\n  };\n\n  EditorModelManager.prototype._checkStopModelSync = function () {\n    var currentTime = new Date().getTime();\n    var toRemove = [];\n\n    for (var modelUrl in this._syncedModelsLastUsedTime) {\n      var elapsedTime = currentTime - this._syncedModelsLastUsedTime[modelUrl];\n\n      if (elapsedTime > STOP_SYNC_MODEL_DELTA_TIME_MS) {\n        toRemove.push(modelUrl);\n      }\n    }\n\n    for (var _i = 0, toRemove_1 = toRemove; _i < toRemove_1.length; _i++) {\n      var e = toRemove_1[_i];\n\n      this._stopModelSync(e);\n    }\n  };\n\n  EditorModelManager.prototype._beginModelSync = function (resource) {\n    var _this = this;\n\n    var model = this._modelService.getModel(resource);\n\n    if (!model) {\n      return;\n    }\n\n    if (model.isTooLargeForSyncing()) {\n      return;\n    }\n\n    var modelUrl = resource.toString();\n\n    this._proxy.acceptNewModel({\n      url: model.uri.toString(),\n      lines: model.getLinesContent(),\n      EOL: model.getEOL(),\n      versionId: model.getVersionId()\n    });\n\n    var toDispose = new DisposableStore();\n    toDispose.add(model.onDidChangeContent(function (e) {\n      _this._proxy.acceptModelChanged(modelUrl.toString(), e);\n    }));\n    toDispose.add(model.onWillDispose(function () {\n      _this._stopModelSync(modelUrl);\n    }));\n    toDispose.add(toDisposable(function () {\n      _this._proxy.acceptRemovedModel(modelUrl);\n    }));\n    this._syncedModels[modelUrl] = toDispose;\n  };\n\n  EditorModelManager.prototype._stopModelSync = function (modelUrl) {\n    var toDispose = this._syncedModels[modelUrl];\n    delete this._syncedModels[modelUrl];\n    delete this._syncedModelsLastUsedTime[modelUrl];\n    dispose(toDispose);\n  };\n\n  return EditorModelManager;\n}(Disposable);\n\nvar SynchronousWorkerClient =\n/** @class */\nfunction () {\n  function SynchronousWorkerClient(instance) {\n    this._instance = instance;\n    this._proxyObj = Promise.resolve(this._instance);\n  }\n\n  SynchronousWorkerClient.prototype.dispose = function () {\n    this._instance.dispose();\n  };\n\n  SynchronousWorkerClient.prototype.getProxyObject = function () {\n    return this._proxyObj;\n  };\n\n  return SynchronousWorkerClient;\n}();\n\nvar EditorWorkerHost =\n/** @class */\nfunction () {\n  function EditorWorkerHost(workerClient) {\n    this._workerClient = workerClient;\n  } // foreign host request\n\n\n  EditorWorkerHost.prototype.fhr = function (method, args) {\n    return this._workerClient.fhr(method, args);\n  };\n\n  return EditorWorkerHost;\n}();\n\nexport { EditorWorkerHost };\n\nvar EditorWorkerClient =\n/** @class */\nfunction (_super) {\n  __extends(EditorWorkerClient, _super);\n\n  function EditorWorkerClient(modelService, keepIdleModels, label) {\n    var _this = _super.call(this) || this;\n\n    _this._modelService = modelService;\n    _this._keepIdleModels = keepIdleModels;\n    _this._workerFactory = new DefaultWorkerFactory(label);\n    _this._worker = null;\n    _this._modelManager = null;\n    return _this;\n  } // foreign host request\n\n\n  EditorWorkerClient.prototype.fhr = function (method, args) {\n    throw new Error(\"Not implemented!\");\n  };\n\n  EditorWorkerClient.prototype._getOrCreateWorker = function () {\n    if (!this._worker) {\n      try {\n        this._worker = this._register(new SimpleWorkerClient(this._workerFactory, 'vs/editor/common/services/editorSimpleWorker', new EditorWorkerHost(this)));\n      } catch (err) {\n        logOnceWebWorkerWarning(err);\n        this._worker = new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this), null));\n      }\n    }\n\n    return this._worker;\n  };\n\n  EditorWorkerClient.prototype._getProxy = function () {\n    var _this = this;\n\n    return this._getOrCreateWorker().getProxyObject().then(undefined, function (err) {\n      logOnceWebWorkerWarning(err);\n      _this._worker = new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(_this), null));\n      return _this._getOrCreateWorker().getProxyObject();\n    });\n  };\n\n  EditorWorkerClient.prototype._getOrCreateModelManager = function (proxy) {\n    if (!this._modelManager) {\n      this._modelManager = this._register(new EditorModelManager(proxy, this._modelService, this._keepIdleModels));\n    }\n\n    return this._modelManager;\n  };\n\n  EditorWorkerClient.prototype._withSyncedResources = function (resources) {\n    var _this = this;\n\n    return this._getProxy().then(function (proxy) {\n      _this._getOrCreateModelManager(proxy).ensureSyncedResources(resources);\n\n      return proxy;\n    });\n  };\n\n  EditorWorkerClient.prototype.computeDiff = function (original, modified, ignoreTrimWhitespace, maxComputationTime) {\n    return this._withSyncedResources([original, modified]).then(function (proxy) {\n      return proxy.computeDiff(original.toString(), modified.toString(), ignoreTrimWhitespace, maxComputationTime);\n    });\n  };\n\n  EditorWorkerClient.prototype.computeMoreMinimalEdits = function (resource, edits) {\n    return this._withSyncedResources([resource]).then(function (proxy) {\n      return proxy.computeMoreMinimalEdits(resource.toString(), edits);\n    });\n  };\n\n  EditorWorkerClient.prototype.computeLinks = function (resource) {\n    return this._withSyncedResources([resource]).then(function (proxy) {\n      return proxy.computeLinks(resource.toString());\n    });\n  };\n\n  EditorWorkerClient.prototype.textualSuggest = function (resource, position) {\n    var _this = this;\n\n    return this._withSyncedResources([resource]).then(function (proxy) {\n      var model = _this._modelService.getModel(resource);\n\n      if (!model) {\n        return null;\n      }\n\n      var wordDefRegExp = LanguageConfigurationRegistry.getWordDefinition(model.getLanguageIdentifier().id);\n      var wordDef = wordDefRegExp.source;\n      var wordDefFlags = regExpFlags(wordDefRegExp);\n      return proxy.textualSuggest(resource.toString(), position, wordDef, wordDefFlags);\n    });\n  };\n\n  EditorWorkerClient.prototype.computeWordRanges = function (resource, range) {\n    var _this = this;\n\n    return this._withSyncedResources([resource]).then(function (proxy) {\n      var model = _this._modelService.getModel(resource);\n\n      if (!model) {\n        return Promise.resolve(null);\n      }\n\n      var wordDefRegExp = LanguageConfigurationRegistry.getWordDefinition(model.getLanguageIdentifier().id);\n      var wordDef = wordDefRegExp.source;\n      var wordDefFlags = regExpFlags(wordDefRegExp);\n      return proxy.computeWordRanges(resource.toString(), range, wordDef, wordDefFlags);\n    });\n  };\n\n  EditorWorkerClient.prototype.navigateValueSet = function (resource, range, up) {\n    var _this = this;\n\n    return this._withSyncedResources([resource]).then(function (proxy) {\n      var model = _this._modelService.getModel(resource);\n\n      if (!model) {\n        return null;\n      }\n\n      var wordDefRegExp = LanguageConfigurationRegistry.getWordDefinition(model.getLanguageIdentifier().id);\n      var wordDef = wordDefRegExp.source;\n      var wordDefFlags = regExpFlags(wordDefRegExp);\n      return proxy.navigateValueSet(resource.toString(), range, up, wordDef, wordDefFlags);\n    });\n  };\n\n  return EditorWorkerClient;\n}(Disposable);\n\nexport { EditorWorkerClient };","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/editor/common/services/editorWorkerServiceImpl.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__decorate","decorators","target","key","desc","c","arguments","length","r","getOwnPropertyDescriptor","Reflect","decorate","i","defineProperty","__param","paramIndex","decorator","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","__generator","body","_","label","sent","t","trys","ops","f","y","g","verb","Symbol","iterator","n","v","op","TypeError","call","pop","push","IntervalTimer","Disposable","dispose","toDisposable","DisposableStore","SimpleWorkerClient","logOnceWebWorkerWarning","DefaultWorkerFactory","Range","modes","LanguageConfigurationRegistry","EditorSimpleWorker","IModelService","ITextResourceConfigurationService","regExpFlags","isNonEmptyArray","ILogService","StopWatch","STOP_SYNC_MODEL_DELTA_TIME_MS","STOP_WORKER_DELTA_TIME_MS","canSyncModel","modelService","resource","model","getModel","isTooLargeForSyncing","EditorWorkerServiceImpl","_super","configurationService","logService","_this","_modelService","_workerManager","_register","WorkerManager","_logService","LinkProviderRegistry","register","provideLinks","token","uri","links","withWorker","client","computeLinks","CompletionProviderRegistry","WordBasedCompletionItemProvider","canComputeDiff","original","modified","computeDiff","ignoreTrimWhitespace","maxComputationTime","computeMoreMinimalEdits","edits","sw_1","finally","trace","toString","elapsed","undefined","canNavigateValueSet","navigateValueSet","range","up","canComputeWordRanges","computeWordRanges","workerManager","_debugDisplayName","_configurationService","provideCompletionItems","position","wordBasedSuggestions","word","replace","insert","words","_a","getValue","getWordAtPosition","fromPositions","lineNumber","startColumn","endColumn","setEndPosition","column","textualSuggest","suggestions","map","kind","insertText","_editorWorkerClient","_lastWorkerUsedTime","Date","getTime","stopWorkerInterval","cancelAndSet","_checkStopIdleWorker","Math","round","onModelRemoved","_checkStopEmptyWorker","models","getModels","timeSinceLastWorkerUsedTime","EditorWorkerClient","EditorModelManager","proxy","keepIdleModels","_syncedModels","_syncedModelsLastUsedTime","_proxy","timer","_checkStopModelSync","modelUrl","ensureSyncedResources","resources","_i","resources_1","resourceStr","_beginModelSync","currentTime","toRemove","elapsedTime","toRemove_1","_stopModelSync","acceptNewModel","url","lines","getLinesContent","EOL","getEOL","versionId","getVersionId","toDispose","add","onDidChangeContent","acceptModelChanged","onWillDispose","acceptRemovedModel","SynchronousWorkerClient","instance","_instance","_proxyObj","getProxyObject","EditorWorkerHost","workerClient","_workerClient","fhr","method","args","_keepIdleModels","_workerFactory","_worker","_modelManager","Error","_getOrCreateWorker","err","_getProxy","_getOrCreateModelManager","_withSyncedResources","wordDefRegExp","getWordDefinition","getLanguageIdentifier","id","wordDef","source","wordDefFlags"],"mappings":"AAAA;;;;AAIA,IAAIA,SAAS,GAAI,QAAQ,KAAKA,SAAd,IAA6B,YAAY;AACrD,MAAIC,aAAa,GAAG,UAAUC,CAAV,EAAaC,CAAb,EAAgB;AAChCF,IAAAA,aAAa,GAAGG,MAAM,CAACC,cAAP,IACX;AAAEC,MAAAA,SAAS,EAAE;AAAb,iBAA6BC,KAA7B,IAAsC,UAAUL,CAAV,EAAaC,CAAb,EAAgB;AAAED,MAAAA,CAAC,CAACI,SAAF,GAAcH,CAAd;AAAkB,KAD/D,IAEZ,UAAUD,CAAV,EAAaC,CAAb,EAAgB;AAAE,WAAK,IAAIK,CAAT,IAAcL,CAAd,EAAiB,IAAIA,CAAC,CAACM,cAAF,CAAiBD,CAAjB,CAAJ,EAAyBN,CAAC,CAACM,CAAD,CAAD,GAAOL,CAAC,CAACK,CAAD,CAAR;AAAc,KAF9E;;AAGA,WAAOP,aAAa,CAACC,CAAD,EAAIC,CAAJ,CAApB;AACH,GALD;;AAMA,SAAO,UAAUD,CAAV,EAAaC,CAAb,EAAgB;AACnBF,IAAAA,aAAa,CAACC,CAAD,EAAIC,CAAJ,CAAb;;AACA,aAASO,EAAT,GAAc;AAAE,WAAKC,WAAL,GAAmBT,CAAnB;AAAuB;;AACvCA,IAAAA,CAAC,CAACU,SAAF,GAAcT,CAAC,KAAK,IAAN,GAAaC,MAAM,CAACS,MAAP,CAAcV,CAAd,CAAb,IAAiCO,EAAE,CAACE,SAAH,GAAeT,CAAC,CAACS,SAAjB,EAA4B,IAAIF,EAAJ,EAA7D,CAAd;AACH,GAJD;AAKH,CAZ2C,EAA5C;;AAaA,IAAII,UAAU,GAAI,QAAQ,KAAKA,UAAd,IAA6B,UAAUC,UAAV,EAAsBC,MAAtB,EAA8BC,GAA9B,EAAmCC,IAAnC,EAAyC;AACnF,MAAIC,CAAC,GAAGC,SAAS,CAACC,MAAlB;AAAA,MAA0BC,CAAC,GAAGH,CAAC,GAAG,CAAJ,GAAQH,MAAR,GAAiBE,IAAI,KAAK,IAAT,GAAgBA,IAAI,GAAGd,MAAM,CAACmB,wBAAP,CAAgCP,MAAhC,EAAwCC,GAAxC,CAAvB,GAAsEC,IAArH;AAAA,MAA2HhB,CAA3H;AACA,MAAI,OAAOsB,OAAP,KAAmB,QAAnB,IAA+B,OAAOA,OAAO,CAACC,QAAf,KAA4B,UAA/D,EAA2EH,CAAC,GAAGE,OAAO,CAACC,QAAR,CAAiBV,UAAjB,EAA6BC,MAA7B,EAAqCC,GAArC,EAA0CC,IAA1C,CAAJ,CAA3E,KACK,KAAK,IAAIQ,CAAC,GAAGX,UAAU,CAACM,MAAX,GAAoB,CAAjC,EAAoCK,CAAC,IAAI,CAAzC,EAA4CA,CAAC,EAA7C,EAAiD,IAAIxB,CAAC,GAAGa,UAAU,CAACW,CAAD,CAAlB,EAAuBJ,CAAC,GAAG,CAACH,CAAC,GAAG,CAAJ,GAAQjB,CAAC,CAACoB,CAAD,CAAT,GAAeH,CAAC,GAAG,CAAJ,GAAQjB,CAAC,CAACc,MAAD,EAASC,GAAT,EAAcK,CAAd,CAAT,GAA4BpB,CAAC,CAACc,MAAD,EAASC,GAAT,CAA7C,KAA+DK,CAAnE;AAC7E,SAAOH,CAAC,GAAG,CAAJ,IAASG,CAAT,IAAclB,MAAM,CAACuB,cAAP,CAAsBX,MAAtB,EAA8BC,GAA9B,EAAmCK,CAAnC,CAAd,EAAqDA,CAA5D;AACH,CALD;;AAMA,IAAIM,OAAO,GAAI,QAAQ,KAAKA,OAAd,IAA0B,UAAUC,UAAV,EAAsBC,SAAtB,EAAiC;AACrE,SAAO,UAAUd,MAAV,EAAkBC,GAAlB,EAAuB;AAAEa,IAAAA,SAAS,CAACd,MAAD,EAASC,GAAT,EAAcY,UAAd,CAAT;AAAqC,GAArE;AACH,CAFD;;AAGA,IAAIE,SAAS,GAAI,QAAQ,KAAKA,SAAd,IAA4B,UAAUC,OAAV,EAAmBC,UAAnB,EAA+BC,CAA/B,EAAkCC,SAAlC,EAA6C;AACrF,WAASC,KAAT,CAAeC,KAAf,EAAsB;AAAE,WAAOA,KAAK,YAAYH,CAAjB,GAAqBG,KAArB,GAA6B,IAAIH,CAAJ,CAAM,UAAUI,OAAV,EAAmB;AAAEA,MAAAA,OAAO,CAACD,KAAD,CAAP;AAAiB,KAA5C,CAApC;AAAoF;;AAC5G,SAAO,KAAKH,CAAC,KAAKA,CAAC,GAAGK,OAAT,CAAN,EAAyB,UAAUD,OAAV,EAAmBE,MAAnB,EAA2B;AACvD,aAASC,SAAT,CAAmBJ,KAAnB,EAA0B;AAAE,UAAI;AAAEK,QAAAA,IAAI,CAACP,SAAS,CAACQ,IAAV,CAAeN,KAAf,CAAD,CAAJ;AAA8B,OAApC,CAAqC,OAAOO,CAAP,EAAU;AAAEJ,QAAAA,MAAM,CAACI,CAAD,CAAN;AAAY;AAAE;;AAC3F,aAASC,QAAT,CAAkBR,KAAlB,EAAyB;AAAE,UAAI;AAAEK,QAAAA,IAAI,CAACP,SAAS,CAAC,OAAD,CAAT,CAAmBE,KAAnB,CAAD,CAAJ;AAAkC,OAAxC,CAAyC,OAAOO,CAAP,EAAU;AAAEJ,QAAAA,MAAM,CAACI,CAAD,CAAN;AAAY;AAAE;;AAC9F,aAASF,IAAT,CAAcI,MAAd,EAAsB;AAAEA,MAAAA,MAAM,CAACC,IAAP,GAAcT,OAAO,CAACQ,MAAM,CAACT,KAAR,CAArB,GAAsCD,KAAK,CAACU,MAAM,CAACT,KAAR,CAAL,CAAoBW,IAApB,CAAyBP,SAAzB,EAAoCI,QAApC,CAAtC;AAAsF;;AAC9GH,IAAAA,IAAI,CAAC,CAACP,SAAS,GAAGA,SAAS,CAACc,KAAV,CAAgBjB,OAAhB,EAAyBC,UAAU,IAAI,EAAvC,CAAb,EAAyDU,IAAzD,EAAD,CAAJ;AACH,GALM,CAAP;AAMH,CARD;;AASA,IAAIO,WAAW,GAAI,QAAQ,KAAKA,WAAd,IAA8B,UAAUlB,OAAV,EAAmBmB,IAAnB,EAAyB;AACrE,MAAIC,CAAC,GAAG;AAAEC,IAAAA,KAAK,EAAE,CAAT;AAAYC,IAAAA,IAAI,EAAE,YAAW;AAAE,UAAIC,CAAC,CAAC,CAAD,CAAD,GAAO,CAAX,EAAc,MAAMA,CAAC,CAAC,CAAD,CAAP;AAAY,aAAOA,CAAC,CAAC,CAAD,CAAR;AAAc,KAAvE;AAAyEC,IAAAA,IAAI,EAAE,EAA/E;AAAmFC,IAAAA,GAAG,EAAE;AAAxF,GAAR;AAAA,MAAsGC,CAAtG;AAAA,MAAyGC,CAAzG;AAAA,MAA4GJ,CAA5G;AAAA,MAA+GK,CAA/G;AACA,SAAOA,CAAC,GAAG;AAAEjB,IAAAA,IAAI,EAAEkB,IAAI,CAAC,CAAD,CAAZ;AAAiB,aAASA,IAAI,CAAC,CAAD,CAA9B;AAAmC,cAAUA,IAAI,CAAC,CAAD;AAAjD,GAAJ,EAA4D,OAAOC,MAAP,KAAkB,UAAlB,KAAiCF,CAAC,CAACE,MAAM,CAACC,QAAR,CAAD,GAAqB,YAAW;AAAE,WAAO,IAAP;AAAc,GAAjF,CAA5D,EAAgJH,CAAvJ;;AACA,WAASC,IAAT,CAAcG,CAAd,EAAiB;AAAE,WAAO,UAAUC,CAAV,EAAa;AAAE,aAAOvB,IAAI,CAAC,CAACsB,CAAD,EAAIC,CAAJ,CAAD,CAAX;AAAsB,KAA5C;AAA+C;;AAClE,WAASvB,IAAT,CAAcwB,EAAd,EAAkB;AACd,QAAIR,CAAJ,EAAO,MAAM,IAAIS,SAAJ,CAAc,iCAAd,CAAN;;AACP,WAAOf,CAAP,EAAU,IAAI;AACV,UAAIM,CAAC,GAAG,CAAJ,EAAOC,CAAC,KAAKJ,CAAC,GAAGW,EAAE,CAAC,CAAD,CAAF,GAAQ,CAAR,GAAYP,CAAC,CAAC,QAAD,CAAb,GAA0BO,EAAE,CAAC,CAAD,CAAF,GAAQP,CAAC,CAAC,OAAD,CAAD,KAAe,CAACJ,CAAC,GAAGI,CAAC,CAAC,QAAD,CAAN,KAAqBJ,CAAC,CAACa,IAAF,CAAOT,CAAP,CAArB,EAAgC,CAA/C,CAAR,GAA4DA,CAAC,CAAChB,IAAjG,CAAD,IAA2G,CAAC,CAACY,CAAC,GAAGA,CAAC,CAACa,IAAF,CAAOT,CAAP,EAAUO,EAAE,CAAC,CAAD,CAAZ,CAAL,EAAuBnB,IAA9I,EAAoJ,OAAOQ,CAAP;AACpJ,UAAII,CAAC,GAAG,CAAJ,EAAOJ,CAAX,EAAcW,EAAE,GAAG,CAACA,EAAE,CAAC,CAAD,CAAF,GAAQ,CAAT,EAAYX,CAAC,CAAClB,KAAd,CAAL;;AACd,cAAQ6B,EAAE,CAAC,CAAD,CAAV;AACI,aAAK,CAAL;AAAQ,aAAK,CAAL;AAAQX,UAAAA,CAAC,GAAGW,EAAJ;AAAQ;;AACxB,aAAK,CAAL;AAAQd,UAAAA,CAAC,CAACC,KAAF;AAAW,iBAAO;AAAEhB,YAAAA,KAAK,EAAE6B,EAAE,CAAC,CAAD,CAAX;AAAgBnB,YAAAA,IAAI,EAAE;AAAtB,WAAP;;AACnB,aAAK,CAAL;AAAQK,UAAAA,CAAC,CAACC,KAAF;AAAWM,UAAAA,CAAC,GAAGO,EAAE,CAAC,CAAD,CAAN;AAAWA,UAAAA,EAAE,GAAG,CAAC,CAAD,CAAL;AAAU;;AACxC,aAAK,CAAL;AAAQA,UAAAA,EAAE,GAAGd,CAAC,CAACK,GAAF,CAAMY,GAAN,EAAL;;AAAkBjB,UAAAA,CAAC,CAACI,IAAF,CAAOa,GAAP;;AAAc;;AACxC;AACI,cAAI,EAAEd,CAAC,GAAGH,CAAC,CAACI,IAAN,EAAYD,CAAC,GAAGA,CAAC,CAAClC,MAAF,GAAW,CAAX,IAAgBkC,CAAC,CAACA,CAAC,CAAClC,MAAF,GAAW,CAAZ,CAAnC,MAAuD6C,EAAE,CAAC,CAAD,CAAF,KAAU,CAAV,IAAeA,EAAE,CAAC,CAAD,CAAF,KAAU,CAAhF,CAAJ,EAAwF;AAAEd,YAAAA,CAAC,GAAG,CAAJ;AAAO;AAAW;;AAC5G,cAAIc,EAAE,CAAC,CAAD,CAAF,KAAU,CAAV,KAAgB,CAACX,CAAD,IAAOW,EAAE,CAAC,CAAD,CAAF,GAAQX,CAAC,CAAC,CAAD,CAAT,IAAgBW,EAAE,CAAC,CAAD,CAAF,GAAQX,CAAC,CAAC,CAAD,CAAhD,CAAJ,EAA2D;AAAEH,YAAAA,CAAC,CAACC,KAAF,GAAUa,EAAE,CAAC,CAAD,CAAZ;AAAiB;AAAQ;;AACtF,cAAIA,EAAE,CAAC,CAAD,CAAF,KAAU,CAAV,IAAed,CAAC,CAACC,KAAF,GAAUE,CAAC,CAAC,CAAD,CAA9B,EAAmC;AAAEH,YAAAA,CAAC,CAACC,KAAF,GAAUE,CAAC,CAAC,CAAD,CAAX;AAAgBA,YAAAA,CAAC,GAAGW,EAAJ;AAAQ;AAAQ;;AACrE,cAAIX,CAAC,IAAIH,CAAC,CAACC,KAAF,GAAUE,CAAC,CAAC,CAAD,CAApB,EAAyB;AAAEH,YAAAA,CAAC,CAACC,KAAF,GAAUE,CAAC,CAAC,CAAD,CAAX;;AAAgBH,YAAAA,CAAC,CAACK,GAAF,CAAMa,IAAN,CAAWJ,EAAX;;AAAgB;AAAQ;;AACnE,cAAIX,CAAC,CAAC,CAAD,CAAL,EAAUH,CAAC,CAACK,GAAF,CAAMY,GAAN;;AACVjB,UAAAA,CAAC,CAACI,IAAF,CAAOa,GAAP;;AAAc;AAXtB;;AAaAH,MAAAA,EAAE,GAAGf,IAAI,CAACiB,IAAL,CAAUpC,OAAV,EAAmBoB,CAAnB,CAAL;AACH,KAjBS,CAiBR,OAAOR,CAAP,EAAU;AAAEsB,MAAAA,EAAE,GAAG,CAAC,CAAD,EAAItB,CAAJ,CAAL;AAAae,MAAAA,CAAC,GAAG,CAAJ;AAAQ,KAjBzB,SAiBkC;AAAED,MAAAA,CAAC,GAAGH,CAAC,GAAG,CAAR;AAAY;;AAC1D,QAAIW,EAAE,CAAC,CAAD,CAAF,GAAQ,CAAZ,EAAe,MAAMA,EAAE,CAAC,CAAD,CAAR;AAAa,WAAO;AAAE7B,MAAAA,KAAK,EAAE6B,EAAE,CAAC,CAAD,CAAF,GAAQA,EAAE,CAAC,CAAD,CAAV,GAAgB,KAAK,CAA9B;AAAiCnB,MAAAA,IAAI,EAAE;AAAvC,KAAP;AAC/B;AACJ,CA1BD;;AA2BA,SAASwB,aAAT,QAA8B,+BAA9B;AACA,SAASC,UAAT,EAAqBC,OAArB,EAA8BC,YAA9B,EAA4CC,eAA5C,QAAmE,mCAAnE;AACA,SAASC,kBAAT,EAA6BC,uBAA7B,QAA4D,6CAA5D;AACA,SAASC,oBAAT,QAAqC,8CAArC;AACA,SAASC,KAAT,QAAsB,kBAAtB;AACA,OAAO,KAAKC,KAAZ,MAAuB,aAAvB;AACA,SAASC,6BAAT,QAA8C,2CAA9C;AACA,SAASC,kBAAT,QAAmC,yBAAnC;AACA,SAASC,aAAT,QAA8B,mBAA9B;AACA,SAASC,iCAAT,QAAkD,uCAAlD;AACA,SAASC,WAAT,QAA4B,iCAA5B;AACA,SAASC,eAAT,QAAgC,gCAAhC;AACA,SAASC,WAAT,QAA4B,qCAA5B;AACA,SAASC,SAAT,QAA0B,mCAA1B;AACA;;;;AAGA,IAAIC,6BAA6B,GAAG,KAAK,IAAzC;AACA;;;;AAGA,IAAIC,yBAAyB,GAAG,IAAI,EAAJ,GAAS,IAAzC;;AACA,SAASC,YAAT,CAAsBC,YAAtB,EAAoCC,QAApC,EAA8C;AAC1C,MAAIC,KAAK,GAAGF,YAAY,CAACG,QAAb,CAAsBF,QAAtB,CAAZ;;AACA,MAAI,CAACC,KAAL,EAAY;AACR,WAAO,KAAP;AACH;;AACD,MAAIA,KAAK,CAACE,oBAAN,EAAJ,EAAkC;AAC9B,WAAO,KAAP;AACH;;AACD,SAAO,IAAP;AACH;;AACD,IAAIC,uBAAuB;AAAG;AAAe,UAAUC,MAAV,EAAkB;AAC3DlG,EAAAA,SAAS,CAACiG,uBAAD,EAA0BC,MAA1B,CAAT;;AACA,WAASD,uBAAT,CAAiCL,YAAjC,EAA+CO,oBAA/C,EAAqEC,UAArE,EAAiF;AAC7E,QAAIC,KAAK,GAAGH,MAAM,CAAC9B,IAAP,CAAY,IAAZ,KAAqB,IAAjC;;AACAiC,IAAAA,KAAK,CAACC,aAAN,GAAsBV,YAAtB;AACAS,IAAAA,KAAK,CAACE,cAAN,GAAuBF,KAAK,CAACG,SAAN,CAAgB,IAAIC,aAAJ,CAAkBJ,KAAK,CAACC,aAAxB,CAAhB,CAAvB;AACAD,IAAAA,KAAK,CAACK,WAAN,GAAoBN,UAApB,CAJ6E,CAK7E;;AACAC,IAAAA,KAAK,CAACG,SAAN,CAAgBxB,KAAK,CAAC2B,oBAAN,CAA2BC,QAA3B,CAAoC,GAApC,EAAyC;AACrDC,MAAAA,YAAY,EAAE,UAAUf,KAAV,EAAiBgB,KAAjB,EAAwB;AAClC,YAAI,CAACnB,YAAY,CAACU,KAAK,CAACC,aAAP,EAAsBR,KAAK,CAACiB,GAA5B,CAAjB,EAAmD;AAC/C,iBAAOxE,OAAO,CAACD,OAAR,CAAgB;AAAE0E,YAAAA,KAAK,EAAE;AAAT,WAAhB,CAAP,CAD+C,CACR;AAC1C;;AACD,eAAOX,KAAK,CAACE,cAAN,CAAqBU,UAArB,GAAkCjE,IAAlC,CAAuC,UAAUkE,MAAV,EAAkB;AAAE,iBAAOA,MAAM,CAACC,YAAP,CAAoBrB,KAAK,CAACiB,GAA1B,CAAP;AAAwC,SAAnG,EAAqG/D,IAArG,CAA0G,UAAUgE,KAAV,EAAiB;AAC9H,iBAAOA,KAAK,IAAI;AAAEA,YAAAA,KAAK,EAAEA;AAAT,WAAhB;AACH,SAFM,CAAP;AAGH;AARoD,KAAzC,CAAhB;;AAUAX,IAAAA,KAAK,CAACG,SAAN,CAAgBxB,KAAK,CAACoC,0BAAN,CAAiCR,QAAjC,CAA0C,GAA1C,EAA+C,IAAIS,+BAAJ,CAAoChB,KAAK,CAACE,cAA1C,EAA0DJ,oBAA1D,EAAgFE,KAAK,CAACC,aAAtF,CAA/C,CAAhB;;AACA,WAAOD,KAAP;AACH;;AACDJ,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkC6D,OAAlC,GAA4C,YAAY;AACpDyB,IAAAA,MAAM,CAACtF,SAAP,CAAiB6D,OAAjB,CAAyBL,IAAzB,CAA8B,IAA9B;AACH,GAFD;;AAGA6B,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkC0G,cAAlC,GAAmD,UAAUC,QAAV,EAAoBC,QAApB,EAA8B;AAC7E,WAAQ7B,YAAY,CAAC,KAAKW,aAAN,EAAqBiB,QAArB,CAAZ,IAA8C5B,YAAY,CAAC,KAAKW,aAAN,EAAqBkB,QAArB,CAAlE;AACH,GAFD;;AAGAvB,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkC6G,WAAlC,GAAgD,UAAUF,QAAV,EAAoBC,QAApB,EAA8BE,oBAA9B,EAAoDC,kBAApD,EAAwE;AACpH,WAAO,KAAKpB,cAAL,CAAoBU,UAApB,GAAiCjE,IAAjC,CAAsC,UAAUkE,MAAV,EAAkB;AAAE,aAAOA,MAAM,CAACO,WAAP,CAAmBF,QAAnB,EAA6BC,QAA7B,EAAuCE,oBAAvC,EAA6DC,kBAA7D,CAAP;AAA0F,KAApJ,CAAP;AACH,GAFD;;AAGA1B,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkCgH,uBAAlC,GAA4D,UAAU/B,QAAV,EAAoBgC,KAApB,EAA2B;AACnF,QAAIxB,KAAK,GAAG,IAAZ;;AACA,QAAIf,eAAe,CAACuC,KAAD,CAAnB,EAA4B;AACxB,UAAI,CAAClC,YAAY,CAAC,KAAKW,aAAN,EAAqBT,QAArB,CAAjB,EAAiD;AAC7C,eAAOtD,OAAO,CAACD,OAAR,CAAgBuF,KAAhB,CAAP,CAD6C,CACd;AAClC;;AACD,UAAIC,IAAI,GAAGtC,SAAS,CAAC3E,MAAV,CAAiB,IAAjB,CAAX;;AACA,UAAIiC,MAAM,GAAG,KAAKyD,cAAL,CAAoBU,UAApB,GAAiCjE,IAAjC,CAAsC,UAAUkE,MAAV,EAAkB;AAAE,eAAOA,MAAM,CAACU,uBAAP,CAA+B/B,QAA/B,EAAyCgC,KAAzC,CAAP;AAAyD,OAAnH,CAAb;;AACA/E,MAAAA,MAAM,CAACiF,OAAP,CAAe,YAAY;AAAE,eAAO1B,KAAK,CAACK,WAAN,CAAkBsB,KAAlB,CAAwB,gCAAxB,EAA0DnC,QAAQ,CAACoC,QAAT,CAAkB,IAAlB,CAA1D,EAAmFH,IAAI,CAACI,OAAL,EAAnF,CAAP;AAA4G,OAAzI;AACA,aAAOpF,MAAP;AACH,KARD,MASK;AACD,aAAOP,OAAO,CAACD,OAAR,CAAgB6F,SAAhB,CAAP;AACH;AACJ,GAdD;;AAeAlC,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkCwH,mBAAlC,GAAwD,UAAUvC,QAAV,EAAoB;AACxE,WAAQF,YAAY,CAAC,KAAKW,aAAN,EAAqBT,QAArB,CAApB;AACH,GAFD;;AAGAI,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkCyH,gBAAlC,GAAqD,UAAUxC,QAAV,EAAoByC,KAApB,EAA2BC,EAA3B,EAA+B;AAChF,WAAO,KAAKhC,cAAL,CAAoBU,UAApB,GAAiCjE,IAAjC,CAAsC,UAAUkE,MAAV,EAAkB;AAAE,aAAOA,MAAM,CAACmB,gBAAP,CAAwBxC,QAAxB,EAAkCyC,KAAlC,EAAyCC,EAAzC,CAAP;AAAsD,KAAhH,CAAP;AACH,GAFD;;AAGAtC,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkC4H,oBAAlC,GAAyD,UAAU3C,QAAV,EAAoB;AACzE,WAAOF,YAAY,CAAC,KAAKW,aAAN,EAAqBT,QAArB,CAAnB;AACH,GAFD;;AAGAI,EAAAA,uBAAuB,CAACrF,SAAxB,CAAkC6H,iBAAlC,GAAsD,UAAU5C,QAAV,EAAoByC,KAApB,EAA2B;AAC7E,WAAO,KAAK/B,cAAL,CAAoBU,UAApB,GAAiCjE,IAAjC,CAAsC,UAAUkE,MAAV,EAAkB;AAAE,aAAOA,MAAM,CAACuB,iBAAP,CAAyB5C,QAAzB,EAAmCyC,KAAnC,CAAP;AAAmD,KAA7G,CAAP;AACH,GAFD;;AAGArC,EAAAA,uBAAuB,GAAGnF,UAAU,CAAC,CACjCc,OAAO,CAAC,CAAD,EAAIuD,aAAJ,CAD0B,EAEjCvD,OAAO,CAAC,CAAD,EAAIwD,iCAAJ,CAF0B,EAGjCxD,OAAO,CAAC,CAAD,EAAI2D,WAAJ,CAH0B,CAAD,EAIjCU,uBAJiC,CAApC;AAKA,SAAOA,uBAAP;AACH,CA/D4C,CA+D3CzB,UA/D2C,CAA7C;;AAgEA,SAASyB,uBAAT;;AACA,IAAIoB,+BAA+B;AAAG;AAAe,YAAY;AAC7D,WAASA,+BAAT,CAAyCqB,aAAzC,EAAwDvC,oBAAxD,EAA8EP,YAA9E,EAA4F;AACxF,SAAK+C,iBAAL,GAAyB,sBAAzB;AACA,SAAKpC,cAAL,GAAsBmC,aAAtB;AACA,SAAKE,qBAAL,GAA6BzC,oBAA7B;AACA,SAAKG,aAAL,GAAqBV,YAArB;AACH;;AACDyB,EAAAA,+BAA+B,CAACzG,SAAhC,CAA0CiI,sBAA1C,GAAmE,UAAU/C,KAAV,EAAiBgD,QAAjB,EAA2B;AAC1F,WAAO/G,SAAS,CAAC,IAAD,EAAO,KAAK,CAAZ,EAAe,KAAK,CAApB,EAAuB,YAAY;AAC/C,UAAIgH,oBAAJ,EAA0BC,IAA1B,EAAgCC,OAAhC,EAAyCC,MAAzC,EAAiDhC,MAAjD,EAAyDiC,KAAzD;AACA,aAAOjG,WAAW,CAAC,IAAD,EAAO,UAAUkG,EAAV,EAAc;AACnC,gBAAQA,EAAE,CAAC/F,KAAX;AACI,eAAK,CAAL;AACI0F,YAAAA,oBAAoB,GAAG,KAAKH,qBAAL,CAA2BS,QAA3B,CAAoCvD,KAAK,CAACiB,GAA1C,EAA+C+B,QAA/C,EAAyD,QAAzD,EAAmEC,oBAA1F;;AACA,gBAAI,CAACA,oBAAL,EAA2B;AACvB,qBAAO,CAAC;AAAE;AAAH,gBAAeZ,SAAf,CAAP;AACH;;AACD,gBAAI,CAACxC,YAAY,CAAC,KAAKW,aAAN,EAAqBR,KAAK,CAACiB,GAA3B,CAAjB,EAAkD;AAC9C,qBAAO,CAAC;AAAE;AAAH,gBAAeoB,SAAf,CAAP,CAD8C,CACZ;AACrC;;AACDa,YAAAA,IAAI,GAAGlD,KAAK,CAACwD,iBAAN,CAAwBR,QAAxB,CAAP;AACAG,YAAAA,OAAO,GAAG,CAACD,IAAD,GAAQjE,KAAK,CAACwE,aAAN,CAAoBT,QAApB,CAAR,GAAwC,IAAI/D,KAAJ,CAAU+D,QAAQ,CAACU,UAAnB,EAA+BR,IAAI,CAACS,WAApC,EAAiDX,QAAQ,CAACU,UAA1D,EAAsER,IAAI,CAACU,SAA3E,CAAlD;AACAR,YAAAA,MAAM,GAAGD,OAAO,CAACU,cAAR,CAAuBb,QAAQ,CAACU,UAAhC,EAA4CV,QAAQ,CAACc,MAArD,CAAT;AACA,mBAAO,CAAC;AAAE;AAAH,cAAc,KAAKrD,cAAL,CAAoBU,UAApB,EAAd,CAAP;;AACJ,eAAK,CAAL;AACIC,YAAAA,MAAM,GAAGkC,EAAE,CAAC9F,IAAH,EAAT;AACA,mBAAO,CAAC;AAAE;AAAH,cAAc4D,MAAM,CAAC2C,cAAP,CAAsB/D,KAAK,CAACiB,GAA5B,EAAiC+B,QAAjC,CAAd,CAAP;;AACJ,eAAK,CAAL;AACIK,YAAAA,KAAK,GAAGC,EAAE,CAAC9F,IAAH,EAAR;;AACA,gBAAI,CAAC6F,KAAL,EAAY;AACR,qBAAO,CAAC;AAAE;AAAH,gBAAehB,SAAf,CAAP;AACH;;AACD,mBAAO,CAAC;AAAE;AAAH,cAAe;AACd2B,cAAAA,WAAW,EAAEX,KAAK,CAACY,GAAN,CAAU,UAAUf,IAAV,EAAgB;AACnC,uBAAO;AACHgB,kBAAAA,IAAI,EAAE;AAAG;AADN;AAEH3G,kBAAAA,KAAK,EAAE2F,IAFJ;AAGHiB,kBAAAA,UAAU,EAAEjB,IAHT;AAIHV,kBAAAA,KAAK,EAAE;AAAEY,oBAAAA,MAAM,EAAEA,MAAV;AAAkBD,oBAAAA,OAAO,EAAEA;AAA3B;AAJJ,iBAAP;AAMH,eAPY;AADC,aAAf,CAAP;AArBR;AAgCH,OAjCiB,CAAlB;AAkCH,KApCe,CAAhB;AAqCH,GAtCD;;AAuCA,SAAO5B,+BAAP;AACH,CA/CoD,EAArD;;AAgDA,IAAIZ,aAAa;AAAG;AAAe,UAAUP,MAAV,EAAkB;AACjDlG,EAAAA,SAAS,CAACyG,aAAD,EAAgBP,MAAhB,CAAT;;AACA,WAASO,aAAT,CAAuBb,YAAvB,EAAqC;AACjC,QAAIS,KAAK,GAAGH,MAAM,CAAC9B,IAAP,CAAY,IAAZ,KAAqB,IAAjC;;AACAiC,IAAAA,KAAK,CAACC,aAAN,GAAsBV,YAAtB;AACAS,IAAAA,KAAK,CAAC6D,mBAAN,GAA4B,IAA5B;AACA7D,IAAAA,KAAK,CAAC8D,mBAAN,GAA6B,IAAIC,IAAJ,EAAD,CAAaC,OAAb,EAA5B;;AACA,QAAIC,kBAAkB,GAAGjE,KAAK,CAACG,SAAN,CAAgB,IAAIjC,aAAJ,EAAhB,CAAzB;;AACA+F,IAAAA,kBAAkB,CAACC,YAAnB,CAAgC,YAAY;AAAE,aAAOlE,KAAK,CAACmE,oBAAN,EAAP;AAAsC,KAApF,EAAsFC,IAAI,CAACC,KAAL,CAAWhF,yBAAyB,GAAG,CAAvC,CAAtF;;AACAW,IAAAA,KAAK,CAACG,SAAN,CAAgBH,KAAK,CAACC,aAAN,CAAoBqE,cAApB,CAAmC,UAAUvH,CAAV,EAAa;AAAE,aAAOiD,KAAK,CAACuE,qBAAN,EAAP;AAAuC,KAAzF,CAAhB;;AACA,WAAOvE,KAAP;AACH;;AACDI,EAAAA,aAAa,CAAC7F,SAAd,CAAwB6D,OAAxB,GAAkC,YAAY;AAC1C,QAAI,KAAKyF,mBAAT,EAA8B;AAC1B,WAAKA,mBAAL,CAAyBzF,OAAzB;;AACA,WAAKyF,mBAAL,GAA2B,IAA3B;AACH;;AACDhE,IAAAA,MAAM,CAACtF,SAAP,CAAiB6D,OAAjB,CAAyBL,IAAzB,CAA8B,IAA9B;AACH,GAND;AAOA;;;;;AAGAqC,EAAAA,aAAa,CAAC7F,SAAd,CAAwBgK,qBAAxB,GAAgD,YAAY;AACxD,QAAI,CAAC,KAAKV,mBAAV,EAA+B;AAC3B;AACH;;AACD,QAAIW,MAAM,GAAG,KAAKvE,aAAL,CAAmBwE,SAAnB,EAAb;;AACA,QAAID,MAAM,CAACxJ,MAAP,KAAkB,CAAtB,EAAyB;AACrB;AACA,WAAK6I,mBAAL,CAAyBzF,OAAzB;;AACA,WAAKyF,mBAAL,GAA2B,IAA3B;AACH;AACJ,GAVD;AAWA;;;;;AAGAzD,EAAAA,aAAa,CAAC7F,SAAd,CAAwB4J,oBAAxB,GAA+C,YAAY;AACvD,QAAI,CAAC,KAAKN,mBAAV,EAA+B;AAC3B;AACH;;AACD,QAAIa,2BAA2B,GAAI,IAAIX,IAAJ,EAAD,CAAaC,OAAb,KAAyB,KAAKF,mBAAhE;;AACA,QAAIY,2BAA2B,GAAGrF,yBAAlC,EAA6D;AACzD,WAAKwE,mBAAL,CAAyBzF,OAAzB;;AACA,WAAKyF,mBAAL,GAA2B,IAA3B;AACH;AACJ,GATD;;AAUAzD,EAAAA,aAAa,CAAC7F,SAAd,CAAwBqG,UAAxB,GAAqC,YAAY;AAC7C,SAAKkD,mBAAL,GAA4B,IAAIC,IAAJ,EAAD,CAAaC,OAAb,EAA3B;;AACA,QAAI,CAAC,KAAKH,mBAAV,EAA+B;AAC3B,WAAKA,mBAAL,GAA2B,IAAIc,kBAAJ,CAAuB,KAAK1E,aAA5B,EAA2C,KAA3C,EAAkD,qBAAlD,CAA3B;AACH;;AACD,WAAO/D,OAAO,CAACD,OAAR,CAAgB,KAAK4H,mBAArB,CAAP;AACH,GAND;;AAOA,SAAOzD,aAAP;AACH,CAtDkC,CAsDjCjC,UAtDiC,CAAnC;;AAuDA,IAAIyG,kBAAkB;AAAG;AAAe,UAAU/E,MAAV,EAAkB;AACtDlG,EAAAA,SAAS,CAACiL,kBAAD,EAAqB/E,MAArB,CAAT;;AACA,WAAS+E,kBAAT,CAA4BC,KAA5B,EAAmCtF,YAAnC,EAAiDuF,cAAjD,EAAiE;AAC7D,QAAI9E,KAAK,GAAGH,MAAM,CAAC9B,IAAP,CAAY,IAAZ,KAAqB,IAAjC;;AACAiC,IAAAA,KAAK,CAAC+E,aAAN,GAAsBhL,MAAM,CAACS,MAAP,CAAc,IAAd,CAAtB;AACAwF,IAAAA,KAAK,CAACgF,yBAAN,GAAkCjL,MAAM,CAACS,MAAP,CAAc,IAAd,CAAlC;AACAwF,IAAAA,KAAK,CAACiF,MAAN,GAAeJ,KAAf;AACA7E,IAAAA,KAAK,CAACC,aAAN,GAAsBV,YAAtB;;AACA,QAAI,CAACuF,cAAL,EAAqB;AACjB,UAAII,KAAK,GAAG,IAAIhH,aAAJ,EAAZ;AACAgH,MAAAA,KAAK,CAAChB,YAAN,CAAmB,YAAY;AAAE,eAAOlE,KAAK,CAACmF,mBAAN,EAAP;AAAqC,OAAtE,EAAwEf,IAAI,CAACC,KAAL,CAAWjF,6BAA6B,GAAG,CAA3C,CAAxE;;AACAY,MAAAA,KAAK,CAACG,SAAN,CAAgB+E,KAAhB;AACH;;AACD,WAAOlF,KAAP;AACH;;AACD4E,EAAAA,kBAAkB,CAACrK,SAAnB,CAA6B6D,OAA7B,GAAuC,YAAY;AAC/C,SAAK,IAAIgH,QAAT,IAAqB,KAAKL,aAA1B,EAAyC;AACrC3G,MAAAA,OAAO,CAAC,KAAK2G,aAAL,CAAmBK,QAAnB,CAAD,CAAP;AACH;;AACD,SAAKL,aAAL,GAAqBhL,MAAM,CAACS,MAAP,CAAc,IAAd,CAArB;AACA,SAAKwK,yBAAL,GAAiCjL,MAAM,CAACS,MAAP,CAAc,IAAd,CAAjC;;AACAqF,IAAAA,MAAM,CAACtF,SAAP,CAAiB6D,OAAjB,CAAyBL,IAAzB,CAA8B,IAA9B;AACH,GAPD;;AAQA6G,EAAAA,kBAAkB,CAACrK,SAAnB,CAA6B8K,qBAA7B,GAAqD,UAAUC,SAAV,EAAqB;AACtE,SAAK,IAAIC,EAAE,GAAG,CAAT,EAAYC,WAAW,GAAGF,SAA/B,EAA0CC,EAAE,GAAGC,WAAW,CAACxK,MAA3D,EAAmEuK,EAAE,EAArE,EAAyE;AACrE,UAAI/F,QAAQ,GAAGgG,WAAW,CAACD,EAAD,CAA1B;AACA,UAAIE,WAAW,GAAGjG,QAAQ,CAACoC,QAAT,EAAlB;;AACA,UAAI,CAAC,KAAKmD,aAAL,CAAmBU,WAAnB,CAAL,EAAsC;AAClC,aAAKC,eAAL,CAAqBlG,QAArB;AACH;;AACD,UAAI,KAAKuF,aAAL,CAAmBU,WAAnB,CAAJ,EAAqC;AACjC,aAAKT,yBAAL,CAA+BS,WAA/B,IAA+C,IAAI1B,IAAJ,EAAD,CAAaC,OAAb,EAA9C;AACH;AACJ;AACJ,GAXD;;AAYAY,EAAAA,kBAAkB,CAACrK,SAAnB,CAA6B4K,mBAA7B,GAAmD,YAAY;AAC3D,QAAIQ,WAAW,GAAI,IAAI5B,IAAJ,EAAD,CAAaC,OAAb,EAAlB;AACA,QAAI4B,QAAQ,GAAG,EAAf;;AACA,SAAK,IAAIR,QAAT,IAAqB,KAAKJ,yBAA1B,EAAqD;AACjD,UAAIa,WAAW,GAAGF,WAAW,GAAG,KAAKX,yBAAL,CAA+BI,QAA/B,CAAhC;;AACA,UAAIS,WAAW,GAAGzG,6BAAlB,EAAiD;AAC7CwG,QAAAA,QAAQ,CAAC3H,IAAT,CAAcmH,QAAd;AACH;AACJ;;AACD,SAAK,IAAIG,EAAE,GAAG,CAAT,EAAYO,UAAU,GAAGF,QAA9B,EAAwCL,EAAE,GAAGO,UAAU,CAAC9K,MAAxD,EAAgEuK,EAAE,EAAlE,EAAsE;AAClE,UAAIhJ,CAAC,GAAGuJ,UAAU,CAACP,EAAD,CAAlB;;AACA,WAAKQ,cAAL,CAAoBxJ,CAApB;AACH;AACJ,GAbD;;AAcAqI,EAAAA,kBAAkB,CAACrK,SAAnB,CAA6BmL,eAA7B,GAA+C,UAAUlG,QAAV,EAAoB;AAC/D,QAAIQ,KAAK,GAAG,IAAZ;;AACA,QAAIP,KAAK,GAAG,KAAKQ,aAAL,CAAmBP,QAAnB,CAA4BF,QAA5B,CAAZ;;AACA,QAAI,CAACC,KAAL,EAAY;AACR;AACH;;AACD,QAAIA,KAAK,CAACE,oBAAN,EAAJ,EAAkC;AAC9B;AACH;;AACD,QAAIyF,QAAQ,GAAG5F,QAAQ,CAACoC,QAAT,EAAf;;AACA,SAAKqD,MAAL,CAAYe,cAAZ,CAA2B;AACvBC,MAAAA,GAAG,EAAExG,KAAK,CAACiB,GAAN,CAAUkB,QAAV,EADkB;AAEvBsE,MAAAA,KAAK,EAAEzG,KAAK,CAAC0G,eAAN,EAFgB;AAGvBC,MAAAA,GAAG,EAAE3G,KAAK,CAAC4G,MAAN,EAHkB;AAIvBC,MAAAA,SAAS,EAAE7G,KAAK,CAAC8G,YAAN;AAJY,KAA3B;;AAMA,QAAIC,SAAS,GAAG,IAAIlI,eAAJ,EAAhB;AACAkI,IAAAA,SAAS,CAACC,GAAV,CAAchH,KAAK,CAACiH,kBAAN,CAAyB,UAAUnK,CAAV,EAAa;AAChDyD,MAAAA,KAAK,CAACiF,MAAN,CAAa0B,kBAAb,CAAgCvB,QAAQ,CAACxD,QAAT,EAAhC,EAAqDrF,CAArD;AACH,KAFa,CAAd;AAGAiK,IAAAA,SAAS,CAACC,GAAV,CAAchH,KAAK,CAACmH,aAAN,CAAoB,YAAY;AAC1C5G,MAAAA,KAAK,CAAC+F,cAAN,CAAqBX,QAArB;AACH,KAFa,CAAd;AAGAoB,IAAAA,SAAS,CAACC,GAAV,CAAcpI,YAAY,CAAC,YAAY;AACnC2B,MAAAA,KAAK,CAACiF,MAAN,CAAa4B,kBAAb,CAAgCzB,QAAhC;AACH,KAFyB,CAA1B;AAGA,SAAKL,aAAL,CAAmBK,QAAnB,IAA+BoB,SAA/B;AACH,GA3BD;;AA4BA5B,EAAAA,kBAAkB,CAACrK,SAAnB,CAA6BwL,cAA7B,GAA8C,UAAUX,QAAV,EAAoB;AAC9D,QAAIoB,SAAS,GAAG,KAAKzB,aAAL,CAAmBK,QAAnB,CAAhB;AACA,WAAO,KAAKL,aAAL,CAAmBK,QAAnB,CAAP;AACA,WAAO,KAAKJ,yBAAL,CAA+BI,QAA/B,CAAP;AACAhH,IAAAA,OAAO,CAACoI,SAAD,CAAP;AACH,GALD;;AAMA,SAAO5B,kBAAP;AACH,CApFuC,CAoFtCzG,UApFsC,CAAxC;;AAqFA,IAAI2I,uBAAuB;AAAG;AAAe,YAAY;AACrD,WAASA,uBAAT,CAAiCC,QAAjC,EAA2C;AACvC,SAAKC,SAAL,GAAiBD,QAAjB;AACA,SAAKE,SAAL,GAAiB/K,OAAO,CAACD,OAAR,CAAgB,KAAK+K,SAArB,CAAjB;AACH;;AACDF,EAAAA,uBAAuB,CAACvM,SAAxB,CAAkC6D,OAAlC,GAA4C,YAAY;AACpD,SAAK4I,SAAL,CAAe5I,OAAf;AACH,GAFD;;AAGA0I,EAAAA,uBAAuB,CAACvM,SAAxB,CAAkC2M,cAAlC,GAAmD,YAAY;AAC3D,WAAO,KAAKD,SAAZ;AACH,GAFD;;AAGA,SAAOH,uBAAP;AACH,CAZ4C,EAA7C;;AAaA,IAAIK,gBAAgB;AAAG;AAAe,YAAY;AAC9C,WAASA,gBAAT,CAA0BC,YAA1B,EAAwC;AACpC,SAAKC,aAAL,GAAqBD,YAArB;AACH,GAH6C,CAI9C;;;AACAD,EAAAA,gBAAgB,CAAC5M,SAAjB,CAA2B+M,GAA3B,GAAiC,UAAUC,MAAV,EAAkBC,IAAlB,EAAwB;AACrD,WAAO,KAAKH,aAAL,CAAmBC,GAAnB,CAAuBC,MAAvB,EAA+BC,IAA/B,CAAP;AACH,GAFD;;AAGA,SAAOL,gBAAP;AACH,CATqC,EAAtC;;AAUA,SAASA,gBAAT;;AACA,IAAIxC,kBAAkB;AAAG;AAAe,UAAU9E,MAAV,EAAkB;AACtDlG,EAAAA,SAAS,CAACgL,kBAAD,EAAqB9E,MAArB,CAAT;;AACA,WAAS8E,kBAAT,CAA4BpF,YAA5B,EAA0CuF,cAA1C,EAA0D9H,KAA1D,EAAiE;AAC7D,QAAIgD,KAAK,GAAGH,MAAM,CAAC9B,IAAP,CAAY,IAAZ,KAAqB,IAAjC;;AACAiC,IAAAA,KAAK,CAACC,aAAN,GAAsBV,YAAtB;AACAS,IAAAA,KAAK,CAACyH,eAAN,GAAwB3C,cAAxB;AACA9E,IAAAA,KAAK,CAAC0H,cAAN,GAAuB,IAAIjJ,oBAAJ,CAAyBzB,KAAzB,CAAvB;AACAgD,IAAAA,KAAK,CAAC2H,OAAN,GAAgB,IAAhB;AACA3H,IAAAA,KAAK,CAAC4H,aAAN,GAAsB,IAAtB;AACA,WAAO5H,KAAP;AACH,GAVqD,CAWtD;;;AACA2E,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6B+M,GAA7B,GAAmC,UAAUC,MAAV,EAAkBC,IAAlB,EAAwB;AACvD,UAAM,IAAIK,KAAJ,CAAU,kBAAV,CAAN;AACH,GAFD;;AAGAlD,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6BuN,kBAA7B,GAAkD,YAAY;AAC1D,QAAI,CAAC,KAAKH,OAAV,EAAmB;AACf,UAAI;AACA,aAAKA,OAAL,GAAe,KAAKxH,SAAL,CAAe,IAAI5B,kBAAJ,CAAuB,KAAKmJ,cAA5B,EAA4C,8CAA5C,EAA4F,IAAIP,gBAAJ,CAAqB,IAArB,CAA5F,CAAf,CAAf;AACH,OAFD,CAGA,OAAOY,GAAP,EAAY;AACRvJ,QAAAA,uBAAuB,CAACuJ,GAAD,CAAvB;AACA,aAAKJ,OAAL,GAAe,IAAIb,uBAAJ,CAA4B,IAAIjI,kBAAJ,CAAuB,IAAIsI,gBAAJ,CAAqB,IAArB,CAAvB,EAAmD,IAAnD,CAA5B,CAAf;AACH;AACJ;;AACD,WAAO,KAAKQ,OAAZ;AACH,GAXD;;AAYAhD,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6ByN,SAA7B,GAAyC,YAAY;AACjD,QAAIhI,KAAK,GAAG,IAAZ;;AACA,WAAO,KAAK8H,kBAAL,GAA0BZ,cAA1B,GAA2CvK,IAA3C,CAAgDmF,SAAhD,EAA2D,UAAUiG,GAAV,EAAe;AAC7EvJ,MAAAA,uBAAuB,CAACuJ,GAAD,CAAvB;AACA/H,MAAAA,KAAK,CAAC2H,OAAN,GAAgB,IAAIb,uBAAJ,CAA4B,IAAIjI,kBAAJ,CAAuB,IAAIsI,gBAAJ,CAAqBnH,KAArB,CAAvB,EAAoD,IAApD,CAA5B,CAAhB;AACA,aAAOA,KAAK,CAAC8H,kBAAN,GAA2BZ,cAA3B,EAAP;AACH,KAJM,CAAP;AAKH,GAPD;;AAQAvC,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6B0N,wBAA7B,GAAwD,UAAUpD,KAAV,EAAiB;AACrE,QAAI,CAAC,KAAK+C,aAAV,EAAyB;AACrB,WAAKA,aAAL,GAAqB,KAAKzH,SAAL,CAAe,IAAIyE,kBAAJ,CAAuBC,KAAvB,EAA8B,KAAK5E,aAAnC,EAAkD,KAAKwH,eAAvD,CAAf,CAArB;AACH;;AACD,WAAO,KAAKG,aAAZ;AACH,GALD;;AAMAjD,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6B2N,oBAA7B,GAAoD,UAAU5C,SAAV,EAAqB;AACrE,QAAItF,KAAK,GAAG,IAAZ;;AACA,WAAO,KAAKgI,SAAL,GAAiBrL,IAAjB,CAAsB,UAAUkI,KAAV,EAAiB;AAC1C7E,MAAAA,KAAK,CAACiI,wBAAN,CAA+BpD,KAA/B,EAAsCQ,qBAAtC,CAA4DC,SAA5D;;AACA,aAAOT,KAAP;AACH,KAHM,CAAP;AAIH,GAND;;AAOAF,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6B6G,WAA7B,GAA2C,UAAUF,QAAV,EAAoBC,QAApB,EAA8BE,oBAA9B,EAAoDC,kBAApD,EAAwE;AAC/G,WAAO,KAAK4G,oBAAL,CAA0B,CAAChH,QAAD,EAAWC,QAAX,CAA1B,EAAgDxE,IAAhD,CAAqD,UAAUkI,KAAV,EAAiB;AACzE,aAAOA,KAAK,CAACzD,WAAN,CAAkBF,QAAQ,CAACU,QAAT,EAAlB,EAAuCT,QAAQ,CAACS,QAAT,EAAvC,EAA4DP,oBAA5D,EAAkFC,kBAAlF,CAAP;AACH,KAFM,CAAP;AAGH,GAJD;;AAKAqD,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6BgH,uBAA7B,GAAuD,UAAU/B,QAAV,EAAoBgC,KAApB,EAA2B;AAC9E,WAAO,KAAK0G,oBAAL,CAA0B,CAAC1I,QAAD,CAA1B,EAAsC7C,IAAtC,CAA2C,UAAUkI,KAAV,EAAiB;AAC/D,aAAOA,KAAK,CAACtD,uBAAN,CAA8B/B,QAAQ,CAACoC,QAAT,EAA9B,EAAmDJ,KAAnD,CAAP;AACH,KAFM,CAAP;AAGH,GAJD;;AAKAmD,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6BuG,YAA7B,GAA4C,UAAUtB,QAAV,EAAoB;AAC5D,WAAO,KAAK0I,oBAAL,CAA0B,CAAC1I,QAAD,CAA1B,EAAsC7C,IAAtC,CAA2C,UAAUkI,KAAV,EAAiB;AAC/D,aAAOA,KAAK,CAAC/D,YAAN,CAAmBtB,QAAQ,CAACoC,QAAT,EAAnB,CAAP;AACH,KAFM,CAAP;AAGH,GAJD;;AAKA+C,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6BiJ,cAA7B,GAA8C,UAAUhE,QAAV,EAAoBiD,QAApB,EAA8B;AACxE,QAAIzC,KAAK,GAAG,IAAZ;;AACA,WAAO,KAAKkI,oBAAL,CAA0B,CAAC1I,QAAD,CAA1B,EAAsC7C,IAAtC,CAA2C,UAAUkI,KAAV,EAAiB;AAC/D,UAAIpF,KAAK,GAAGO,KAAK,CAACC,aAAN,CAAoBP,QAApB,CAA6BF,QAA7B,CAAZ;;AACA,UAAI,CAACC,KAAL,EAAY;AACR,eAAO,IAAP;AACH;;AACD,UAAI0I,aAAa,GAAGvJ,6BAA6B,CAACwJ,iBAA9B,CAAgD3I,KAAK,CAAC4I,qBAAN,GAA8BC,EAA9E,CAApB;AACA,UAAIC,OAAO,GAAGJ,aAAa,CAACK,MAA5B;AACA,UAAIC,YAAY,GAAGzJ,WAAW,CAACmJ,aAAD,CAA9B;AACA,aAAOtD,KAAK,CAACrB,cAAN,CAAqBhE,QAAQ,CAACoC,QAAT,EAArB,EAA0Ca,QAA1C,EAAoD8F,OAApD,EAA6DE,YAA7D,CAAP;AACH,KATM,CAAP;AAUH,GAZD;;AAaA9D,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6B6H,iBAA7B,GAAiD,UAAU5C,QAAV,EAAoByC,KAApB,EAA2B;AACxE,QAAIjC,KAAK,GAAG,IAAZ;;AACA,WAAO,KAAKkI,oBAAL,CAA0B,CAAC1I,QAAD,CAA1B,EAAsC7C,IAAtC,CAA2C,UAAUkI,KAAV,EAAiB;AAC/D,UAAIpF,KAAK,GAAGO,KAAK,CAACC,aAAN,CAAoBP,QAApB,CAA6BF,QAA7B,CAAZ;;AACA,UAAI,CAACC,KAAL,EAAY;AACR,eAAOvD,OAAO,CAACD,OAAR,CAAgB,IAAhB,CAAP;AACH;;AACD,UAAIkM,aAAa,GAAGvJ,6BAA6B,CAACwJ,iBAA9B,CAAgD3I,KAAK,CAAC4I,qBAAN,GAA8BC,EAA9E,CAApB;AACA,UAAIC,OAAO,GAAGJ,aAAa,CAACK,MAA5B;AACA,UAAIC,YAAY,GAAGzJ,WAAW,CAACmJ,aAAD,CAA9B;AACA,aAAOtD,KAAK,CAACzC,iBAAN,CAAwB5C,QAAQ,CAACoC,QAAT,EAAxB,EAA6CK,KAA7C,EAAoDsG,OAApD,EAA6DE,YAA7D,CAAP;AACH,KATM,CAAP;AAUH,GAZD;;AAaA9D,EAAAA,kBAAkB,CAACpK,SAAnB,CAA6ByH,gBAA7B,GAAgD,UAAUxC,QAAV,EAAoByC,KAApB,EAA2BC,EAA3B,EAA+B;AAC3E,QAAIlC,KAAK,GAAG,IAAZ;;AACA,WAAO,KAAKkI,oBAAL,CAA0B,CAAC1I,QAAD,CAA1B,EAAsC7C,IAAtC,CAA2C,UAAUkI,KAAV,EAAiB;AAC/D,UAAIpF,KAAK,GAAGO,KAAK,CAACC,aAAN,CAAoBP,QAApB,CAA6BF,QAA7B,CAAZ;;AACA,UAAI,CAACC,KAAL,EAAY;AACR,eAAO,IAAP;AACH;;AACD,UAAI0I,aAAa,GAAGvJ,6BAA6B,CAACwJ,iBAA9B,CAAgD3I,KAAK,CAAC4I,qBAAN,GAA8BC,EAA9E,CAApB;AACA,UAAIC,OAAO,GAAGJ,aAAa,CAACK,MAA5B;AACA,UAAIC,YAAY,GAAGzJ,WAAW,CAACmJ,aAAD,CAA9B;AACA,aAAOtD,KAAK,CAAC7C,gBAAN,CAAuBxC,QAAQ,CAACoC,QAAT,EAAvB,EAA4CK,KAA5C,EAAmDC,EAAnD,EAAuDqG,OAAvD,EAAgEE,YAAhE,CAAP;AACH,KATM,CAAP;AAUH,GAZD;;AAaA,SAAO9D,kBAAP;AACH,CAvGuC,CAuGtCxG,UAvGsC,CAAxC;;AAwGA,SAASwG,kBAAT","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n};\r\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n};\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nimport { IntervalTimer } from '../../../base/common/async.js';\r\nimport { Disposable, dispose, toDisposable, DisposableStore } from '../../../base/common/lifecycle.js';\r\nimport { SimpleWorkerClient, logOnceWebWorkerWarning } from '../../../base/common/worker/simpleWorker.js';\r\nimport { DefaultWorkerFactory } from '../../../base/worker/defaultWorkerFactory.js';\r\nimport { Range } from '../core/range.js';\r\nimport * as modes from '../modes.js';\r\nimport { LanguageConfigurationRegistry } from '../modes/languageConfigurationRegistry.js';\r\nimport { EditorSimpleWorker } from './editorSimpleWorker.js';\r\nimport { IModelService } from './modelService.js';\r\nimport { ITextResourceConfigurationService } from './textResourceConfigurationService.js';\r\nimport { regExpFlags } from '../../../base/common/strings.js';\r\nimport { isNonEmptyArray } from '../../../base/common/arrays.js';\r\nimport { ILogService } from '../../../platform/log/common/log.js';\r\nimport { StopWatch } from '../../../base/common/stopwatch.js';\r\n/**\r\n * Stop syncing a model to the worker if it was not needed for 1 min.\r\n */\r\nvar STOP_SYNC_MODEL_DELTA_TIME_MS = 60 * 1000;\r\n/**\r\n * Stop the worker if it was not needed for 5 min.\r\n */\r\nvar STOP_WORKER_DELTA_TIME_MS = 5 * 60 * 1000;\r\nfunction canSyncModel(modelService, resource) {\r\n    var model = modelService.getModel(resource);\r\n    if (!model) {\r\n        return false;\r\n    }\r\n    if (model.isTooLargeForSyncing()) {\r\n        return false;\r\n    }\r\n    return true;\r\n}\r\nvar EditorWorkerServiceImpl = /** @class */ (function (_super) {\r\n    __extends(EditorWorkerServiceImpl, _super);\r\n    function EditorWorkerServiceImpl(modelService, configurationService, logService) {\r\n        var _this = _super.call(this) || this;\r\n        _this._modelService = modelService;\r\n        _this._workerManager = _this._register(new WorkerManager(_this._modelService));\r\n        _this._logService = logService;\r\n        // todo@joh make sure this happens only once\r\n        _this._register(modes.LinkProviderRegistry.register('*', {\r\n            provideLinks: function (model, token) {\r\n                if (!canSyncModel(_this._modelService, model.uri)) {\r\n                    return Promise.resolve({ links: [] }); // File too large\r\n                }\r\n                return _this._workerManager.withWorker().then(function (client) { return client.computeLinks(model.uri); }).then(function (links) {\r\n                    return links && { links: links };\r\n                });\r\n            }\r\n        }));\r\n        _this._register(modes.CompletionProviderRegistry.register('*', new WordBasedCompletionItemProvider(_this._workerManager, configurationService, _this._modelService)));\r\n        return _this;\r\n    }\r\n    EditorWorkerServiceImpl.prototype.dispose = function () {\r\n        _super.prototype.dispose.call(this);\r\n    };\r\n    EditorWorkerServiceImpl.prototype.canComputeDiff = function (original, modified) {\r\n        return (canSyncModel(this._modelService, original) && canSyncModel(this._modelService, modified));\r\n    };\r\n    EditorWorkerServiceImpl.prototype.computeDiff = function (original, modified, ignoreTrimWhitespace, maxComputationTime) {\r\n        return this._workerManager.withWorker().then(function (client) { return client.computeDiff(original, modified, ignoreTrimWhitespace, maxComputationTime); });\r\n    };\r\n    EditorWorkerServiceImpl.prototype.computeMoreMinimalEdits = function (resource, edits) {\r\n        var _this = this;\r\n        if (isNonEmptyArray(edits)) {\r\n            if (!canSyncModel(this._modelService, resource)) {\r\n                return Promise.resolve(edits); // File too large\r\n            }\r\n            var sw_1 = StopWatch.create(true);\r\n            var result = this._workerManager.withWorker().then(function (client) { return client.computeMoreMinimalEdits(resource, edits); });\r\n            result.finally(function () { return _this._logService.trace('FORMAT#computeMoreMinimalEdits', resource.toString(true), sw_1.elapsed()); });\r\n            return result;\r\n        }\r\n        else {\r\n            return Promise.resolve(undefined);\r\n        }\r\n    };\r\n    EditorWorkerServiceImpl.prototype.canNavigateValueSet = function (resource) {\r\n        return (canSyncModel(this._modelService, resource));\r\n    };\r\n    EditorWorkerServiceImpl.prototype.navigateValueSet = function (resource, range, up) {\r\n        return this._workerManager.withWorker().then(function (client) { return client.navigateValueSet(resource, range, up); });\r\n    };\r\n    EditorWorkerServiceImpl.prototype.canComputeWordRanges = function (resource) {\r\n        return canSyncModel(this._modelService, resource);\r\n    };\r\n    EditorWorkerServiceImpl.prototype.computeWordRanges = function (resource, range) {\r\n        return this._workerManager.withWorker().then(function (client) { return client.computeWordRanges(resource, range); });\r\n    };\r\n    EditorWorkerServiceImpl = __decorate([\r\n        __param(0, IModelService),\r\n        __param(1, ITextResourceConfigurationService),\r\n        __param(2, ILogService)\r\n    ], EditorWorkerServiceImpl);\r\n    return EditorWorkerServiceImpl;\r\n}(Disposable));\r\nexport { EditorWorkerServiceImpl };\r\nvar WordBasedCompletionItemProvider = /** @class */ (function () {\r\n    function WordBasedCompletionItemProvider(workerManager, configurationService, modelService) {\r\n        this._debugDisplayName = 'wordbasedCompletions';\r\n        this._workerManager = workerManager;\r\n        this._configurationService = configurationService;\r\n        this._modelService = modelService;\r\n    }\r\n    WordBasedCompletionItemProvider.prototype.provideCompletionItems = function (model, position) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var wordBasedSuggestions, word, replace, insert, client, words;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        wordBasedSuggestions = this._configurationService.getValue(model.uri, position, 'editor').wordBasedSuggestions;\r\n                        if (!wordBasedSuggestions) {\r\n                            return [2 /*return*/, undefined];\r\n                        }\r\n                        if (!canSyncModel(this._modelService, model.uri)) {\r\n                            return [2 /*return*/, undefined]; // File too large\r\n                        }\r\n                        word = model.getWordAtPosition(position);\r\n                        replace = !word ? Range.fromPositions(position) : new Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn);\r\n                        insert = replace.setEndPosition(position.lineNumber, position.column);\r\n                        return [4 /*yield*/, this._workerManager.withWorker()];\r\n                    case 1:\r\n                        client = _a.sent();\r\n                        return [4 /*yield*/, client.textualSuggest(model.uri, position)];\r\n                    case 2:\r\n                        words = _a.sent();\r\n                        if (!words) {\r\n                            return [2 /*return*/, undefined];\r\n                        }\r\n                        return [2 /*return*/, {\r\n                                suggestions: words.map(function (word) {\r\n                                    return {\r\n                                        kind: 18 /* Text */,\r\n                                        label: word,\r\n                                        insertText: word,\r\n                                        range: { insert: insert, replace: replace }\r\n                                    };\r\n                                })\r\n                            }];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return WordBasedCompletionItemProvider;\r\n}());\r\nvar WorkerManager = /** @class */ (function (_super) {\r\n    __extends(WorkerManager, _super);\r\n    function WorkerManager(modelService) {\r\n        var _this = _super.call(this) || this;\r\n        _this._modelService = modelService;\r\n        _this._editorWorkerClient = null;\r\n        _this._lastWorkerUsedTime = (new Date()).getTime();\r\n        var stopWorkerInterval = _this._register(new IntervalTimer());\r\n        stopWorkerInterval.cancelAndSet(function () { return _this._checkStopIdleWorker(); }, Math.round(STOP_WORKER_DELTA_TIME_MS / 2));\r\n        _this._register(_this._modelService.onModelRemoved(function (_) { return _this._checkStopEmptyWorker(); }));\r\n        return _this;\r\n    }\r\n    WorkerManager.prototype.dispose = function () {\r\n        if (this._editorWorkerClient) {\r\n            this._editorWorkerClient.dispose();\r\n            this._editorWorkerClient = null;\r\n        }\r\n        _super.prototype.dispose.call(this);\r\n    };\r\n    /**\r\n     * Check if the model service has no more models and stop the worker if that is the case.\r\n     */\r\n    WorkerManager.prototype._checkStopEmptyWorker = function () {\r\n        if (!this._editorWorkerClient) {\r\n            return;\r\n        }\r\n        var models = this._modelService.getModels();\r\n        if (models.length === 0) {\r\n            // There are no more models => nothing possible for me to do\r\n            this._editorWorkerClient.dispose();\r\n            this._editorWorkerClient = null;\r\n        }\r\n    };\r\n    /**\r\n     * Check if the worker has been idle for a while and then stop it.\r\n     */\r\n    WorkerManager.prototype._checkStopIdleWorker = function () {\r\n        if (!this._editorWorkerClient) {\r\n            return;\r\n        }\r\n        var timeSinceLastWorkerUsedTime = (new Date()).getTime() - this._lastWorkerUsedTime;\r\n        if (timeSinceLastWorkerUsedTime > STOP_WORKER_DELTA_TIME_MS) {\r\n            this._editorWorkerClient.dispose();\r\n            this._editorWorkerClient = null;\r\n        }\r\n    };\r\n    WorkerManager.prototype.withWorker = function () {\r\n        this._lastWorkerUsedTime = (new Date()).getTime();\r\n        if (!this._editorWorkerClient) {\r\n            this._editorWorkerClient = new EditorWorkerClient(this._modelService, false, 'editorWorkerService');\r\n        }\r\n        return Promise.resolve(this._editorWorkerClient);\r\n    };\r\n    return WorkerManager;\r\n}(Disposable));\r\nvar EditorModelManager = /** @class */ (function (_super) {\r\n    __extends(EditorModelManager, _super);\r\n    function EditorModelManager(proxy, modelService, keepIdleModels) {\r\n        var _this = _super.call(this) || this;\r\n        _this._syncedModels = Object.create(null);\r\n        _this._syncedModelsLastUsedTime = Object.create(null);\r\n        _this._proxy = proxy;\r\n        _this._modelService = modelService;\r\n        if (!keepIdleModels) {\r\n            var timer = new IntervalTimer();\r\n            timer.cancelAndSet(function () { return _this._checkStopModelSync(); }, Math.round(STOP_SYNC_MODEL_DELTA_TIME_MS / 2));\r\n            _this._register(timer);\r\n        }\r\n        return _this;\r\n    }\r\n    EditorModelManager.prototype.dispose = function () {\r\n        for (var modelUrl in this._syncedModels) {\r\n            dispose(this._syncedModels[modelUrl]);\r\n        }\r\n        this._syncedModels = Object.create(null);\r\n        this._syncedModelsLastUsedTime = Object.create(null);\r\n        _super.prototype.dispose.call(this);\r\n    };\r\n    EditorModelManager.prototype.ensureSyncedResources = function (resources) {\r\n        for (var _i = 0, resources_1 = resources; _i < resources_1.length; _i++) {\r\n            var resource = resources_1[_i];\r\n            var resourceStr = resource.toString();\r\n            if (!this._syncedModels[resourceStr]) {\r\n                this._beginModelSync(resource);\r\n            }\r\n            if (this._syncedModels[resourceStr]) {\r\n                this._syncedModelsLastUsedTime[resourceStr] = (new Date()).getTime();\r\n            }\r\n        }\r\n    };\r\n    EditorModelManager.prototype._checkStopModelSync = function () {\r\n        var currentTime = (new Date()).getTime();\r\n        var toRemove = [];\r\n        for (var modelUrl in this._syncedModelsLastUsedTime) {\r\n            var elapsedTime = currentTime - this._syncedModelsLastUsedTime[modelUrl];\r\n            if (elapsedTime > STOP_SYNC_MODEL_DELTA_TIME_MS) {\r\n                toRemove.push(modelUrl);\r\n            }\r\n        }\r\n        for (var _i = 0, toRemove_1 = toRemove; _i < toRemove_1.length; _i++) {\r\n            var e = toRemove_1[_i];\r\n            this._stopModelSync(e);\r\n        }\r\n    };\r\n    EditorModelManager.prototype._beginModelSync = function (resource) {\r\n        var _this = this;\r\n        var model = this._modelService.getModel(resource);\r\n        if (!model) {\r\n            return;\r\n        }\r\n        if (model.isTooLargeForSyncing()) {\r\n            return;\r\n        }\r\n        var modelUrl = resource.toString();\r\n        this._proxy.acceptNewModel({\r\n            url: model.uri.toString(),\r\n            lines: model.getLinesContent(),\r\n            EOL: model.getEOL(),\r\n            versionId: model.getVersionId()\r\n        });\r\n        var toDispose = new DisposableStore();\r\n        toDispose.add(model.onDidChangeContent(function (e) {\r\n            _this._proxy.acceptModelChanged(modelUrl.toString(), e);\r\n        }));\r\n        toDispose.add(model.onWillDispose(function () {\r\n            _this._stopModelSync(modelUrl);\r\n        }));\r\n        toDispose.add(toDisposable(function () {\r\n            _this._proxy.acceptRemovedModel(modelUrl);\r\n        }));\r\n        this._syncedModels[modelUrl] = toDispose;\r\n    };\r\n    EditorModelManager.prototype._stopModelSync = function (modelUrl) {\r\n        var toDispose = this._syncedModels[modelUrl];\r\n        delete this._syncedModels[modelUrl];\r\n        delete this._syncedModelsLastUsedTime[modelUrl];\r\n        dispose(toDispose);\r\n    };\r\n    return EditorModelManager;\r\n}(Disposable));\r\nvar SynchronousWorkerClient = /** @class */ (function () {\r\n    function SynchronousWorkerClient(instance) {\r\n        this._instance = instance;\r\n        this._proxyObj = Promise.resolve(this._instance);\r\n    }\r\n    SynchronousWorkerClient.prototype.dispose = function () {\r\n        this._instance.dispose();\r\n    };\r\n    SynchronousWorkerClient.prototype.getProxyObject = function () {\r\n        return this._proxyObj;\r\n    };\r\n    return SynchronousWorkerClient;\r\n}());\r\nvar EditorWorkerHost = /** @class */ (function () {\r\n    function EditorWorkerHost(workerClient) {\r\n        this._workerClient = workerClient;\r\n    }\r\n    // foreign host request\r\n    EditorWorkerHost.prototype.fhr = function (method, args) {\r\n        return this._workerClient.fhr(method, args);\r\n    };\r\n    return EditorWorkerHost;\r\n}());\r\nexport { EditorWorkerHost };\r\nvar EditorWorkerClient = /** @class */ (function (_super) {\r\n    __extends(EditorWorkerClient, _super);\r\n    function EditorWorkerClient(modelService, keepIdleModels, label) {\r\n        var _this = _super.call(this) || this;\r\n        _this._modelService = modelService;\r\n        _this._keepIdleModels = keepIdleModels;\r\n        _this._workerFactory = new DefaultWorkerFactory(label);\r\n        _this._worker = null;\r\n        _this._modelManager = null;\r\n        return _this;\r\n    }\r\n    // foreign host request\r\n    EditorWorkerClient.prototype.fhr = function (method, args) {\r\n        throw new Error(\"Not implemented!\");\r\n    };\r\n    EditorWorkerClient.prototype._getOrCreateWorker = function () {\r\n        if (!this._worker) {\r\n            try {\r\n                this._worker = this._register(new SimpleWorkerClient(this._workerFactory, 'vs/editor/common/services/editorSimpleWorker', new EditorWorkerHost(this)));\r\n            }\r\n            catch (err) {\r\n                logOnceWebWorkerWarning(err);\r\n                this._worker = new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this), null));\r\n            }\r\n        }\r\n        return this._worker;\r\n    };\r\n    EditorWorkerClient.prototype._getProxy = function () {\r\n        var _this = this;\r\n        return this._getOrCreateWorker().getProxyObject().then(undefined, function (err) {\r\n            logOnceWebWorkerWarning(err);\r\n            _this._worker = new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(_this), null));\r\n            return _this._getOrCreateWorker().getProxyObject();\r\n        });\r\n    };\r\n    EditorWorkerClient.prototype._getOrCreateModelManager = function (proxy) {\r\n        if (!this._modelManager) {\r\n            this._modelManager = this._register(new EditorModelManager(proxy, this._modelService, this._keepIdleModels));\r\n        }\r\n        return this._modelManager;\r\n    };\r\n    EditorWorkerClient.prototype._withSyncedResources = function (resources) {\r\n        var _this = this;\r\n        return this._getProxy().then(function (proxy) {\r\n            _this._getOrCreateModelManager(proxy).ensureSyncedResources(resources);\r\n            return proxy;\r\n        });\r\n    };\r\n    EditorWorkerClient.prototype.computeDiff = function (original, modified, ignoreTrimWhitespace, maxComputationTime) {\r\n        return this._withSyncedResources([original, modified]).then(function (proxy) {\r\n            return proxy.computeDiff(original.toString(), modified.toString(), ignoreTrimWhitespace, maxComputationTime);\r\n        });\r\n    };\r\n    EditorWorkerClient.prototype.computeMoreMinimalEdits = function (resource, edits) {\r\n        return this._withSyncedResources([resource]).then(function (proxy) {\r\n            return proxy.computeMoreMinimalEdits(resource.toString(), edits);\r\n        });\r\n    };\r\n    EditorWorkerClient.prototype.computeLinks = function (resource) {\r\n        return this._withSyncedResources([resource]).then(function (proxy) {\r\n            return proxy.computeLinks(resource.toString());\r\n        });\r\n    };\r\n    EditorWorkerClient.prototype.textualSuggest = function (resource, position) {\r\n        var _this = this;\r\n        return this._withSyncedResources([resource]).then(function (proxy) {\r\n            var model = _this._modelService.getModel(resource);\r\n            if (!model) {\r\n                return null;\r\n            }\r\n            var wordDefRegExp = LanguageConfigurationRegistry.getWordDefinition(model.getLanguageIdentifier().id);\r\n            var wordDef = wordDefRegExp.source;\r\n            var wordDefFlags = regExpFlags(wordDefRegExp);\r\n            return proxy.textualSuggest(resource.toString(), position, wordDef, wordDefFlags);\r\n        });\r\n    };\r\n    EditorWorkerClient.prototype.computeWordRanges = function (resource, range) {\r\n        var _this = this;\r\n        return this._withSyncedResources([resource]).then(function (proxy) {\r\n            var model = _this._modelService.getModel(resource);\r\n            if (!model) {\r\n                return Promise.resolve(null);\r\n            }\r\n            var wordDefRegExp = LanguageConfigurationRegistry.getWordDefinition(model.getLanguageIdentifier().id);\r\n            var wordDef = wordDefRegExp.source;\r\n            var wordDefFlags = regExpFlags(wordDefRegExp);\r\n            return proxy.computeWordRanges(resource.toString(), range, wordDef, wordDefFlags);\r\n        });\r\n    };\r\n    EditorWorkerClient.prototype.navigateValueSet = function (resource, range, up) {\r\n        var _this = this;\r\n        return this._withSyncedResources([resource]).then(function (proxy) {\r\n            var model = _this._modelService.getModel(resource);\r\n            if (!model) {\r\n                return null;\r\n            }\r\n            var wordDefRegExp = LanguageConfigurationRegistry.getWordDefinition(model.getLanguageIdentifier().id);\r\n            var wordDef = wordDefRegExp.source;\r\n            var wordDefFlags = regExpFlags(wordDefRegExp);\r\n            return proxy.navigateValueSet(resource.toString(), range, up, wordDef, wordDefFlags);\r\n        });\r\n    };\r\n    return EditorWorkerClient;\r\n}(Disposable));\r\nexport { EditorWorkerClient };\r\n"]},"metadata":{},"sourceType":"module"}