{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nimport { equals } from '../../../base/common/arrays.js';\nimport { CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { first } from '../../../base/common/collections.js';\nimport { onUnexpectedExternalError } from '../../../base/common/errors.js';\nimport { LRUCache } from '../../../base/common/map.js';\nimport { DocumentSymbolProviderRegistry } from '../../common/modes.js';\n\nvar TreeElement =\n/** @class */\nfunction () {\n  function TreeElement() {}\n\n  TreeElement.prototype.remove = function () {\n    if (this.parent) {\n      delete this.parent.children[this.id];\n    }\n  };\n\n  TreeElement.findId = function (candidate, container) {\n    // complex id-computation which contains the origin/extension,\n    // the parent path, and some dedupe logic when names collide\n    var candidateId;\n\n    if (typeof candidate === 'string') {\n      candidateId = container.id + \"/\" + candidate;\n    } else {\n      candidateId = container.id + \"/\" + candidate.name;\n\n      if (container.children[candidateId] !== undefined) {\n        candidateId = container.id + \"/\" + candidate.name + \"_\" + candidate.range.startLineNumber + \"_\" + candidate.range.startColumn;\n      }\n    }\n\n    var id = candidateId;\n\n    for (var i = 0; container.children[id] !== undefined; i++) {\n      id = candidateId + \"_\" + i;\n    }\n\n    return id;\n  };\n\n  TreeElement.empty = function (element) {\n    for (var _key in element.children) {\n      return false;\n    }\n\n    return true;\n  };\n\n  return TreeElement;\n}();\n\nexport { TreeElement };\n\nvar OutlineElement =\n/** @class */\nfunction (_super) {\n  __extends(OutlineElement, _super);\n\n  function OutlineElement(id, parent, symbol) {\n    var _this = _super.call(this) || this;\n\n    _this.id = id;\n    _this.parent = parent;\n    _this.symbol = symbol;\n    _this.children = Object.create(null);\n    return _this;\n  }\n\n  return OutlineElement;\n}(TreeElement);\n\nexport { OutlineElement };\n\nvar OutlineGroup =\n/** @class */\nfunction (_super) {\n  __extends(OutlineGroup, _super);\n\n  function OutlineGroup(id, parent, provider, providerIndex) {\n    var _this = _super.call(this) || this;\n\n    _this.id = id;\n    _this.parent = parent;\n    _this.provider = provider;\n    _this.providerIndex = providerIndex;\n    _this.children = Object.create(null);\n    return _this;\n  }\n\n  return OutlineGroup;\n}(TreeElement);\n\nexport { OutlineGroup };\n\nvar MovingAverage =\n/** @class */\nfunction () {\n  function MovingAverage() {\n    this._n = 1;\n    this._val = 0;\n  }\n\n  MovingAverage.prototype.update = function (value) {\n    this._val = this._val + (value - this._val) / this._n;\n    this._n += 1;\n    return this;\n  };\n\n  return MovingAverage;\n}();\n\nvar OutlineModel =\n/** @class */\nfunction (_super) {\n  __extends(OutlineModel, _super);\n\n  function OutlineModel(textModel) {\n    var _this = _super.call(this) || this;\n\n    _this.textModel = textModel;\n    _this.id = 'root';\n    _this.parent = undefined;\n    _this._groups = Object.create(null);\n    _this.children = Object.create(null);\n    _this.id = 'root';\n    _this.parent = undefined;\n    return _this;\n  }\n\n  OutlineModel.create = function (textModel, token) {\n    var _this = this;\n\n    var key = this._keys.for(textModel, true);\n\n    var data = OutlineModel._requests.get(key);\n\n    if (!data) {\n      var source = new CancellationTokenSource();\n      data = {\n        promiseCnt: 0,\n        source: source,\n        promise: OutlineModel._create(textModel, source.token),\n        model: undefined\n      };\n\n      OutlineModel._requests.set(key, data); // keep moving average of request durations\n\n\n      var now_1 = Date.now();\n      data.promise.then(function () {\n        var key = _this._keys.for(textModel, false);\n\n        var avg = _this._requestDurations.get(key);\n\n        if (!avg) {\n          avg = new MovingAverage();\n\n          _this._requestDurations.set(key, avg);\n        }\n\n        avg.update(Date.now() - now_1);\n      });\n    }\n\n    if (data.model) {\n      // resolved -> return data\n      return Promise.resolve(data.model);\n    } // increase usage counter\n\n\n    data.promiseCnt += 1;\n    token.onCancellationRequested(function () {\n      // last -> cancel provider request, remove cached promise\n      if (--data.promiseCnt === 0) {\n        data.source.cancel();\n\n        OutlineModel._requests.delete(key);\n      }\n    });\n    return new Promise(function (resolve, reject) {\n      data.promise.then(function (model) {\n        data.model = model;\n        resolve(model);\n      }, function (err) {\n        OutlineModel._requests.delete(key);\n\n        reject(err);\n      });\n    });\n  };\n\n  OutlineModel._create = function (textModel, token) {\n    var cts = new CancellationTokenSource(token);\n    var result = new OutlineModel(textModel);\n    var provider = DocumentSymbolProviderRegistry.ordered(textModel);\n    var promises = provider.map(function (provider, index) {\n      var id = TreeElement.findId(\"provider_\" + index, result);\n      var group = new OutlineGroup(id, result, provider, index);\n      return Promise.resolve(provider.provideDocumentSymbols(result.textModel, cts.token)).then(function (result) {\n        for (var _i = 0, _a = result || []; _i < _a.length; _i++) {\n          var info = _a[_i];\n\n          OutlineModel._makeOutlineElement(info, group);\n        }\n\n        return group;\n      }, function (err) {\n        onUnexpectedExternalError(err);\n        return group;\n      }).then(function (group) {\n        if (!TreeElement.empty(group)) {\n          result._groups[id] = group;\n        } else {\n          group.remove();\n        }\n      });\n    });\n    var listener = DocumentSymbolProviderRegistry.onDidChange(function () {\n      var newProvider = DocumentSymbolProviderRegistry.ordered(textModel);\n\n      if (!equals(newProvider, provider)) {\n        cts.cancel();\n      }\n    });\n    return Promise.all(promises).then(function () {\n      if (cts.token.isCancellationRequested && !token.isCancellationRequested) {\n        return OutlineModel._create(textModel, token);\n      } else {\n        return result._compact();\n      }\n    }).finally(function () {\n      listener.dispose();\n    });\n  };\n\n  OutlineModel._makeOutlineElement = function (info, container) {\n    var id = TreeElement.findId(info, container);\n    var res = new OutlineElement(id, container, info);\n\n    if (info.children) {\n      for (var _i = 0, _a = info.children; _i < _a.length; _i++) {\n        var childInfo = _a[_i];\n\n        OutlineModel._makeOutlineElement(childInfo, res);\n      }\n    }\n\n    container.children[res.id] = res;\n  };\n\n  OutlineModel.prototype._compact = function () {\n    var count = 0;\n\n    for (var key in this._groups) {\n      var group = this._groups[key];\n\n      if (first(group.children) === undefined) {\n        // empty\n        delete this._groups[key];\n      } else {\n        count += 1;\n      }\n    }\n\n    if (count !== 1) {\n      //\n      this.children = this._groups;\n    } else {\n      // adopt all elements of the first group\n      var group = first(this._groups);\n\n      for (var key in group.children) {\n        var child = group.children[key];\n        child.parent = this;\n        this.children[child.id] = child;\n      }\n    }\n\n    return this;\n  };\n\n  OutlineModel._requestDurations = new LRUCache(50, 0.7);\n  OutlineModel._requests = new LRUCache(9, 0.75);\n  OutlineModel._keys = new (\n  /** @class */\n  function () {\n    function class_1() {\n      this._counter = 1;\n      this._data = new WeakMap();\n    }\n\n    class_1.prototype.for = function (textModel, version) {\n      return textModel.id + \"/\" + (version ? textModel.getVersionId() : '') + \"/\" + this._hash(DocumentSymbolProviderRegistry.all(textModel));\n    };\n\n    class_1.prototype._hash = function (providers) {\n      var result = '';\n\n      for (var _i = 0, providers_1 = providers; _i < providers_1.length; _i++) {\n        var provider = providers_1[_i];\n\n        var n = this._data.get(provider);\n\n        if (typeof n === 'undefined') {\n          n = this._counter++;\n\n          this._data.set(provider, n);\n        }\n\n        result += n;\n      }\n\n      return result;\n    };\n\n    return class_1;\n  }())();\n  return OutlineModel;\n}(TreeElement);\n\nexport { OutlineModel };","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/editor/contrib/documentSymbols/outlineModel.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","equals","CancellationTokenSource","first","onUnexpectedExternalError","LRUCache","DocumentSymbolProviderRegistry","TreeElement","remove","parent","children","id","findId","candidate","container","candidateId","name","undefined","range","startLineNumber","startColumn","i","empty","element","_key","OutlineElement","_super","symbol","_this","call","OutlineGroup","provider","providerIndex","MovingAverage","_n","_val","update","value","OutlineModel","textModel","_groups","token","key","_keys","for","data","_requests","get","source","promiseCnt","promise","_create","model","set","now_1","Date","now","then","avg","_requestDurations","Promise","resolve","onCancellationRequested","cancel","delete","reject","err","cts","result","ordered","promises","map","index","group","provideDocumentSymbols","_i","_a","length","info","_makeOutlineElement","listener","onDidChange","newProvider","all","isCancellationRequested","_compact","finally","dispose","res","childInfo","count","child","class_1","_counter","_data","WeakMap","version","getVersionId","_hash","providers","providers_1","n"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nimport { equals } from '../../../base/common/arrays.js';\r\nimport { CancellationTokenSource } from '../../../base/common/cancellation.js';\r\nimport { first } from '../../../base/common/collections.js';\r\nimport { onUnexpectedExternalError } from '../../../base/common/errors.js';\r\nimport { LRUCache } from '../../../base/common/map.js';\r\nimport { DocumentSymbolProviderRegistry } from '../../common/modes.js';\r\nvar TreeElement = /** @class */ (function () {\r\n    function TreeElement() {\r\n    }\r\n    TreeElement.prototype.remove = function () {\r\n        if (this.parent) {\r\n            delete this.parent.children[this.id];\r\n        }\r\n    };\r\n    TreeElement.findId = function (candidate, container) {\r\n        // complex id-computation which contains the origin/extension,\r\n        // the parent path, and some dedupe logic when names collide\r\n        var candidateId;\r\n        if (typeof candidate === 'string') {\r\n            candidateId = container.id + \"/\" + candidate;\r\n        }\r\n        else {\r\n            candidateId = container.id + \"/\" + candidate.name;\r\n            if (container.children[candidateId] !== undefined) {\r\n                candidateId = container.id + \"/\" + candidate.name + \"_\" + candidate.range.startLineNumber + \"_\" + candidate.range.startColumn;\r\n            }\r\n        }\r\n        var id = candidateId;\r\n        for (var i = 0; container.children[id] !== undefined; i++) {\r\n            id = candidateId + \"_\" + i;\r\n        }\r\n        return id;\r\n    };\r\n    TreeElement.empty = function (element) {\r\n        for (var _key in element.children) {\r\n            return false;\r\n        }\r\n        return true;\r\n    };\r\n    return TreeElement;\r\n}());\r\nexport { TreeElement };\r\nvar OutlineElement = /** @class */ (function (_super) {\r\n    __extends(OutlineElement, _super);\r\n    function OutlineElement(id, parent, symbol) {\r\n        var _this = _super.call(this) || this;\r\n        _this.id = id;\r\n        _this.parent = parent;\r\n        _this.symbol = symbol;\r\n        _this.children = Object.create(null);\r\n        return _this;\r\n    }\r\n    return OutlineElement;\r\n}(TreeElement));\r\nexport { OutlineElement };\r\nvar OutlineGroup = /** @class */ (function (_super) {\r\n    __extends(OutlineGroup, _super);\r\n    function OutlineGroup(id, parent, provider, providerIndex) {\r\n        var _this = _super.call(this) || this;\r\n        _this.id = id;\r\n        _this.parent = parent;\r\n        _this.provider = provider;\r\n        _this.providerIndex = providerIndex;\r\n        _this.children = Object.create(null);\r\n        return _this;\r\n    }\r\n    return OutlineGroup;\r\n}(TreeElement));\r\nexport { OutlineGroup };\r\nvar MovingAverage = /** @class */ (function () {\r\n    function MovingAverage() {\r\n        this._n = 1;\r\n        this._val = 0;\r\n    }\r\n    MovingAverage.prototype.update = function (value) {\r\n        this._val = this._val + (value - this._val) / this._n;\r\n        this._n += 1;\r\n        return this;\r\n    };\r\n    return MovingAverage;\r\n}());\r\nvar OutlineModel = /** @class */ (function (_super) {\r\n    __extends(OutlineModel, _super);\r\n    function OutlineModel(textModel) {\r\n        var _this = _super.call(this) || this;\r\n        _this.textModel = textModel;\r\n        _this.id = 'root';\r\n        _this.parent = undefined;\r\n        _this._groups = Object.create(null);\r\n        _this.children = Object.create(null);\r\n        _this.id = 'root';\r\n        _this.parent = undefined;\r\n        return _this;\r\n    }\r\n    OutlineModel.create = function (textModel, token) {\r\n        var _this = this;\r\n        var key = this._keys.for(textModel, true);\r\n        var data = OutlineModel._requests.get(key);\r\n        if (!data) {\r\n            var source = new CancellationTokenSource();\r\n            data = {\r\n                promiseCnt: 0,\r\n                source: source,\r\n                promise: OutlineModel._create(textModel, source.token),\r\n                model: undefined,\r\n            };\r\n            OutlineModel._requests.set(key, data);\r\n            // keep moving average of request durations\r\n            var now_1 = Date.now();\r\n            data.promise.then(function () {\r\n                var key = _this._keys.for(textModel, false);\r\n                var avg = _this._requestDurations.get(key);\r\n                if (!avg) {\r\n                    avg = new MovingAverage();\r\n                    _this._requestDurations.set(key, avg);\r\n                }\r\n                avg.update(Date.now() - now_1);\r\n            });\r\n        }\r\n        if (data.model) {\r\n            // resolved -> return data\r\n            return Promise.resolve(data.model);\r\n        }\r\n        // increase usage counter\r\n        data.promiseCnt += 1;\r\n        token.onCancellationRequested(function () {\r\n            // last -> cancel provider request, remove cached promise\r\n            if (--data.promiseCnt === 0) {\r\n                data.source.cancel();\r\n                OutlineModel._requests.delete(key);\r\n            }\r\n        });\r\n        return new Promise(function (resolve, reject) {\r\n            data.promise.then(function (model) {\r\n                data.model = model;\r\n                resolve(model);\r\n            }, function (err) {\r\n                OutlineModel._requests.delete(key);\r\n                reject(err);\r\n            });\r\n        });\r\n    };\r\n    OutlineModel._create = function (textModel, token) {\r\n        var cts = new CancellationTokenSource(token);\r\n        var result = new OutlineModel(textModel);\r\n        var provider = DocumentSymbolProviderRegistry.ordered(textModel);\r\n        var promises = provider.map(function (provider, index) {\r\n            var id = TreeElement.findId(\"provider_\" + index, result);\r\n            var group = new OutlineGroup(id, result, provider, index);\r\n            return Promise.resolve(provider.provideDocumentSymbols(result.textModel, cts.token)).then(function (result) {\r\n                for (var _i = 0, _a = result || []; _i < _a.length; _i++) {\r\n                    var info = _a[_i];\r\n                    OutlineModel._makeOutlineElement(info, group);\r\n                }\r\n                return group;\r\n            }, function (err) {\r\n                onUnexpectedExternalError(err);\r\n                return group;\r\n            }).then(function (group) {\r\n                if (!TreeElement.empty(group)) {\r\n                    result._groups[id] = group;\r\n                }\r\n                else {\r\n                    group.remove();\r\n                }\r\n            });\r\n        });\r\n        var listener = DocumentSymbolProviderRegistry.onDidChange(function () {\r\n            var newProvider = DocumentSymbolProviderRegistry.ordered(textModel);\r\n            if (!equals(newProvider, provider)) {\r\n                cts.cancel();\r\n            }\r\n        });\r\n        return Promise.all(promises).then(function () {\r\n            if (cts.token.isCancellationRequested && !token.isCancellationRequested) {\r\n                return OutlineModel._create(textModel, token);\r\n            }\r\n            else {\r\n                return result._compact();\r\n            }\r\n        }).finally(function () {\r\n            listener.dispose();\r\n        });\r\n    };\r\n    OutlineModel._makeOutlineElement = function (info, container) {\r\n        var id = TreeElement.findId(info, container);\r\n        var res = new OutlineElement(id, container, info);\r\n        if (info.children) {\r\n            for (var _i = 0, _a = info.children; _i < _a.length; _i++) {\r\n                var childInfo = _a[_i];\r\n                OutlineModel._makeOutlineElement(childInfo, res);\r\n            }\r\n        }\r\n        container.children[res.id] = res;\r\n    };\r\n    OutlineModel.prototype._compact = function () {\r\n        var count = 0;\r\n        for (var key in this._groups) {\r\n            var group = this._groups[key];\r\n            if (first(group.children) === undefined) { // empty\r\n                delete this._groups[key];\r\n            }\r\n            else {\r\n                count += 1;\r\n            }\r\n        }\r\n        if (count !== 1) {\r\n            //\r\n            this.children = this._groups;\r\n        }\r\n        else {\r\n            // adopt all elements of the first group\r\n            var group = first(this._groups);\r\n            for (var key in group.children) {\r\n                var child = group.children[key];\r\n                child.parent = this;\r\n                this.children[child.id] = child;\r\n            }\r\n        }\r\n        return this;\r\n    };\r\n    OutlineModel._requestDurations = new LRUCache(50, 0.7);\r\n    OutlineModel._requests = new LRUCache(9, 0.75);\r\n    OutlineModel._keys = new /** @class */ (function () {\r\n        function class_1() {\r\n            this._counter = 1;\r\n            this._data = new WeakMap();\r\n        }\r\n        class_1.prototype.for = function (textModel, version) {\r\n            return textModel.id + \"/\" + (version ? textModel.getVersionId() : '') + \"/\" + this._hash(DocumentSymbolProviderRegistry.all(textModel));\r\n        };\r\n        class_1.prototype._hash = function (providers) {\r\n            var result = '';\r\n            for (var _i = 0, providers_1 = providers; _i < providers_1.length; _i++) {\r\n                var provider = providers_1[_i];\r\n                var n = this._data.get(provider);\r\n                if (typeof n === 'undefined') {\r\n                    n = this._counter++;\r\n                    this._data.set(provider, n);\r\n                }\r\n                result += n;\r\n            }\r\n            return result;\r\n        };\r\n        return class_1;\r\n    }());\r\n    return OutlineModel;\r\n}(TreeElement));\r\nexport { OutlineModel };\r\n"]},"metadata":{},"sourceType":"module"}