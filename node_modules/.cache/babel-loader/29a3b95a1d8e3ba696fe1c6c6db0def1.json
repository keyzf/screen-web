{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nimport { alert } from '../../../base/browser/ui/aria/aria.js';\nimport { isNonEmptyArray } from '../../../base/common/arrays.js';\nimport { onUnexpectedError } from '../../../base/common/errors.js';\nimport { SimpleKeybinding } from '../../../base/common/keyCodes.js';\nimport { dispose, DisposableStore, toDisposable, MutableDisposable } from '../../../base/common/lifecycle.js';\nimport { EditorAction, EditorCommand, registerEditorAction, registerEditorCommand, registerEditorContribution } from '../../browser/editorExtensions.js';\nimport { EditOperation } from '../../common/core/editOperation.js';\nimport { Range } from '../../common/core/range.js';\nimport { EditorContextKeys } from '../../common/editorContextKeys.js';\nimport { SnippetController2 } from '../snippet/snippetController2.js';\nimport { SnippetParser } from '../snippet/snippetParser.js';\nimport { ISuggestMemoryService } from './suggestMemory.js';\nimport * as nls from '../../../nls.js';\nimport { ICommandService, CommandsRegistry } from '../../../platform/commands/common/commands.js';\nimport { ContextKeyExpr, IContextKeyService } from '../../../platform/contextkey/common/contextkey.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { KeybindingsRegistry } from '../../../platform/keybinding/common/keybindingsRegistry.js';\nimport { Context as SuggestContext } from './suggest.js';\nimport { SuggestAlternatives } from './suggestAlternatives.js';\nimport { SuggestModel } from './suggestModel.js';\nimport { SuggestWidget } from './suggestWidget.js';\nimport { WordContextKey } from './wordContextKey.js';\nimport { Event } from '../../../base/common/event.js';\nimport { IEditorWorkerService } from '../../common/services/editorWorkerService.js';\nimport { IdleValue } from '../../../base/common/async.js';\nimport { isObject, assertType } from '../../../base/common/types.js';\nimport { CommitCharacterController } from './suggestCommitCharacters.js';\nimport * as platform from '../../../base/common/platform.js';\nimport { SuggestRangeHighlighter } from './suggestRangeHighlighter.js';\n/**\r\n * Stop suggest widget from disappearing when clicking into other areas\r\n * For development purpose only\r\n */\n\nvar _sticky = false;\n\nvar LineSuffix =\n/** @class */\nfunction () {\n  function LineSuffix(_model, _position) {\n    this._model = _model;\n    this._position = _position; // spy on what's happening right of the cursor. two cases:\n    // 1. end of line -> check that it's still end of line\n    // 2. mid of line -> add a marker and compute the delta\n\n    var maxColumn = _model.getLineMaxColumn(_position.lineNumber);\n\n    if (maxColumn !== _position.column) {\n      var offset = _model.getOffsetAt(_position);\n\n      var end = _model.getPositionAt(offset + 1);\n\n      this._marker = _model.deltaDecorations([], [{\n        range: Range.fromPositions(_position, end),\n        options: {\n          stickiness: 1\n          /* NeverGrowsWhenTypingAtEdges */\n\n        }\n      }]);\n    }\n  }\n\n  LineSuffix.prototype.dispose = function () {\n    if (this._marker && !this._model.isDisposed()) {\n      this._model.deltaDecorations(this._marker, []);\n    }\n  };\n\n  LineSuffix.prototype.delta = function (position) {\n    if (this._model.isDisposed() || this._position.lineNumber !== position.lineNumber) {\n      // bail out early if things seems fishy\n      return 0;\n    } // read the marker (in case suggest was triggered at line end) or compare\n    // the cursor to the line end.\n\n\n    if (this._marker) {\n      var range = this._model.getDecorationRange(this._marker[0]);\n\n      var end = this._model.getOffsetAt(range.getStartPosition());\n\n      return end - this._model.getOffsetAt(position);\n    } else {\n      return this._model.getLineMaxColumn(position.lineNumber) - position.column;\n    }\n  };\n\n  return LineSuffix;\n}();\n\nvar SuggestController =\n/** @class */\nfunction () {\n  function SuggestController(editor, editorWorker, _memoryService, _commandService, _contextKeyService, _instantiationService) {\n    var _this = this;\n\n    this._memoryService = _memoryService;\n    this._commandService = _commandService;\n    this._contextKeyService = _contextKeyService;\n    this._instantiationService = _instantiationService;\n    this._lineSuffix = new MutableDisposable();\n    this._toDispose = new DisposableStore();\n    this.editor = editor;\n    this.model = new SuggestModel(this.editor, editorWorker);\n    this.widget = this._toDispose.add(new IdleValue(function () {\n      var widget = _this._instantiationService.createInstance(SuggestWidget, _this.editor);\n\n      _this._toDispose.add(widget);\n\n      _this._toDispose.add(widget.onDidSelect(function (item) {\n        return _this._insertSuggestion(item, 0);\n      }, _this)); // Wire up logic to accept a suggestion on certain characters\n\n\n      var commitCharacterController = new CommitCharacterController(_this.editor, widget, function (item) {\n        return _this._insertSuggestion(item, 2\n        /* NoAfterUndoStop */\n        );\n      });\n\n      _this._toDispose.add(commitCharacterController);\n\n      _this._toDispose.add(_this.model.onDidSuggest(function (e) {\n        if (e.completionModel.items.length === 0) {\n          commitCharacterController.reset();\n        }\n      })); // Wire up makes text edit context key\n\n\n      var makesTextEdit = SuggestContext.MakesTextEdit.bindTo(_this._contextKeyService);\n\n      _this._toDispose.add(widget.onDidFocus(function (_a) {\n        var item = _a.item;\n\n        var position = _this.editor.getPosition();\n\n        var startColumn = item.editStart.column;\n        var endColumn = position.column;\n        var value = true;\n\n        if (_this.editor.getOption(1\n        /* acceptSuggestionOnEnter */\n        ) === 'smart' && _this.model.state === 2\n        /* Auto */\n        && !item.completion.command && !item.completion.additionalTextEdits && !(item.completion.insertTextRules & 4\n        /* InsertAsSnippet */\n        ) && endColumn - startColumn === item.completion.insertText.length) {\n          var oldText = _this.editor.getModel().getValueInRange({\n            startLineNumber: position.lineNumber,\n            startColumn: startColumn,\n            endLineNumber: position.lineNumber,\n            endColumn: endColumn\n          });\n\n          value = oldText !== item.completion.insertText;\n        }\n\n        makesTextEdit.set(value);\n      }));\n\n      _this._toDispose.add(toDisposable(function () {\n        return makesTextEdit.reset();\n      }));\n\n      _this._toDispose.add(widget.onDetailsKeyDown(function (e) {\n        // cmd + c on macOS, ctrl + c on Win / Linux\n        if (e.toKeybinding().equals(new SimpleKeybinding(true, false, false, false, 33\n        /* KEY_C */\n        )) || platform.isMacintosh && e.toKeybinding().equals(new SimpleKeybinding(false, false, false, true, 33\n        /* KEY_C */\n        ))) {\n          e.stopPropagation();\n          return;\n        }\n\n        if (!e.toKeybinding().isModifierKey()) {\n          _this.editor.focus();\n        }\n      }));\n\n      return widget;\n    }));\n    this._alternatives = this._toDispose.add(new IdleValue(function () {\n      return _this._toDispose.add(new SuggestAlternatives(_this.editor, _this._contextKeyService));\n    }));\n\n    this._toDispose.add(_instantiationService.createInstance(WordContextKey, editor));\n\n    this._toDispose.add(this.model.onDidTrigger(function (e) {\n      _this.widget.getValue().showTriggered(e.auto, e.shy ? 250 : 50);\n\n      _this._lineSuffix.value = new LineSuffix(_this.editor.getModel(), e.position);\n    }));\n\n    this._toDispose.add(this.model.onDidSuggest(function (e) {\n      if (!e.shy) {\n        var index = _this._memoryService.select(_this.editor.getModel(), _this.editor.getPosition(), e.completionModel.items);\n\n        _this.widget.getValue().showSuggestions(e.completionModel, index, e.isFrozen, e.auto);\n      }\n    }));\n\n    this._toDispose.add(this.model.onDidCancel(function (e) {\n      if (!e.retrigger) {\n        _this.widget.getValue().hideWidget();\n      }\n    }));\n\n    this._toDispose.add(this.editor.onDidBlurEditorWidget(function () {\n      if (!_sticky) {\n        _this.model.cancel();\n\n        _this.model.clear();\n      }\n    })); // Manage the acceptSuggestionsOnEnter context key\n\n\n    var acceptSuggestionsOnEnter = SuggestContext.AcceptSuggestionsOnEnter.bindTo(_contextKeyService);\n\n    var updateFromConfig = function () {\n      var acceptSuggestionOnEnter = _this.editor.getOption(1\n      /* acceptSuggestionOnEnter */\n      );\n\n      acceptSuggestionsOnEnter.set(acceptSuggestionOnEnter === 'on' || acceptSuggestionOnEnter === 'smart');\n    };\n\n    this._toDispose.add(this.editor.onDidChangeConfiguration(function () {\n      return updateFromConfig();\n    }));\n\n    updateFromConfig(); // create range highlighter\n\n    this._toDispose.add(new SuggestRangeHighlighter(this));\n  }\n\n  SuggestController.get = function (editor) {\n    return editor.getContribution(SuggestController.ID);\n  };\n\n  SuggestController.prototype.dispose = function () {\n    this._alternatives.dispose();\n\n    this._toDispose.dispose();\n\n    this.widget.dispose();\n    this.model.dispose();\n\n    this._lineSuffix.dispose();\n  };\n\n  SuggestController.prototype._insertSuggestion = function (event, flags) {\n    var _a;\n\n    var _this = this;\n\n    if (!event || !event.item) {\n      this._alternatives.getValue().reset();\n\n      this.model.cancel();\n      this.model.clear();\n      return;\n    }\n\n    if (!this.editor.hasModel()) {\n      return;\n    }\n\n    var model = this.editor.getModel();\n    var modelVersionNow = model.getAlternativeVersionId();\n    var item = event.item;\n    var suggestion = item.completion; // pushing undo stops *before* additional text edits and\n    // *after* the main edit\n\n    if (!(flags & 1\n    /* NoBeforeUndoStop */\n    )) {\n      this.editor.pushUndoStop();\n    } // compute overwrite[Before|After] deltas BEFORE applying extra edits\n\n\n    var info = this.getOverwriteInfo(item, Boolean(flags & 8\n    /* AlternativeOverwriteConfig */\n    )); // keep item in memory\n\n    this._memoryService.memorize(model, this.editor.getPosition(), item);\n\n    if (Array.isArray(suggestion.additionalTextEdits)) {\n      this.editor.executeEdits('suggestController.additionalTextEdits', suggestion.additionalTextEdits.map(function (edit) {\n        return EditOperation.replace(Range.lift(edit.range), edit.text);\n      }));\n    }\n\n    var insertText = suggestion.insertText;\n\n    if (!(suggestion.insertTextRules & 4\n    /* InsertAsSnippet */\n    )) {\n      insertText = SnippetParser.escape(insertText);\n    }\n\n    SnippetController2.get(this.editor).insert(insertText, {\n      overwriteBefore: info.overwriteBefore,\n      overwriteAfter: info.overwriteAfter,\n      undoStopBefore: false,\n      undoStopAfter: false,\n      adjustWhitespace: !(suggestion.insertTextRules & 1\n      /* KeepWhitespace */\n      )\n    });\n\n    if (!(flags & 2\n    /* NoAfterUndoStop */\n    )) {\n      this.editor.pushUndoStop();\n    }\n\n    if (!suggestion.command) {\n      // done\n      this.model.cancel();\n      this.model.clear();\n    } else if (suggestion.command.id === TriggerSuggestAction.id) {\n      // retigger\n      this.model.trigger({\n        auto: true,\n        shy: false\n      }, true);\n    } else {\n      // exec command, done\n      (_a = this._commandService).executeCommand.apply(_a, __spreadArrays([suggestion.command.id], suggestion.command.arguments ? __spreadArrays(suggestion.command.arguments) : [])).catch(onUnexpectedError).finally(function () {\n        return _this.model.clear();\n      }); // <- clear only now, keep commands alive\n\n\n      this.model.cancel();\n    }\n\n    if (flags & 4\n    /* KeepAlternativeSuggestions */\n    ) {\n        this._alternatives.getValue().set(event, function (next) {\n          // this is not so pretty. when inserting the 'next'\n          // suggestion we undo until we are at the state at\n          // which we were before inserting the previous suggestion...\n          while (model.canUndo()) {\n            if (modelVersionNow !== model.getAlternativeVersionId()) {\n              model.undo();\n            }\n\n            _this._insertSuggestion(next, 1\n            /* NoBeforeUndoStop */\n            | 2\n            /* NoAfterUndoStop */\n            | (flags & 8\n            /* AlternativeOverwriteConfig */\n            ? 8\n            /* AlternativeOverwriteConfig */\n            : 0));\n\n            break;\n          }\n        });\n      }\n\n    this._alertCompletionItem(event.item);\n  };\n\n  SuggestController.prototype.getOverwriteInfo = function (item, toggleMode) {\n    assertType(this.editor.hasModel());\n    var replace = this.editor.getOption(89\n    /* suggest */\n    ).insertMode === 'replace';\n\n    if (toggleMode) {\n      replace = !replace;\n    }\n\n    var overwriteBefore = item.position.column - item.editStart.column;\n    var overwriteAfter = (replace ? item.editReplaceEnd.column : item.editInsertEnd.column) - item.position.column;\n    var columnDelta = this.editor.getPosition().column - item.position.column;\n    var suffixDelta = this._lineSuffix.value ? this._lineSuffix.value.delta(this.editor.getPosition()) : 0;\n    return {\n      overwriteBefore: overwriteBefore + columnDelta,\n      overwriteAfter: overwriteAfter + suffixDelta\n    };\n  };\n\n  SuggestController.prototype._alertCompletionItem = function (_a) {\n    var suggestion = _a.completion;\n    var textLabel = typeof suggestion.label === 'string' ? suggestion.label : suggestion.label.name;\n\n    if (isNonEmptyArray(suggestion.additionalTextEdits)) {\n      var msg = nls.localize('arai.alert.snippet', \"Accepting '{0}' made {1} additional edits\", textLabel, suggestion.additionalTextEdits.length);\n      alert(msg);\n    }\n  };\n\n  SuggestController.prototype.triggerSuggest = function (onlyFrom) {\n    if (this.editor.hasModel()) {\n      this.model.trigger({\n        auto: false,\n        shy: false\n      }, false, onlyFrom);\n      this.editor.revealLine(this.editor.getPosition().lineNumber, 0\n      /* Smooth */\n      );\n      this.editor.focus();\n    }\n  };\n\n  SuggestController.prototype.triggerSuggestAndAcceptBest = function (arg) {\n    var _this = this;\n\n    if (!this.editor.hasModel()) {\n      return;\n    }\n\n    var positionNow = this.editor.getPosition();\n\n    var fallback = function () {\n      if (positionNow.equals(_this.editor.getPosition())) {\n        _this._commandService.executeCommand(arg.fallback);\n      }\n    };\n\n    var makesTextEdit = function (item) {\n      if (item.completion.insertTextRules & 4\n      /* InsertAsSnippet */\n      || item.completion.additionalTextEdits) {\n        // snippet, other editor -> makes edit\n        return true;\n      }\n\n      var position = _this.editor.getPosition();\n\n      var startColumn = item.editStart.column;\n      var endColumn = position.column;\n\n      if (endColumn - startColumn !== item.completion.insertText.length) {\n        // unequal lengths -> makes edit\n        return true;\n      }\n\n      var textNow = _this.editor.getModel().getValueInRange({\n        startLineNumber: position.lineNumber,\n        startColumn: startColumn,\n        endLineNumber: position.lineNumber,\n        endColumn: endColumn\n      }); // unequal text -> makes edit\n\n\n      return textNow !== item.completion.insertText;\n    };\n\n    Event.once(this.model.onDidTrigger)(function (_) {\n      // wait for trigger because only then the cancel-event is trustworthy\n      var listener = [];\n      Event.any(_this.model.onDidTrigger, _this.model.onDidCancel)(function () {\n        // retrigger or cancel -> try to type default text\n        dispose(listener);\n        fallback();\n      }, undefined, listener);\n\n      _this.model.onDidSuggest(function (_a) {\n        var completionModel = _a.completionModel;\n        dispose(listener);\n\n        if (completionModel.items.length === 0) {\n          fallback();\n          return;\n        }\n\n        var index = _this._memoryService.select(_this.editor.getModel(), _this.editor.getPosition(), completionModel.items);\n\n        var item = completionModel.items[index];\n\n        if (!makesTextEdit(item)) {\n          fallback();\n          return;\n        }\n\n        _this.editor.pushUndoStop();\n\n        _this._insertSuggestion({\n          index: index,\n          item: item,\n          model: completionModel\n        }, 4\n        /* KeepAlternativeSuggestions */\n        | 1\n        /* NoBeforeUndoStop */\n        | 2\n        /* NoAfterUndoStop */\n        );\n      }, undefined, listener);\n    });\n    this.model.trigger({\n      auto: false,\n      shy: true\n    });\n    this.editor.revealLine(positionNow.lineNumber, 0\n    /* Smooth */\n    );\n    this.editor.focus();\n  };\n\n  SuggestController.prototype.acceptSelectedSuggestion = function (keepAlternativeSuggestions, alternativeOverwriteConfig) {\n    var item = this.widget.getValue().getFocusedItem();\n    var flags = 0;\n\n    if (keepAlternativeSuggestions) {\n      flags |= 4\n      /* KeepAlternativeSuggestions */\n      ;\n    }\n\n    if (alternativeOverwriteConfig) {\n      flags |= 8\n      /* AlternativeOverwriteConfig */\n      ;\n    }\n\n    this._insertSuggestion(item, flags);\n  };\n\n  SuggestController.prototype.acceptNextSuggestion = function () {\n    this._alternatives.getValue().next();\n  };\n\n  SuggestController.prototype.acceptPrevSuggestion = function () {\n    this._alternatives.getValue().prev();\n  };\n\n  SuggestController.prototype.cancelSuggestWidget = function () {\n    this.model.cancel();\n    this.model.clear();\n    this.widget.getValue().hideWidget();\n  };\n\n  SuggestController.prototype.selectNextSuggestion = function () {\n    this.widget.getValue().selectNext();\n  };\n\n  SuggestController.prototype.selectNextPageSuggestion = function () {\n    this.widget.getValue().selectNextPage();\n  };\n\n  SuggestController.prototype.selectLastSuggestion = function () {\n    this.widget.getValue().selectLast();\n  };\n\n  SuggestController.prototype.selectPrevSuggestion = function () {\n    this.widget.getValue().selectPrevious();\n  };\n\n  SuggestController.prototype.selectPrevPageSuggestion = function () {\n    this.widget.getValue().selectPreviousPage();\n  };\n\n  SuggestController.prototype.selectFirstSuggestion = function () {\n    this.widget.getValue().selectFirst();\n  };\n\n  SuggestController.prototype.toggleSuggestionDetails = function () {\n    this.widget.getValue().toggleDetails();\n  };\n\n  SuggestController.prototype.toggleExplainMode = function () {\n    this.widget.getValue().toggleExplainMode();\n  };\n\n  SuggestController.prototype.toggleSuggestionFocus = function () {\n    this.widget.getValue().toggleDetailsFocus();\n  };\n\n  SuggestController.ID = 'editor.contrib.suggestController';\n  SuggestController = __decorate([__param(1, IEditorWorkerService), __param(2, ISuggestMemoryService), __param(3, ICommandService), __param(4, IContextKeyService), __param(5, IInstantiationService)], SuggestController);\n  return SuggestController;\n}();\n\nexport { SuggestController };\n\nvar TriggerSuggestAction =\n/** @class */\nfunction (_super) {\n  __extends(TriggerSuggestAction, _super);\n\n  function TriggerSuggestAction() {\n    return _super.call(this, {\n      id: TriggerSuggestAction.id,\n      label: nls.localize('suggest.trigger.label', \"Trigger Suggest\"),\n      alias: 'Trigger Suggest',\n      precondition: ContextKeyExpr.and(EditorContextKeys.writable, EditorContextKeys.hasCompletionItemProvider),\n      kbOpts: {\n        kbExpr: EditorContextKeys.textInputFocus,\n        primary: 2048\n        /* CtrlCmd */\n        | 10\n        /* Space */\n        ,\n        mac: {\n          primary: 256\n          /* WinCtrl */\n          | 10\n          /* Space */\n          ,\n          secondary: [512\n          /* Alt */\n          | 9\n          /* Escape */\n          ]\n        },\n        weight: 100\n        /* EditorContrib */\n\n      }\n    }) || this;\n  }\n\n  TriggerSuggestAction.prototype.run = function (accessor, editor) {\n    var controller = SuggestController.get(editor);\n\n    if (!controller) {\n      return;\n    }\n\n    controller.triggerSuggest();\n  };\n\n  TriggerSuggestAction.id = 'editor.action.triggerSuggest';\n  return TriggerSuggestAction;\n}(EditorAction);\n\nexport { TriggerSuggestAction };\nregisterEditorContribution(SuggestController.ID, SuggestController);\nregisterEditorAction(TriggerSuggestAction);\nvar weight = 100\n/* EditorContrib */\n+ 90;\nvar SuggestCommand = EditorCommand.bindToContribution(SuggestController.get);\nregisterEditorCommand(new SuggestCommand({\n  id: 'acceptSelectedSuggestion',\n  precondition: SuggestContext.Visible,\n  handler: function (x) {\n    x.acceptSelectedSuggestion(true, false);\n  }\n})); // normal tab\n\nKeybindingsRegistry.registerKeybindingRule({\n  id: 'acceptSelectedSuggestion',\n  when: ContextKeyExpr.and(SuggestContext.Visible, EditorContextKeys.textInputFocus),\n  primary: 2\n  /* Tab */\n  ,\n  weight: weight\n}); // accept on enter has special rules\n\nKeybindingsRegistry.registerKeybindingRule({\n  id: 'acceptSelectedSuggestion',\n  when: ContextKeyExpr.and(SuggestContext.Visible, EditorContextKeys.textInputFocus, SuggestContext.AcceptSuggestionsOnEnter, SuggestContext.MakesTextEdit),\n  primary: 3\n  /* Enter */\n  ,\n  weight: weight\n}); // todo@joh control enablement via context key\n// shift+enter and shift+tab use the alternative-flag so that the suggest controller\n// is doing the opposite of the editor.suggest.overwriteOnAccept-configuration\n\nregisterEditorCommand(new SuggestCommand({\n  id: 'acceptAlternativeSelectedSuggestion',\n  precondition: ContextKeyExpr.and(SuggestContext.Visible, EditorContextKeys.textInputFocus),\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 1024\n    /* Shift */\n    | 3\n    /* Enter */\n    ,\n    secondary: [1024\n    /* Shift */\n    | 2\n    /* Tab */\n    ]\n  },\n  handler: function (x) {\n    x.acceptSelectedSuggestion(false, true);\n  }\n})); // continue to support the old command\n\nCommandsRegistry.registerCommandAlias('acceptSelectedSuggestionOnEnter', 'acceptSelectedSuggestion');\nregisterEditorCommand(new SuggestCommand({\n  id: 'hideSuggestWidget',\n  precondition: SuggestContext.Visible,\n  handler: function (x) {\n    return x.cancelSuggestWidget();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 9\n    /* Escape */\n    ,\n    secondary: [1024\n    /* Shift */\n    | 9\n    /* Escape */\n    ]\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'selectNextSuggestion',\n  precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\n  handler: function (c) {\n    return c.selectNextSuggestion();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 18\n    /* DownArrow */\n    ,\n    secondary: [2048\n    /* CtrlCmd */\n    | 18\n    /* DownArrow */\n    ],\n    mac: {\n      primary: 18\n      /* DownArrow */\n      ,\n      secondary: [2048\n      /* CtrlCmd */\n      | 18\n      /* DownArrow */\n      , 256\n      /* WinCtrl */\n      | 44\n      /* KEY_N */\n      ]\n    }\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'selectNextPageSuggestion',\n  precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\n  handler: function (c) {\n    return c.selectNextPageSuggestion();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 12\n    /* PageDown */\n    ,\n    secondary: [2048\n    /* CtrlCmd */\n    | 12\n    /* PageDown */\n    ]\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'selectLastSuggestion',\n  precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\n  handler: function (c) {\n    return c.selectLastSuggestion();\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'selectPrevSuggestion',\n  precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\n  handler: function (c) {\n    return c.selectPrevSuggestion();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 16\n    /* UpArrow */\n    ,\n    secondary: [2048\n    /* CtrlCmd */\n    | 16\n    /* UpArrow */\n    ],\n    mac: {\n      primary: 16\n      /* UpArrow */\n      ,\n      secondary: [2048\n      /* CtrlCmd */\n      | 16\n      /* UpArrow */\n      , 256\n      /* WinCtrl */\n      | 46\n      /* KEY_P */\n      ]\n    }\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'selectPrevPageSuggestion',\n  precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\n  handler: function (c) {\n    return c.selectPrevPageSuggestion();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 11\n    /* PageUp */\n    ,\n    secondary: [2048\n    /* CtrlCmd */\n    | 11\n    /* PageUp */\n    ]\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'selectFirstSuggestion',\n  precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\n  handler: function (c) {\n    return c.selectFirstSuggestion();\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'toggleSuggestionDetails',\n  precondition: SuggestContext.Visible,\n  handler: function (x) {\n    return x.toggleSuggestionDetails();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 2048\n    /* CtrlCmd */\n    | 10\n    /* Space */\n    ,\n    mac: {\n      primary: 256\n      /* WinCtrl */\n      | 10\n      /* Space */\n\n    }\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'toggleExplainMode',\n  precondition: SuggestContext.Visible,\n  handler: function (x) {\n    return x.toggleExplainMode();\n  },\n  kbOpts: {\n    weight: 100\n    /* EditorContrib */\n    ,\n    primary: 2048\n    /* CtrlCmd */\n    | 85\n    /* US_SLASH */\n\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'toggleSuggestionFocus',\n  precondition: SuggestContext.Visible,\n  handler: function (x) {\n    return x.toggleSuggestionFocus();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 2048\n    /* CtrlCmd */\n    | 512\n    /* Alt */\n    | 10\n    /* Space */\n    ,\n    mac: {\n      primary: 256\n      /* WinCtrl */\n      | 512\n      /* Alt */\n      | 10\n      /* Space */\n\n    }\n  }\n})); //#region tab completions\n\nregisterEditorCommand(new SuggestCommand({\n  id: 'insertBestCompletion',\n  precondition: ContextKeyExpr.and(ContextKeyExpr.equals('config.editor.tabCompletion', 'on'), WordContextKey.AtEnd, SuggestContext.Visible.toNegated(), SuggestAlternatives.OtherSuggestions.toNegated(), SnippetController2.InSnippetMode.toNegated()),\n  handler: function (x, arg) {\n    x.triggerSuggestAndAcceptBest(isObject(arg) ? __assign({\n      fallback: 'tab'\n    }, arg) : {\n      fallback: 'tab'\n    });\n  },\n  kbOpts: {\n    weight: weight,\n    primary: 2\n    /* Tab */\n\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'insertNextSuggestion',\n  precondition: ContextKeyExpr.and(ContextKeyExpr.equals('config.editor.tabCompletion', 'on'), SuggestAlternatives.OtherSuggestions, SuggestContext.Visible.toNegated(), SnippetController2.InSnippetMode.toNegated()),\n  handler: function (x) {\n    return x.acceptNextSuggestion();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 2\n    /* Tab */\n\n  }\n}));\nregisterEditorCommand(new SuggestCommand({\n  id: 'insertPrevSuggestion',\n  precondition: ContextKeyExpr.and(ContextKeyExpr.equals('config.editor.tabCompletion', 'on'), SuggestAlternatives.OtherSuggestions, SuggestContext.Visible.toNegated(), SnippetController2.InSnippetMode.toNegated()),\n  handler: function (x) {\n    return x.acceptPrevSuggestion();\n  },\n  kbOpts: {\n    weight: weight,\n    kbExpr: EditorContextKeys.textInputFocus,\n    primary: 1024\n    /* Shift */\n    | 2\n    /* Tab */\n\n  }\n}));","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/editor/contrib/suggest/suggestController.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__assign","assign","t","s","i","n","arguments","length","call","apply","__decorate","decorators","target","key","desc","c","r","getOwnPropertyDescriptor","Reflect","decorate","defineProperty","__param","paramIndex","decorator","__spreadArrays","il","k","a","j","jl","alert","isNonEmptyArray","onUnexpectedError","SimpleKeybinding","dispose","DisposableStore","toDisposable","MutableDisposable","EditorAction","EditorCommand","registerEditorAction","registerEditorCommand","registerEditorContribution","EditOperation","Range","EditorContextKeys","SnippetController2","SnippetParser","ISuggestMemoryService","nls","ICommandService","CommandsRegistry","ContextKeyExpr","IContextKeyService","IInstantiationService","KeybindingsRegistry","Context","SuggestContext","SuggestAlternatives","SuggestModel","SuggestWidget","WordContextKey","Event","IEditorWorkerService","IdleValue","isObject","assertType","CommitCharacterController","platform","SuggestRangeHighlighter","_sticky","LineSuffix","_model","_position","maxColumn","getLineMaxColumn","lineNumber","column","offset","getOffsetAt","end","getPositionAt","_marker","deltaDecorations","range","fromPositions","options","stickiness","isDisposed","delta","position","getDecorationRange","getStartPosition","SuggestController","editor","editorWorker","_memoryService","_commandService","_contextKeyService","_instantiationService","_this","_lineSuffix","_toDispose","model","widget","add","createInstance","onDidSelect","item","_insertSuggestion","commitCharacterController","onDidSuggest","e","completionModel","items","reset","makesTextEdit","MakesTextEdit","bindTo","onDidFocus","_a","getPosition","startColumn","editStart","endColumn","value","getOption","state","completion","command","additionalTextEdits","insertTextRules","insertText","oldText","getModel","getValueInRange","startLineNumber","endLineNumber","set","onDetailsKeyDown","toKeybinding","equals","isMacintosh","stopPropagation","isModifierKey","focus","_alternatives","onDidTrigger","getValue","showTriggered","auto","shy","index","select","showSuggestions","isFrozen","onDidCancel","retrigger","hideWidget","onDidBlurEditorWidget","cancel","clear","acceptSuggestionsOnEnter","AcceptSuggestionsOnEnter","updateFromConfig","acceptSuggestionOnEnter","onDidChangeConfiguration","get","getContribution","ID","event","flags","hasModel","modelVersionNow","getAlternativeVersionId","suggestion","pushUndoStop","info","getOverwriteInfo","Boolean","memorize","isArray","executeEdits","map","edit","replace","lift","text","escape","insert","overwriteBefore","overwriteAfter","undoStopBefore","undoStopAfter","adjustWhitespace","id","TriggerSuggestAction","trigger","executeCommand","catch","finally","next","canUndo","undo","_alertCompletionItem","toggleMode","insertMode","editReplaceEnd","editInsertEnd","columnDelta","suffixDelta","textLabel","label","name","msg","localize","triggerSuggest","onlyFrom","revealLine","triggerSuggestAndAcceptBest","arg","positionNow","fallback","textNow","once","_","listener","any","undefined","acceptSelectedSuggestion","keepAlternativeSuggestions","alternativeOverwriteConfig","getFocusedItem","acceptNextSuggestion","acceptPrevSuggestion","prev","cancelSuggestWidget","selectNextSuggestion","selectNext","selectNextPageSuggestion","selectNextPage","selectLastSuggestion","selectLast","selectPrevSuggestion","selectPrevious","selectPrevPageSuggestion","selectPreviousPage","selectFirstSuggestion","selectFirst","toggleSuggestionDetails","toggleDetails","toggleExplainMode","toggleSuggestionFocus","toggleDetailsFocus","_super","alias","precondition","and","writable","hasCompletionItemProvider","kbOpts","kbExpr","textInputFocus","primary","mac","secondary","weight","run","accessor","controller","SuggestCommand","bindToContribution","Visible","handler","x","registerKeybindingRule","when","registerCommandAlias","MultipleSuggestions","AtEnd","toNegated","OtherSuggestions","InSnippetMode"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nvar __assign = (this && this.__assign) || function () {\r\n    __assign = Object.assign || function(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n                t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n};\r\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n};\r\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\nimport { alert } from '../../../base/browser/ui/aria/aria.js';\r\nimport { isNonEmptyArray } from '../../../base/common/arrays.js';\r\nimport { onUnexpectedError } from '../../../base/common/errors.js';\r\nimport { SimpleKeybinding } from '../../../base/common/keyCodes.js';\r\nimport { dispose, DisposableStore, toDisposable, MutableDisposable } from '../../../base/common/lifecycle.js';\r\nimport { EditorAction, EditorCommand, registerEditorAction, registerEditorCommand, registerEditorContribution } from '../../browser/editorExtensions.js';\r\nimport { EditOperation } from '../../common/core/editOperation.js';\r\nimport { Range } from '../../common/core/range.js';\r\nimport { EditorContextKeys } from '../../common/editorContextKeys.js';\r\nimport { SnippetController2 } from '../snippet/snippetController2.js';\r\nimport { SnippetParser } from '../snippet/snippetParser.js';\r\nimport { ISuggestMemoryService } from './suggestMemory.js';\r\nimport * as nls from '../../../nls.js';\r\nimport { ICommandService, CommandsRegistry } from '../../../platform/commands/common/commands.js';\r\nimport { ContextKeyExpr, IContextKeyService } from '../../../platform/contextkey/common/contextkey.js';\r\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\r\nimport { KeybindingsRegistry } from '../../../platform/keybinding/common/keybindingsRegistry.js';\r\nimport { Context as SuggestContext } from './suggest.js';\r\nimport { SuggestAlternatives } from './suggestAlternatives.js';\r\nimport { SuggestModel } from './suggestModel.js';\r\nimport { SuggestWidget } from './suggestWidget.js';\r\nimport { WordContextKey } from './wordContextKey.js';\r\nimport { Event } from '../../../base/common/event.js';\r\nimport { IEditorWorkerService } from '../../common/services/editorWorkerService.js';\r\nimport { IdleValue } from '../../../base/common/async.js';\r\nimport { isObject, assertType } from '../../../base/common/types.js';\r\nimport { CommitCharacterController } from './suggestCommitCharacters.js';\r\nimport * as platform from '../../../base/common/platform.js';\r\nimport { SuggestRangeHighlighter } from './suggestRangeHighlighter.js';\r\n/**\r\n * Stop suggest widget from disappearing when clicking into other areas\r\n * For development purpose only\r\n */\r\nvar _sticky = false;\r\nvar LineSuffix = /** @class */ (function () {\r\n    function LineSuffix(_model, _position) {\r\n        this._model = _model;\r\n        this._position = _position;\r\n        // spy on what's happening right of the cursor. two cases:\r\n        // 1. end of line -> check that it's still end of line\r\n        // 2. mid of line -> add a marker and compute the delta\r\n        var maxColumn = _model.getLineMaxColumn(_position.lineNumber);\r\n        if (maxColumn !== _position.column) {\r\n            var offset = _model.getOffsetAt(_position);\r\n            var end = _model.getPositionAt(offset + 1);\r\n            this._marker = _model.deltaDecorations([], [{\r\n                    range: Range.fromPositions(_position, end),\r\n                    options: { stickiness: 1 /* NeverGrowsWhenTypingAtEdges */ }\r\n                }]);\r\n        }\r\n    }\r\n    LineSuffix.prototype.dispose = function () {\r\n        if (this._marker && !this._model.isDisposed()) {\r\n            this._model.deltaDecorations(this._marker, []);\r\n        }\r\n    };\r\n    LineSuffix.prototype.delta = function (position) {\r\n        if (this._model.isDisposed() || this._position.lineNumber !== position.lineNumber) {\r\n            // bail out early if things seems fishy\r\n            return 0;\r\n        }\r\n        // read the marker (in case suggest was triggered at line end) or compare\r\n        // the cursor to the line end.\r\n        if (this._marker) {\r\n            var range = this._model.getDecorationRange(this._marker[0]);\r\n            var end = this._model.getOffsetAt(range.getStartPosition());\r\n            return end - this._model.getOffsetAt(position);\r\n        }\r\n        else {\r\n            return this._model.getLineMaxColumn(position.lineNumber) - position.column;\r\n        }\r\n    };\r\n    return LineSuffix;\r\n}());\r\nvar SuggestController = /** @class */ (function () {\r\n    function SuggestController(editor, editorWorker, _memoryService, _commandService, _contextKeyService, _instantiationService) {\r\n        var _this = this;\r\n        this._memoryService = _memoryService;\r\n        this._commandService = _commandService;\r\n        this._contextKeyService = _contextKeyService;\r\n        this._instantiationService = _instantiationService;\r\n        this._lineSuffix = new MutableDisposable();\r\n        this._toDispose = new DisposableStore();\r\n        this.editor = editor;\r\n        this.model = new SuggestModel(this.editor, editorWorker);\r\n        this.widget = this._toDispose.add(new IdleValue(function () {\r\n            var widget = _this._instantiationService.createInstance(SuggestWidget, _this.editor);\r\n            _this._toDispose.add(widget);\r\n            _this._toDispose.add(widget.onDidSelect(function (item) { return _this._insertSuggestion(item, 0); }, _this));\r\n            // Wire up logic to accept a suggestion on certain characters\r\n            var commitCharacterController = new CommitCharacterController(_this.editor, widget, function (item) { return _this._insertSuggestion(item, 2 /* NoAfterUndoStop */); });\r\n            _this._toDispose.add(commitCharacterController);\r\n            _this._toDispose.add(_this.model.onDidSuggest(function (e) {\r\n                if (e.completionModel.items.length === 0) {\r\n                    commitCharacterController.reset();\r\n                }\r\n            }));\r\n            // Wire up makes text edit context key\r\n            var makesTextEdit = SuggestContext.MakesTextEdit.bindTo(_this._contextKeyService);\r\n            _this._toDispose.add(widget.onDidFocus(function (_a) {\r\n                var item = _a.item;\r\n                var position = _this.editor.getPosition();\r\n                var startColumn = item.editStart.column;\r\n                var endColumn = position.column;\r\n                var value = true;\r\n                if (_this.editor.getOption(1 /* acceptSuggestionOnEnter */) === 'smart'\r\n                    && _this.model.state === 2 /* Auto */\r\n                    && !item.completion.command\r\n                    && !item.completion.additionalTextEdits\r\n                    && !(item.completion.insertTextRules & 4 /* InsertAsSnippet */)\r\n                    && endColumn - startColumn === item.completion.insertText.length) {\r\n                    var oldText = _this.editor.getModel().getValueInRange({\r\n                        startLineNumber: position.lineNumber,\r\n                        startColumn: startColumn,\r\n                        endLineNumber: position.lineNumber,\r\n                        endColumn: endColumn\r\n                    });\r\n                    value = oldText !== item.completion.insertText;\r\n                }\r\n                makesTextEdit.set(value);\r\n            }));\r\n            _this._toDispose.add(toDisposable(function () { return makesTextEdit.reset(); }));\r\n            _this._toDispose.add(widget.onDetailsKeyDown(function (e) {\r\n                // cmd + c on macOS, ctrl + c on Win / Linux\r\n                if (e.toKeybinding().equals(new SimpleKeybinding(true, false, false, false, 33 /* KEY_C */)) ||\r\n                    (platform.isMacintosh && e.toKeybinding().equals(new SimpleKeybinding(false, false, false, true, 33 /* KEY_C */)))) {\r\n                    e.stopPropagation();\r\n                    return;\r\n                }\r\n                if (!e.toKeybinding().isModifierKey()) {\r\n                    _this.editor.focus();\r\n                }\r\n            }));\r\n            return widget;\r\n        }));\r\n        this._alternatives = this._toDispose.add(new IdleValue(function () {\r\n            return _this._toDispose.add(new SuggestAlternatives(_this.editor, _this._contextKeyService));\r\n        }));\r\n        this._toDispose.add(_instantiationService.createInstance(WordContextKey, editor));\r\n        this._toDispose.add(this.model.onDidTrigger(function (e) {\r\n            _this.widget.getValue().showTriggered(e.auto, e.shy ? 250 : 50);\r\n            _this._lineSuffix.value = new LineSuffix(_this.editor.getModel(), e.position);\r\n        }));\r\n        this._toDispose.add(this.model.onDidSuggest(function (e) {\r\n            if (!e.shy) {\r\n                var index = _this._memoryService.select(_this.editor.getModel(), _this.editor.getPosition(), e.completionModel.items);\r\n                _this.widget.getValue().showSuggestions(e.completionModel, index, e.isFrozen, e.auto);\r\n            }\r\n        }));\r\n        this._toDispose.add(this.model.onDidCancel(function (e) {\r\n            if (!e.retrigger) {\r\n                _this.widget.getValue().hideWidget();\r\n            }\r\n        }));\r\n        this._toDispose.add(this.editor.onDidBlurEditorWidget(function () {\r\n            if (!_sticky) {\r\n                _this.model.cancel();\r\n                _this.model.clear();\r\n            }\r\n        }));\r\n        // Manage the acceptSuggestionsOnEnter context key\r\n        var acceptSuggestionsOnEnter = SuggestContext.AcceptSuggestionsOnEnter.bindTo(_contextKeyService);\r\n        var updateFromConfig = function () {\r\n            var acceptSuggestionOnEnter = _this.editor.getOption(1 /* acceptSuggestionOnEnter */);\r\n            acceptSuggestionsOnEnter.set(acceptSuggestionOnEnter === 'on' || acceptSuggestionOnEnter === 'smart');\r\n        };\r\n        this._toDispose.add(this.editor.onDidChangeConfiguration(function () { return updateFromConfig(); }));\r\n        updateFromConfig();\r\n        // create range highlighter\r\n        this._toDispose.add(new SuggestRangeHighlighter(this));\r\n    }\r\n    SuggestController.get = function (editor) {\r\n        return editor.getContribution(SuggestController.ID);\r\n    };\r\n    SuggestController.prototype.dispose = function () {\r\n        this._alternatives.dispose();\r\n        this._toDispose.dispose();\r\n        this.widget.dispose();\r\n        this.model.dispose();\r\n        this._lineSuffix.dispose();\r\n    };\r\n    SuggestController.prototype._insertSuggestion = function (event, flags) {\r\n        var _a;\r\n        var _this = this;\r\n        if (!event || !event.item) {\r\n            this._alternatives.getValue().reset();\r\n            this.model.cancel();\r\n            this.model.clear();\r\n            return;\r\n        }\r\n        if (!this.editor.hasModel()) {\r\n            return;\r\n        }\r\n        var model = this.editor.getModel();\r\n        var modelVersionNow = model.getAlternativeVersionId();\r\n        var item = event.item;\r\n        var suggestion = item.completion;\r\n        // pushing undo stops *before* additional text edits and\r\n        // *after* the main edit\r\n        if (!(flags & 1 /* NoBeforeUndoStop */)) {\r\n            this.editor.pushUndoStop();\r\n        }\r\n        // compute overwrite[Before|After] deltas BEFORE applying extra edits\r\n        var info = this.getOverwriteInfo(item, Boolean(flags & 8 /* AlternativeOverwriteConfig */));\r\n        // keep item in memory\r\n        this._memoryService.memorize(model, this.editor.getPosition(), item);\r\n        if (Array.isArray(suggestion.additionalTextEdits)) {\r\n            this.editor.executeEdits('suggestController.additionalTextEdits', suggestion.additionalTextEdits.map(function (edit) { return EditOperation.replace(Range.lift(edit.range), edit.text); }));\r\n        }\r\n        var insertText = suggestion.insertText;\r\n        if (!(suggestion.insertTextRules & 4 /* InsertAsSnippet */)) {\r\n            insertText = SnippetParser.escape(insertText);\r\n        }\r\n        SnippetController2.get(this.editor).insert(insertText, {\r\n            overwriteBefore: info.overwriteBefore,\r\n            overwriteAfter: info.overwriteAfter,\r\n            undoStopBefore: false,\r\n            undoStopAfter: false,\r\n            adjustWhitespace: !(suggestion.insertTextRules & 1 /* KeepWhitespace */)\r\n        });\r\n        if (!(flags & 2 /* NoAfterUndoStop */)) {\r\n            this.editor.pushUndoStop();\r\n        }\r\n        if (!suggestion.command) {\r\n            // done\r\n            this.model.cancel();\r\n            this.model.clear();\r\n        }\r\n        else if (suggestion.command.id === TriggerSuggestAction.id) {\r\n            // retigger\r\n            this.model.trigger({ auto: true, shy: false }, true);\r\n        }\r\n        else {\r\n            // exec command, done\r\n            (_a = this._commandService).executeCommand.apply(_a, __spreadArrays([suggestion.command.id], (suggestion.command.arguments ? __spreadArrays(suggestion.command.arguments) : []))).catch(onUnexpectedError)\r\n                .finally(function () { return _this.model.clear(); }); // <- clear only now, keep commands alive\r\n            this.model.cancel();\r\n        }\r\n        if (flags & 4 /* KeepAlternativeSuggestions */) {\r\n            this._alternatives.getValue().set(event, function (next) {\r\n                // this is not so pretty. when inserting the 'next'\r\n                // suggestion we undo until we are at the state at\r\n                // which we were before inserting the previous suggestion...\r\n                while (model.canUndo()) {\r\n                    if (modelVersionNow !== model.getAlternativeVersionId()) {\r\n                        model.undo();\r\n                    }\r\n                    _this._insertSuggestion(next, 1 /* NoBeforeUndoStop */ | 2 /* NoAfterUndoStop */ | (flags & 8 /* AlternativeOverwriteConfig */ ? 8 /* AlternativeOverwriteConfig */ : 0));\r\n                    break;\r\n                }\r\n            });\r\n        }\r\n        this._alertCompletionItem(event.item);\r\n    };\r\n    SuggestController.prototype.getOverwriteInfo = function (item, toggleMode) {\r\n        assertType(this.editor.hasModel());\r\n        var replace = this.editor.getOption(89 /* suggest */).insertMode === 'replace';\r\n        if (toggleMode) {\r\n            replace = !replace;\r\n        }\r\n        var overwriteBefore = item.position.column - item.editStart.column;\r\n        var overwriteAfter = (replace ? item.editReplaceEnd.column : item.editInsertEnd.column) - item.position.column;\r\n        var columnDelta = this.editor.getPosition().column - item.position.column;\r\n        var suffixDelta = this._lineSuffix.value ? this._lineSuffix.value.delta(this.editor.getPosition()) : 0;\r\n        return {\r\n            overwriteBefore: overwriteBefore + columnDelta,\r\n            overwriteAfter: overwriteAfter + suffixDelta\r\n        };\r\n    };\r\n    SuggestController.prototype._alertCompletionItem = function (_a) {\r\n        var suggestion = _a.completion;\r\n        var textLabel = typeof suggestion.label === 'string' ? suggestion.label : suggestion.label.name;\r\n        if (isNonEmptyArray(suggestion.additionalTextEdits)) {\r\n            var msg = nls.localize('arai.alert.snippet', \"Accepting '{0}' made {1} additional edits\", textLabel, suggestion.additionalTextEdits.length);\r\n            alert(msg);\r\n        }\r\n    };\r\n    SuggestController.prototype.triggerSuggest = function (onlyFrom) {\r\n        if (this.editor.hasModel()) {\r\n            this.model.trigger({ auto: false, shy: false }, false, onlyFrom);\r\n            this.editor.revealLine(this.editor.getPosition().lineNumber, 0 /* Smooth */);\r\n            this.editor.focus();\r\n        }\r\n    };\r\n    SuggestController.prototype.triggerSuggestAndAcceptBest = function (arg) {\r\n        var _this = this;\r\n        if (!this.editor.hasModel()) {\r\n            return;\r\n        }\r\n        var positionNow = this.editor.getPosition();\r\n        var fallback = function () {\r\n            if (positionNow.equals(_this.editor.getPosition())) {\r\n                _this._commandService.executeCommand(arg.fallback);\r\n            }\r\n        };\r\n        var makesTextEdit = function (item) {\r\n            if (item.completion.insertTextRules & 4 /* InsertAsSnippet */ || item.completion.additionalTextEdits) {\r\n                // snippet, other editor -> makes edit\r\n                return true;\r\n            }\r\n            var position = _this.editor.getPosition();\r\n            var startColumn = item.editStart.column;\r\n            var endColumn = position.column;\r\n            if (endColumn - startColumn !== item.completion.insertText.length) {\r\n                // unequal lengths -> makes edit\r\n                return true;\r\n            }\r\n            var textNow = _this.editor.getModel().getValueInRange({\r\n                startLineNumber: position.lineNumber,\r\n                startColumn: startColumn,\r\n                endLineNumber: position.lineNumber,\r\n                endColumn: endColumn\r\n            });\r\n            // unequal text -> makes edit\r\n            return textNow !== item.completion.insertText;\r\n        };\r\n        Event.once(this.model.onDidTrigger)(function (_) {\r\n            // wait for trigger because only then the cancel-event is trustworthy\r\n            var listener = [];\r\n            Event.any(_this.model.onDidTrigger, _this.model.onDidCancel)(function () {\r\n                // retrigger or cancel -> try to type default text\r\n                dispose(listener);\r\n                fallback();\r\n            }, undefined, listener);\r\n            _this.model.onDidSuggest(function (_a) {\r\n                var completionModel = _a.completionModel;\r\n                dispose(listener);\r\n                if (completionModel.items.length === 0) {\r\n                    fallback();\r\n                    return;\r\n                }\r\n                var index = _this._memoryService.select(_this.editor.getModel(), _this.editor.getPosition(), completionModel.items);\r\n                var item = completionModel.items[index];\r\n                if (!makesTextEdit(item)) {\r\n                    fallback();\r\n                    return;\r\n                }\r\n                _this.editor.pushUndoStop();\r\n                _this._insertSuggestion({ index: index, item: item, model: completionModel }, 4 /* KeepAlternativeSuggestions */ | 1 /* NoBeforeUndoStop */ | 2 /* NoAfterUndoStop */);\r\n            }, undefined, listener);\r\n        });\r\n        this.model.trigger({ auto: false, shy: true });\r\n        this.editor.revealLine(positionNow.lineNumber, 0 /* Smooth */);\r\n        this.editor.focus();\r\n    };\r\n    SuggestController.prototype.acceptSelectedSuggestion = function (keepAlternativeSuggestions, alternativeOverwriteConfig) {\r\n        var item = this.widget.getValue().getFocusedItem();\r\n        var flags = 0;\r\n        if (keepAlternativeSuggestions) {\r\n            flags |= 4 /* KeepAlternativeSuggestions */;\r\n        }\r\n        if (alternativeOverwriteConfig) {\r\n            flags |= 8 /* AlternativeOverwriteConfig */;\r\n        }\r\n        this._insertSuggestion(item, flags);\r\n    };\r\n    SuggestController.prototype.acceptNextSuggestion = function () {\r\n        this._alternatives.getValue().next();\r\n    };\r\n    SuggestController.prototype.acceptPrevSuggestion = function () {\r\n        this._alternatives.getValue().prev();\r\n    };\r\n    SuggestController.prototype.cancelSuggestWidget = function () {\r\n        this.model.cancel();\r\n        this.model.clear();\r\n        this.widget.getValue().hideWidget();\r\n    };\r\n    SuggestController.prototype.selectNextSuggestion = function () {\r\n        this.widget.getValue().selectNext();\r\n    };\r\n    SuggestController.prototype.selectNextPageSuggestion = function () {\r\n        this.widget.getValue().selectNextPage();\r\n    };\r\n    SuggestController.prototype.selectLastSuggestion = function () {\r\n        this.widget.getValue().selectLast();\r\n    };\r\n    SuggestController.prototype.selectPrevSuggestion = function () {\r\n        this.widget.getValue().selectPrevious();\r\n    };\r\n    SuggestController.prototype.selectPrevPageSuggestion = function () {\r\n        this.widget.getValue().selectPreviousPage();\r\n    };\r\n    SuggestController.prototype.selectFirstSuggestion = function () {\r\n        this.widget.getValue().selectFirst();\r\n    };\r\n    SuggestController.prototype.toggleSuggestionDetails = function () {\r\n        this.widget.getValue().toggleDetails();\r\n    };\r\n    SuggestController.prototype.toggleExplainMode = function () {\r\n        this.widget.getValue().toggleExplainMode();\r\n    };\r\n    SuggestController.prototype.toggleSuggestionFocus = function () {\r\n        this.widget.getValue().toggleDetailsFocus();\r\n    };\r\n    SuggestController.ID = 'editor.contrib.suggestController';\r\n    SuggestController = __decorate([\r\n        __param(1, IEditorWorkerService),\r\n        __param(2, ISuggestMemoryService),\r\n        __param(3, ICommandService),\r\n        __param(4, IContextKeyService),\r\n        __param(5, IInstantiationService)\r\n    ], SuggestController);\r\n    return SuggestController;\r\n}());\r\nexport { SuggestController };\r\nvar TriggerSuggestAction = /** @class */ (function (_super) {\r\n    __extends(TriggerSuggestAction, _super);\r\n    function TriggerSuggestAction() {\r\n        return _super.call(this, {\r\n            id: TriggerSuggestAction.id,\r\n            label: nls.localize('suggest.trigger.label', \"Trigger Suggest\"),\r\n            alias: 'Trigger Suggest',\r\n            precondition: ContextKeyExpr.and(EditorContextKeys.writable, EditorContextKeys.hasCompletionItemProvider),\r\n            kbOpts: {\r\n                kbExpr: EditorContextKeys.textInputFocus,\r\n                primary: 2048 /* CtrlCmd */ | 10 /* Space */,\r\n                mac: { primary: 256 /* WinCtrl */ | 10 /* Space */, secondary: [512 /* Alt */ | 9 /* Escape */] },\r\n                weight: 100 /* EditorContrib */\r\n            }\r\n        }) || this;\r\n    }\r\n    TriggerSuggestAction.prototype.run = function (accessor, editor) {\r\n        var controller = SuggestController.get(editor);\r\n        if (!controller) {\r\n            return;\r\n        }\r\n        controller.triggerSuggest();\r\n    };\r\n    TriggerSuggestAction.id = 'editor.action.triggerSuggest';\r\n    return TriggerSuggestAction;\r\n}(EditorAction));\r\nexport { TriggerSuggestAction };\r\nregisterEditorContribution(SuggestController.ID, SuggestController);\r\nregisterEditorAction(TriggerSuggestAction);\r\nvar weight = 100 /* EditorContrib */ + 90;\r\nvar SuggestCommand = EditorCommand.bindToContribution(SuggestController.get);\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'acceptSelectedSuggestion',\r\n    precondition: SuggestContext.Visible,\r\n    handler: function (x) {\r\n        x.acceptSelectedSuggestion(true, false);\r\n    }\r\n}));\r\n// normal tab\r\nKeybindingsRegistry.registerKeybindingRule({\r\n    id: 'acceptSelectedSuggestion',\r\n    when: ContextKeyExpr.and(SuggestContext.Visible, EditorContextKeys.textInputFocus),\r\n    primary: 2 /* Tab */,\r\n    weight: weight\r\n});\r\n// accept on enter has special rules\r\nKeybindingsRegistry.registerKeybindingRule({\r\n    id: 'acceptSelectedSuggestion',\r\n    when: ContextKeyExpr.and(SuggestContext.Visible, EditorContextKeys.textInputFocus, SuggestContext.AcceptSuggestionsOnEnter, SuggestContext.MakesTextEdit),\r\n    primary: 3 /* Enter */,\r\n    weight: weight\r\n});\r\n// todo@joh control enablement via context key\r\n// shift+enter and shift+tab use the alternative-flag so that the suggest controller\r\n// is doing the opposite of the editor.suggest.overwriteOnAccept-configuration\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'acceptAlternativeSelectedSuggestion',\r\n    precondition: ContextKeyExpr.and(SuggestContext.Visible, EditorContextKeys.textInputFocus),\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 1024 /* Shift */ | 3 /* Enter */,\r\n        secondary: [1024 /* Shift */ | 2 /* Tab */],\r\n    },\r\n    handler: function (x) {\r\n        x.acceptSelectedSuggestion(false, true);\r\n    },\r\n}));\r\n// continue to support the old command\r\nCommandsRegistry.registerCommandAlias('acceptSelectedSuggestionOnEnter', 'acceptSelectedSuggestion');\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'hideSuggestWidget',\r\n    precondition: SuggestContext.Visible,\r\n    handler: function (x) { return x.cancelSuggestWidget(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 9 /* Escape */,\r\n        secondary: [1024 /* Shift */ | 9 /* Escape */]\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'selectNextSuggestion',\r\n    precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\r\n    handler: function (c) { return c.selectNextSuggestion(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 18 /* DownArrow */,\r\n        secondary: [2048 /* CtrlCmd */ | 18 /* DownArrow */],\r\n        mac: { primary: 18 /* DownArrow */, secondary: [2048 /* CtrlCmd */ | 18 /* DownArrow */, 256 /* WinCtrl */ | 44 /* KEY_N */] }\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'selectNextPageSuggestion',\r\n    precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\r\n    handler: function (c) { return c.selectNextPageSuggestion(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 12 /* PageDown */,\r\n        secondary: [2048 /* CtrlCmd */ | 12 /* PageDown */]\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'selectLastSuggestion',\r\n    precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\r\n    handler: function (c) { return c.selectLastSuggestion(); }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'selectPrevSuggestion',\r\n    precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\r\n    handler: function (c) { return c.selectPrevSuggestion(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 16 /* UpArrow */,\r\n        secondary: [2048 /* CtrlCmd */ | 16 /* UpArrow */],\r\n        mac: { primary: 16 /* UpArrow */, secondary: [2048 /* CtrlCmd */ | 16 /* UpArrow */, 256 /* WinCtrl */ | 46 /* KEY_P */] }\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'selectPrevPageSuggestion',\r\n    precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\r\n    handler: function (c) { return c.selectPrevPageSuggestion(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 11 /* PageUp */,\r\n        secondary: [2048 /* CtrlCmd */ | 11 /* PageUp */]\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'selectFirstSuggestion',\r\n    precondition: ContextKeyExpr.and(SuggestContext.Visible, SuggestContext.MultipleSuggestions),\r\n    handler: function (c) { return c.selectFirstSuggestion(); }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'toggleSuggestionDetails',\r\n    precondition: SuggestContext.Visible,\r\n    handler: function (x) { return x.toggleSuggestionDetails(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 2048 /* CtrlCmd */ | 10 /* Space */,\r\n        mac: { primary: 256 /* WinCtrl */ | 10 /* Space */ }\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'toggleExplainMode',\r\n    precondition: SuggestContext.Visible,\r\n    handler: function (x) { return x.toggleExplainMode(); },\r\n    kbOpts: {\r\n        weight: 100 /* EditorContrib */,\r\n        primary: 2048 /* CtrlCmd */ | 85 /* US_SLASH */,\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'toggleSuggestionFocus',\r\n    precondition: SuggestContext.Visible,\r\n    handler: function (x) { return x.toggleSuggestionFocus(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 2048 /* CtrlCmd */ | 512 /* Alt */ | 10 /* Space */,\r\n        mac: { primary: 256 /* WinCtrl */ | 512 /* Alt */ | 10 /* Space */ }\r\n    }\r\n}));\r\n//#region tab completions\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'insertBestCompletion',\r\n    precondition: ContextKeyExpr.and(ContextKeyExpr.equals('config.editor.tabCompletion', 'on'), WordContextKey.AtEnd, SuggestContext.Visible.toNegated(), SuggestAlternatives.OtherSuggestions.toNegated(), SnippetController2.InSnippetMode.toNegated()),\r\n    handler: function (x, arg) {\r\n        x.triggerSuggestAndAcceptBest(isObject(arg) ? __assign({ fallback: 'tab' }, arg) : { fallback: 'tab' });\r\n    },\r\n    kbOpts: {\r\n        weight: weight,\r\n        primary: 2 /* Tab */\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'insertNextSuggestion',\r\n    precondition: ContextKeyExpr.and(ContextKeyExpr.equals('config.editor.tabCompletion', 'on'), SuggestAlternatives.OtherSuggestions, SuggestContext.Visible.toNegated(), SnippetController2.InSnippetMode.toNegated()),\r\n    handler: function (x) { return x.acceptNextSuggestion(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 2 /* Tab */\r\n    }\r\n}));\r\nregisterEditorCommand(new SuggestCommand({\r\n    id: 'insertPrevSuggestion',\r\n    precondition: ContextKeyExpr.and(ContextKeyExpr.equals('config.editor.tabCompletion', 'on'), SuggestAlternatives.OtherSuggestions, SuggestContext.Visible.toNegated(), SnippetController2.InSnippetMode.toNegated()),\r\n    handler: function (x) { return x.acceptPrevSuggestion(); },\r\n    kbOpts: {\r\n        weight: weight,\r\n        kbExpr: EditorContextKeys.textInputFocus,\r\n        primary: 1024 /* Shift */ | 2 /* Tab */\r\n    }\r\n}));\r\n"]},"metadata":{},"sourceType":"module"}