{"ast":null,"code":"/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\nimport { isFalsyOrEmpty } from '../../../base/common/arrays.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { isEmptyObject } from '../../../base/common/types.js';\nimport { Event, Emitter } from '../../../base/common/event.js';\nimport { MarkerSeverity } from './markers.js';\nvar MapMap;\n\n(function (MapMap) {\n  function get(map, key1, key2) {\n    if (map[key1]) {\n      return map[key1][key2];\n    }\n\n    return undefined;\n  }\n\n  MapMap.get = get;\n\n  function set(map, key1, key2, value) {\n    if (!map[key1]) {\n      map[key1] = Object.create(null);\n    }\n\n    map[key1][key2] = value;\n  }\n\n  MapMap.set = set;\n\n  function remove(map, key1, key2) {\n    if (map[key1] && map[key1][key2]) {\n      delete map[key1][key2];\n\n      if (isEmptyObject(map[key1])) {\n        delete map[key1];\n      }\n\n      return true;\n    }\n\n    return false;\n  }\n\n  MapMap.remove = remove;\n})(MapMap || (MapMap = {}));\n\nvar MarkerStats =\n/** @class */\nfunction () {\n  function MarkerStats(service) {\n    this.errors = 0;\n    this.infos = 0;\n    this.warnings = 0;\n    this.unknowns = 0;\n    this._data = Object.create(null);\n    this._service = service;\n    this._subscription = service.onMarkerChanged(this._update, this);\n  }\n\n  MarkerStats.prototype.dispose = function () {\n    this._subscription.dispose();\n\n    this._data = undefined;\n  };\n\n  MarkerStats.prototype._update = function (resources) {\n    if (!this._data) {\n      return;\n    }\n\n    for (var _i = 0, resources_1 = resources; _i < resources_1.length; _i++) {\n      var resource = resources_1[_i];\n      var key = resource.toString();\n      var oldStats = this._data[key];\n\n      if (oldStats) {\n        this._substract(oldStats);\n      }\n\n      var newStats = this._resourceStats(resource);\n\n      this._add(newStats);\n\n      this._data[key] = newStats;\n    }\n  };\n\n  MarkerStats.prototype._resourceStats = function (resource) {\n    var result = {\n      errors: 0,\n      warnings: 0,\n      infos: 0,\n      unknowns: 0\n    }; // TODO this is a hack\n\n    if (resource.scheme === Schemas.inMemory || resource.scheme === Schemas.walkThrough || resource.scheme === Schemas.walkThroughSnippet) {\n      return result;\n    }\n\n    for (var _i = 0, _a = this._service.read({\n      resource: resource\n    }); _i < _a.length; _i++) {\n      var severity = _a[_i].severity;\n\n      if (severity === MarkerSeverity.Error) {\n        result.errors += 1;\n      } else if (severity === MarkerSeverity.Warning) {\n        result.warnings += 1;\n      } else if (severity === MarkerSeverity.Info) {\n        result.infos += 1;\n      } else {\n        result.unknowns += 1;\n      }\n    }\n\n    return result;\n  };\n\n  MarkerStats.prototype._substract = function (op) {\n    this.errors -= op.errors;\n    this.warnings -= op.warnings;\n    this.infos -= op.infos;\n    this.unknowns -= op.unknowns;\n  };\n\n  MarkerStats.prototype._add = function (op) {\n    this.errors += op.errors;\n    this.warnings += op.warnings;\n    this.infos += op.infos;\n    this.unknowns += op.unknowns;\n  };\n\n  return MarkerStats;\n}();\n\nvar MarkerService =\n/** @class */\nfunction () {\n  function MarkerService() {\n    this._onMarkerChanged = new Emitter();\n    this._onMarkerChangedEvent = Event.debounce(this._onMarkerChanged.event, MarkerService._debouncer, 0);\n    this._byResource = Object.create(null);\n    this._byOwner = Object.create(null);\n    this._stats = new MarkerStats(this);\n  }\n\n  MarkerService.prototype.dispose = function () {\n    this._stats.dispose();\n  };\n\n  Object.defineProperty(MarkerService.prototype, \"onMarkerChanged\", {\n    get: function () {\n      return this._onMarkerChangedEvent;\n    },\n    enumerable: true,\n    configurable: true\n  });\n\n  MarkerService.prototype.remove = function (owner, resources) {\n    for (var _i = 0, _a = resources || []; _i < _a.length; _i++) {\n      var resource = _a[_i];\n      this.changeOne(owner, resource, []);\n    }\n  };\n\n  MarkerService.prototype.changeOne = function (owner, resource, markerData) {\n    if (isFalsyOrEmpty(markerData)) {\n      // remove marker for this (owner,resource)-tuple\n      var a = MapMap.remove(this._byResource, resource.toString(), owner);\n      var b = MapMap.remove(this._byOwner, owner, resource.toString());\n\n      if (a !== b) {\n        throw new Error('invalid marker service state');\n      }\n\n      if (a && b) {\n        this._onMarkerChanged.fire([resource]);\n      }\n    } else {\n      // insert marker for this (owner,resource)-tuple\n      var markers = [];\n\n      for (var _i = 0, markerData_1 = markerData; _i < markerData_1.length; _i++) {\n        var data = markerData_1[_i];\n\n        var marker = MarkerService._toMarker(owner, resource, data);\n\n        if (marker) {\n          markers.push(marker);\n        }\n      }\n\n      MapMap.set(this._byResource, resource.toString(), owner, markers);\n      MapMap.set(this._byOwner, owner, resource.toString(), markers);\n\n      this._onMarkerChanged.fire([resource]);\n    }\n  };\n\n  MarkerService._toMarker = function (owner, resource, data) {\n    var code = data.code,\n        severity = data.severity,\n        message = data.message,\n        source = data.source,\n        startLineNumber = data.startLineNumber,\n        startColumn = data.startColumn,\n        endLineNumber = data.endLineNumber,\n        endColumn = data.endColumn,\n        relatedInformation = data.relatedInformation,\n        tags = data.tags;\n\n    if (!message) {\n      return undefined;\n    } // santize data\n\n\n    startLineNumber = startLineNumber > 0 ? startLineNumber : 1;\n    startColumn = startColumn > 0 ? startColumn : 1;\n    endLineNumber = endLineNumber >= startLineNumber ? endLineNumber : startLineNumber;\n    endColumn = endColumn > 0 ? endColumn : startColumn;\n    return {\n      resource: resource,\n      owner: owner,\n      code: code,\n      severity: severity,\n      message: message,\n      source: source,\n      startLineNumber: startLineNumber,\n      startColumn: startColumn,\n      endLineNumber: endLineNumber,\n      endColumn: endColumn,\n      relatedInformation: relatedInformation,\n      tags: tags\n    };\n  };\n\n  MarkerService.prototype.read = function (filter) {\n    if (filter === void 0) {\n      filter = Object.create(null);\n    }\n\n    var owner = filter.owner,\n        resource = filter.resource,\n        severities = filter.severities,\n        take = filter.take;\n\n    if (!take || take < 0) {\n      take = -1;\n    }\n\n    if (owner && resource) {\n      // exactly one owner AND resource\n      var data = MapMap.get(this._byResource, resource.toString(), owner);\n\n      if (!data) {\n        return [];\n      } else {\n        var result = [];\n\n        for (var _i = 0, data_1 = data; _i < data_1.length; _i++) {\n          var marker = data_1[_i];\n\n          if (MarkerService._accept(marker, severities)) {\n            var newLen = result.push(marker);\n\n            if (take > 0 && newLen === take) {\n              break;\n            }\n          }\n        }\n\n        return result;\n      }\n    } else if (!owner && !resource) {\n      // all\n      var result = [];\n\n      for (var key1 in this._byResource) {\n        for (var key2 in this._byResource[key1]) {\n          for (var _a = 0, _b = this._byResource[key1][key2]; _a < _b.length; _a++) {\n            var data = _b[_a];\n\n            if (MarkerService._accept(data, severities)) {\n              var newLen = result.push(data);\n\n              if (take > 0 && newLen === take) {\n                return result;\n              }\n            }\n          }\n        }\n      }\n\n      return result;\n    } else {\n      // of one resource OR owner\n      var map = owner ? this._byOwner[owner] : resource ? this._byResource[resource.toString()] : undefined;\n\n      if (!map) {\n        return [];\n      }\n\n      var result = [];\n\n      for (var key in map) {\n        for (var _c = 0, _d = map[key]; _c < _d.length; _c++) {\n          var data = _d[_c];\n\n          if (MarkerService._accept(data, severities)) {\n            var newLen = result.push(data);\n\n            if (take > 0 && newLen === take) {\n              return result;\n            }\n          }\n        }\n      }\n\n      return result;\n    }\n  };\n\n  MarkerService._accept = function (marker, severities) {\n    return severities === undefined || (severities & marker.severity) === marker.severity;\n  };\n\n  MarkerService._debouncer = function (last, event) {\n    if (!last) {\n      MarkerService._dedupeMap = Object.create(null);\n      last = [];\n    }\n\n    for (var _i = 0, event_1 = event; _i < event_1.length; _i++) {\n      var uri = event_1[_i];\n\n      if (MarkerService._dedupeMap[uri.toString()] === undefined) {\n        MarkerService._dedupeMap[uri.toString()] = true;\n        last.push(uri);\n      }\n    }\n\n    return last;\n  };\n\n  return MarkerService;\n}();\n\nexport { MarkerService };","map":{"version":3,"sources":["/Users/ifudata/eclipse-workspace/screen-web/node_modules/monaco-editor/esm/vs/platform/markers/common/markerService.js"],"names":["isFalsyOrEmpty","Schemas","isEmptyObject","Event","Emitter","MarkerSeverity","MapMap","get","map","key1","key2","undefined","set","value","Object","create","remove","MarkerStats","service","errors","infos","warnings","unknowns","_data","_service","_subscription","onMarkerChanged","_update","prototype","dispose","resources","_i","resources_1","length","resource","key","toString","oldStats","_substract","newStats","_resourceStats","_add","result","scheme","inMemory","walkThrough","walkThroughSnippet","_a","read","severity","Error","Warning","Info","op","MarkerService","_onMarkerChanged","_onMarkerChangedEvent","debounce","event","_debouncer","_byResource","_byOwner","_stats","defineProperty","enumerable","configurable","owner","changeOne","markerData","a","b","fire","markers","markerData_1","data","marker","_toMarker","push","code","message","source","startLineNumber","startColumn","endLineNumber","endColumn","relatedInformation","tags","filter","severities","take","data_1","_accept","newLen","_b","_c","_d","last","_dedupeMap","event_1","uri"],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/\r\nimport { isFalsyOrEmpty } from '../../../base/common/arrays.js';\r\nimport { Schemas } from '../../../base/common/network.js';\r\nimport { isEmptyObject } from '../../../base/common/types.js';\r\nimport { Event, Emitter } from '../../../base/common/event.js';\r\nimport { MarkerSeverity } from './markers.js';\r\nvar MapMap;\r\n(function (MapMap) {\r\n    function get(map, key1, key2) {\r\n        if (map[key1]) {\r\n            return map[key1][key2];\r\n        }\r\n        return undefined;\r\n    }\r\n    MapMap.get = get;\r\n    function set(map, key1, key2, value) {\r\n        if (!map[key1]) {\r\n            map[key1] = Object.create(null);\r\n        }\r\n        map[key1][key2] = value;\r\n    }\r\n    MapMap.set = set;\r\n    function remove(map, key1, key2) {\r\n        if (map[key1] && map[key1][key2]) {\r\n            delete map[key1][key2];\r\n            if (isEmptyObject(map[key1])) {\r\n                delete map[key1];\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    MapMap.remove = remove;\r\n})(MapMap || (MapMap = {}));\r\nvar MarkerStats = /** @class */ (function () {\r\n    function MarkerStats(service) {\r\n        this.errors = 0;\r\n        this.infos = 0;\r\n        this.warnings = 0;\r\n        this.unknowns = 0;\r\n        this._data = Object.create(null);\r\n        this._service = service;\r\n        this._subscription = service.onMarkerChanged(this._update, this);\r\n    }\r\n    MarkerStats.prototype.dispose = function () {\r\n        this._subscription.dispose();\r\n        this._data = undefined;\r\n    };\r\n    MarkerStats.prototype._update = function (resources) {\r\n        if (!this._data) {\r\n            return;\r\n        }\r\n        for (var _i = 0, resources_1 = resources; _i < resources_1.length; _i++) {\r\n            var resource = resources_1[_i];\r\n            var key = resource.toString();\r\n            var oldStats = this._data[key];\r\n            if (oldStats) {\r\n                this._substract(oldStats);\r\n            }\r\n            var newStats = this._resourceStats(resource);\r\n            this._add(newStats);\r\n            this._data[key] = newStats;\r\n        }\r\n    };\r\n    MarkerStats.prototype._resourceStats = function (resource) {\r\n        var result = { errors: 0, warnings: 0, infos: 0, unknowns: 0 };\r\n        // TODO this is a hack\r\n        if (resource.scheme === Schemas.inMemory || resource.scheme === Schemas.walkThrough || resource.scheme === Schemas.walkThroughSnippet) {\r\n            return result;\r\n        }\r\n        for (var _i = 0, _a = this._service.read({ resource: resource }); _i < _a.length; _i++) {\r\n            var severity = _a[_i].severity;\r\n            if (severity === MarkerSeverity.Error) {\r\n                result.errors += 1;\r\n            }\r\n            else if (severity === MarkerSeverity.Warning) {\r\n                result.warnings += 1;\r\n            }\r\n            else if (severity === MarkerSeverity.Info) {\r\n                result.infos += 1;\r\n            }\r\n            else {\r\n                result.unknowns += 1;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n    MarkerStats.prototype._substract = function (op) {\r\n        this.errors -= op.errors;\r\n        this.warnings -= op.warnings;\r\n        this.infos -= op.infos;\r\n        this.unknowns -= op.unknowns;\r\n    };\r\n    MarkerStats.prototype._add = function (op) {\r\n        this.errors += op.errors;\r\n        this.warnings += op.warnings;\r\n        this.infos += op.infos;\r\n        this.unknowns += op.unknowns;\r\n    };\r\n    return MarkerStats;\r\n}());\r\nvar MarkerService = /** @class */ (function () {\r\n    function MarkerService() {\r\n        this._onMarkerChanged = new Emitter();\r\n        this._onMarkerChangedEvent = Event.debounce(this._onMarkerChanged.event, MarkerService._debouncer, 0);\r\n        this._byResource = Object.create(null);\r\n        this._byOwner = Object.create(null);\r\n        this._stats = new MarkerStats(this);\r\n    }\r\n    MarkerService.prototype.dispose = function () {\r\n        this._stats.dispose();\r\n    };\r\n    Object.defineProperty(MarkerService.prototype, \"onMarkerChanged\", {\r\n        get: function () {\r\n            return this._onMarkerChangedEvent;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    MarkerService.prototype.remove = function (owner, resources) {\r\n        for (var _i = 0, _a = resources || []; _i < _a.length; _i++) {\r\n            var resource = _a[_i];\r\n            this.changeOne(owner, resource, []);\r\n        }\r\n    };\r\n    MarkerService.prototype.changeOne = function (owner, resource, markerData) {\r\n        if (isFalsyOrEmpty(markerData)) {\r\n            // remove marker for this (owner,resource)-tuple\r\n            var a = MapMap.remove(this._byResource, resource.toString(), owner);\r\n            var b = MapMap.remove(this._byOwner, owner, resource.toString());\r\n            if (a !== b) {\r\n                throw new Error('invalid marker service state');\r\n            }\r\n            if (a && b) {\r\n                this._onMarkerChanged.fire([resource]);\r\n            }\r\n        }\r\n        else {\r\n            // insert marker for this (owner,resource)-tuple\r\n            var markers = [];\r\n            for (var _i = 0, markerData_1 = markerData; _i < markerData_1.length; _i++) {\r\n                var data = markerData_1[_i];\r\n                var marker = MarkerService._toMarker(owner, resource, data);\r\n                if (marker) {\r\n                    markers.push(marker);\r\n                }\r\n            }\r\n            MapMap.set(this._byResource, resource.toString(), owner, markers);\r\n            MapMap.set(this._byOwner, owner, resource.toString(), markers);\r\n            this._onMarkerChanged.fire([resource]);\r\n        }\r\n    };\r\n    MarkerService._toMarker = function (owner, resource, data) {\r\n        var code = data.code, severity = data.severity, message = data.message, source = data.source, startLineNumber = data.startLineNumber, startColumn = data.startColumn, endLineNumber = data.endLineNumber, endColumn = data.endColumn, relatedInformation = data.relatedInformation, tags = data.tags;\r\n        if (!message) {\r\n            return undefined;\r\n        }\r\n        // santize data\r\n        startLineNumber = startLineNumber > 0 ? startLineNumber : 1;\r\n        startColumn = startColumn > 0 ? startColumn : 1;\r\n        endLineNumber = endLineNumber >= startLineNumber ? endLineNumber : startLineNumber;\r\n        endColumn = endColumn > 0 ? endColumn : startColumn;\r\n        return {\r\n            resource: resource,\r\n            owner: owner,\r\n            code: code,\r\n            severity: severity,\r\n            message: message,\r\n            source: source,\r\n            startLineNumber: startLineNumber,\r\n            startColumn: startColumn,\r\n            endLineNumber: endLineNumber,\r\n            endColumn: endColumn,\r\n            relatedInformation: relatedInformation,\r\n            tags: tags,\r\n        };\r\n    };\r\n    MarkerService.prototype.read = function (filter) {\r\n        if (filter === void 0) { filter = Object.create(null); }\r\n        var owner = filter.owner, resource = filter.resource, severities = filter.severities, take = filter.take;\r\n        if (!take || take < 0) {\r\n            take = -1;\r\n        }\r\n        if (owner && resource) {\r\n            // exactly one owner AND resource\r\n            var data = MapMap.get(this._byResource, resource.toString(), owner);\r\n            if (!data) {\r\n                return [];\r\n            }\r\n            else {\r\n                var result = [];\r\n                for (var _i = 0, data_1 = data; _i < data_1.length; _i++) {\r\n                    var marker = data_1[_i];\r\n                    if (MarkerService._accept(marker, severities)) {\r\n                        var newLen = result.push(marker);\r\n                        if (take > 0 && newLen === take) {\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                return result;\r\n            }\r\n        }\r\n        else if (!owner && !resource) {\r\n            // all\r\n            var result = [];\r\n            for (var key1 in this._byResource) {\r\n                for (var key2 in this._byResource[key1]) {\r\n                    for (var _a = 0, _b = this._byResource[key1][key2]; _a < _b.length; _a++) {\r\n                        var data = _b[_a];\r\n                        if (MarkerService._accept(data, severities)) {\r\n                            var newLen = result.push(data);\r\n                            if (take > 0 && newLen === take) {\r\n                                return result;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return result;\r\n        }\r\n        else {\r\n            // of one resource OR owner\r\n            var map = owner\r\n                ? this._byOwner[owner]\r\n                : resource ? this._byResource[resource.toString()] : undefined;\r\n            if (!map) {\r\n                return [];\r\n            }\r\n            var result = [];\r\n            for (var key in map) {\r\n                for (var _c = 0, _d = map[key]; _c < _d.length; _c++) {\r\n                    var data = _d[_c];\r\n                    if (MarkerService._accept(data, severities)) {\r\n                        var newLen = result.push(data);\r\n                        if (take > 0 && newLen === take) {\r\n                            return result;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return result;\r\n        }\r\n    };\r\n    MarkerService._accept = function (marker, severities) {\r\n        return severities === undefined || (severities & marker.severity) === marker.severity;\r\n    };\r\n    MarkerService._debouncer = function (last, event) {\r\n        if (!last) {\r\n            MarkerService._dedupeMap = Object.create(null);\r\n            last = [];\r\n        }\r\n        for (var _i = 0, event_1 = event; _i < event_1.length; _i++) {\r\n            var uri = event_1[_i];\r\n            if (MarkerService._dedupeMap[uri.toString()] === undefined) {\r\n                MarkerService._dedupeMap[uri.toString()] = true;\r\n                last.push(uri);\r\n            }\r\n        }\r\n        return last;\r\n    };\r\n    return MarkerService;\r\n}());\r\nexport { MarkerService };\r\n"]},"metadata":{},"sourceType":"module"}